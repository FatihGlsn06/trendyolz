<!DOCTYPE html>
<!-- Trendyol Pro Studio v19.0 - SEO PRO+ Edition -->
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trendyol Pro Studio v19.0 - SEO PRO+</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <style>
        :root {
            --primary: #f27a1a;
            --primary-dark: #d96a10;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #0f172a;
            --darker: #020617;
        }
        * { font-family: 'Inter', sans-serif; }
        body {
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 50%, #1e1b4b 100%);
            min-height: 100vh;
        }

        .glass {
            background: rgba(255,255,255,0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.08);
        }

        .glow { box-shadow: 0 0 60px rgba(242,122,26,0.2); }
        .glow-success { box-shadow: 0 0 40px rgba(16,185,129,0.3); }
        .glow-purple { box-shadow: 0 0 40px rgba(168,85,247,0.3); }

        .gradient-text {
            background: linear-gradient(135deg, #f27a1a, #fbbf24);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .loader {
            width: 48px; height: 48px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .tab-btn { transition: all 0.2s ease; }
        .tab-btn.active {
            background: linear-gradient(135deg, var(--primary), #fbbf24);
            color: white;
        }

        .model-card { transition: all 0.2s ease; cursor: pointer; }
        .model-card:hover { transform: translateY(-2px); border-color: rgba(168,85,247,0.5); }
        .model-card.selected {
            border-color: #a855f7 !important;
            background: rgba(168,85,247,0.15) !important;
            box-shadow: 0 0 20px rgba(168,85,247,0.3);
        }
        .jewelry-cat-btn.active {
            background: linear-gradient(135deg, #9333ea, #7c3aed);
            color: white;
        }
        .style-card { transition: all 0.2s ease; cursor: pointer; }
        .style-card:hover { transform: scale(1.02); }
        .style-card.selected, .pose-card.selected {
            border-color: var(--primary) !important;
            box-shadow: 0 0 15px rgba(242,122,26,0.3);
        }
        .outfit-card { transition: all 0.2s ease; }
        .outfit-card:hover { transform: scale(1.02); border-color: rgba(236,72,153,0.5); }
        .outfit-card.selected {
            border-color: #ec4899 !important;
            background: rgba(236,72,153,0.1);
            box-shadow: 0 0 10px rgba(236,72,153,0.3);
        }
        .scene-card { transition: all 0.2s ease; }
        .scene-card:hover { transform: scale(1.02); border-color: rgba(236,72,153,0.5); }
        .scene-card.selected {
            border-color: #ec4899 !important;
            background: rgba(236,72,153,0.1);
            box-shadow: 0 0 10px rgba(236,72,153,0.3);
        }

        .gallery-slot {
            aspect-ratio: 1;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .gallery-slot:hover { border-color: rgba(242,122,26,0.5); }
        .gallery-slot.active { border-color: var(--primary); box-shadow: 0 0 15px rgba(242,122,26,0.3); }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 10px;
            font-weight: 500;
        }
        .status-badge.active { background: rgba(16,185,129,0.2); color: #10b981; }
        .status-badge.inactive { background: rgba(148,163,184,0.2); color: #94a3b8; }

        input[type="range"] {
            -webkit-appearance: none;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            height: 6px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px; height: 18px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
        }

        .accordion-header {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .accordion-header:hover {
            background: rgba(255,255,255,0.05);
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .accordion-content.open {
            max-height: 2000px;
        }
        .accordion-icon {
            transition: transform 0.3s ease;
        }
        .accordion-header.open .accordion-icon {
            transform: rotate(180deg);
        }

        .cropper-container { max-height: 400px; }
    </style>
</head>
<body class="text-white">

    <!-- Header -->
    <header class="border-b border-white/10">
        <div class="max-w-7xl mx-auto px-3 sm:px-4 md:px-6 py-3 sm:py-4 flex items-center justify-between">
            <div class="flex items-center gap-2 sm:gap-3">
                <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-xl bg-gradient-to-br from-orange-500 to-amber-500 flex items-center justify-center">
                    <i class="fa-solid fa-camera-retro text-sm sm:text-lg"></i>
                </div>
                <div>
                    <h1 class="font-bold text-sm sm:text-lg">Trendyol Pro Studio</h1>
                    <p class="text-[9px] sm:text-[10px] text-slate-400">v19.0 SEO PRO+ Edition</p>
                </div>
            </div>

            <div class="flex items-center gap-2 sm:gap-4">
                <div class="hidden sm:flex items-center gap-2 px-3 py-1.5 rounded-lg bg-slate-800/50">
                    <div id="apiDot" class="w-2 h-2 rounded-full bg-red-500"></div>
                    <span id="apiStatus" class="text-xs text-slate-400">API Bağlantısı Yok</span>
                </div>
                <div class="sm:hidden flex items-center">
                    <div id="apiDotMobile" class="w-2 h-2 rounded-full bg-red-500"></div>
                </div>
                <button onclick="openSettings()" class="p-1.5 sm:p-2 rounded-lg hover:bg-white/5 transition-colors">
                    <i class="fa-solid fa-cog text-slate-400"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Tab Navigation -->
    <div class="max-w-7xl mx-auto px-3 sm:px-4 md:px-6 py-3 sm:py-4">
        <div class="flex gap-1 sm:gap-2 bg-slate-800/30 p-1 rounded-xl w-fit">
            <button onclick="switchTab('studio')" class="tab-btn active px-3 sm:px-4 py-1.5 sm:py-2 rounded-lg text-xs sm:text-sm font-medium">
                <i class="fa-solid fa-wand-magic-sparkles mr-1 sm:mr-2"></i>AI Stüdyo
            </button>
            <button onclick="switchTab('gallery')" class="tab-btn px-3 sm:px-4 py-1.5 sm:py-2 rounded-lg text-xs sm:text-sm font-medium text-slate-400 hover:text-white">
                <i class="fa-solid fa-images mr-1 sm:mr-2"></i>Galeri
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-3 sm:px-4 md:px-6 pb-8 md:pb-12">

        <!-- AI Studio Tab -->
        <section id="studioTab">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 md:gap-6">

                <!-- Left Panel: Upload & Settings -->
                <div class="lg:col-span-5 xl:col-span-4 space-y-3">

                    <!-- ====== ANA KONTROLLER (Her Zaman Görünür) ====== -->
                    <div class="glass rounded-2xl p-4">
                        <!-- Başlık -->
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-2">
                                <i class="fa-solid fa-wand-magic-sparkles text-orange-400"></i>
                                <span class="text-sm font-medium">Stüdyo Pro</span>
                            </div>
                            <span class="text-xs text-slate-500">Halüsinasyonsuz AI</span>
                        </div>

                        <!-- Upload Area Kompakt -->
                        <div id="dropZone" onclick="document.getElementById('fileInput').click()"
                             class="border-2 border-dashed border-slate-600 rounded-xl p-4 text-center cursor-pointer hover:border-orange-500/50 hover:bg-orange-500/5 transition-all">
                            <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleUpload(event)">
                            <div id="uploadPrompt" class="flex items-center justify-center gap-3">
                                <i class="fa-solid fa-cloud-arrow-up text-2xl text-slate-500"></i>
                                <div class="text-left">
                                    <p class="text-sm font-medium">Ürün Yükle</p>
                                    <p class="text-[10px] text-slate-500">PNG, JPG, WEBP</p>
                                </div>
                            </div>
                            <div id="uploadPreviewContainer" class="hidden">
                                <img id="uploadPreview" class="max-h-32 mx-auto rounded-lg">
                                <p id="fileName" class="mt-2 text-[10px] text-slate-400"></p>
                            </div>
                        </div>

                        <!-- Generate Buttons -->
                        <div class="flex gap-2 mt-4">
                            <button onclick="previewJewelryPlacement()" id="previewBtn" class="flex-1 py-2.5 rounded-xl bg-slate-700 hover:bg-slate-600 font-medium transition-all text-sm">
                                <i class="fa-solid fa-eye mr-1"></i>Önizle
                            </button>
                            <button onclick="generateImage()" id="generateBtn" class="flex-[2] py-2.5 rounded-xl bg-gradient-to-r from-purple-600 to-pink-500 hover:from-purple-700 hover:to-pink-600 font-bold transition-all glow-purple">
                                <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>Oluştur
                            </button>
                        </div>
                    </div>

                    <!-- ====== ACCORDION AYARLAR ====== -->
                    <div class="space-y-2">

                        <!-- Accordion 1: Model & Stil -->
                        <div class="glass rounded-xl overflow-hidden">
                            <div class="accordion-header p-3 flex items-center justify-between" onclick="toggleAccordion(this)">
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid fa-user text-purple-400"></i>
                                    <span class="font-medium text-sm">Model & Stil</span>
                                    <span class="text-[9px] bg-purple-500/20 text-purple-300 px-2 py-0.5 rounded-full">AI</span>
                                </div>
                                <i class="fa-solid fa-chevron-down accordion-icon text-slate-400 text-xs"></i>
                            </div>
                            <div class="accordion-content">
                                <div class="p-4 pt-0 space-y-4">
                                    <!-- Takı Kategorisi -->
                                    <div>
                                        <label class="text-[10px] text-slate-400 mb-2 block">Takı Tipi</label>
                                        <div class="flex gap-1 bg-slate-800/50 p-1 rounded-lg">
                                            <button onclick="selectJewelryCategory('general')" class="jewelry-cat-btn active flex-1 py-1.5 px-2 rounded-md text-[10px] font-medium transition-all" data-cat="general">Genel</button>
                                            <button onclick="selectJewelryCategory('minimal')" class="jewelry-cat-btn flex-1 py-1.5 px-2 rounded-md text-[10px] font-medium text-slate-400 transition-all" data-cat="minimal">Minimal</button>
                                            <button onclick="selectJewelryCategory('statement')" class="jewelry-cat-btn flex-1 py-1.5 px-2 rounded-md text-[10px] font-medium text-slate-400 transition-all" data-cat="statement">Statement</button>
                                            <button onclick="selectJewelryCategory('pearl')" class="jewelry-cat-btn flex-1 py-1.5 px-2 rounded-md text-[10px] font-medium text-slate-400 transition-all" data-cat="pearl">İnci</button>
                                        </div>
                                    </div>

                                    <!-- Model Profilleri -->
                                    <div>
                                        <label class="text-[10px] text-slate-400 mb-2 block">Model Profili</label>
                                        <div class="grid grid-cols-4 gap-1.5" id="modelProfilesContainer">
                                            <div onclick="selectModelProfile('neck_model')" class="model-card selected p-2 rounded-lg border border-slate-700 text-center cursor-pointer" data-model="neck_model" data-category="general">
                                                <i class="fa-solid fa-circle-user text-rose-400 text-sm mb-1"></i>
                                                <p class="text-[9px]">Kolye</p>
                                            </div>
                                            <div onclick="selectModelProfile('hand_model')" class="model-card p-2 rounded-lg border border-slate-700 text-center cursor-pointer" data-model="hand_model" data-category="general">
                                                <i class="fa-solid fa-hand text-amber-400 text-sm mb-1"></i>
                                                <p class="text-[9px]">El</p>
                                            </div>
                                            <div onclick="selectModelProfile('set_model')" class="model-card p-2 rounded-lg border border-slate-700 text-center cursor-pointer" data-model="set_model" data-category="general">
                                                <i class="fa-solid fa-users text-violet-400 text-sm mb-1"></i>
                                                <p class="text-[9px]">Set</p>
                                            </div>
                                            <div onclick="selectModelProfile('boho_model')" class="model-card p-2 rounded-lg border border-slate-700 text-center cursor-pointer" data-model="boho_model" data-category="general">
                                                <i class="fa-solid fa-sun text-orange-400 text-sm mb-1"></i>
                                                <p class="text-[9px]">Bohem</p>
                                            </div>
                                            <!-- Minimal -->
                                            <div onclick="selectModelProfile('minimal_neck')" class="model-card hidden p-2 rounded-lg border border-slate-700 text-center cursor-pointer" data-model="minimal_neck" data-category="minimal">
                                                <i class="fa-solid fa-minus text-sky-400 text-sm mb-1"></i>
                                                <p class="text-[9px]">Kolye</p>
                                            </div>
                                            <div onclick="selectModelProfile('minimal_hand')" class="model-card hidden p-2 rounded-lg border border-slate-700 text-center cursor-pointer" data-model="minimal_hand" data-category="minimal">
                                                <i class="fa-solid fa-ring text-sky-400 text-sm mb-1"></i>
                                                <p class="text-[9px]">Yüzük</p>
                                            </div>
                                            <!-- Statement -->
                                            <div onclick="selectModelProfile('statement_neck')" class="model-card hidden p-2 rounded-lg border border-slate-700 text-center cursor-pointer" data-model="statement_neck" data-category="statement">
                                                <i class="fa-solid fa-gem text-fuchsia-400 text-sm mb-1"></i>
                                                <p class="text-[9px]">Kolye</p>
                                            </div>
                                            <div onclick="selectModelProfile('statement_ear')" class="model-card hidden p-2 rounded-lg border border-slate-700 text-center cursor-pointer" data-model="statement_ear" data-category="statement">
                                                <i class="fa-solid fa-star text-fuchsia-400 text-sm mb-1"></i>
                                                <p class="text-[9px]">Küpe</p>
                                            </div>
                                            <!-- Pearl -->
                                            <div onclick="selectModelProfile('pearl_neck')" class="model-card hidden p-2 rounded-lg border border-slate-700 text-center cursor-pointer" data-model="pearl_neck" data-category="pearl">
                                                <i class="fa-solid fa-circle text-slate-300 text-sm mb-1"></i>
                                                <p class="text-[9px]">İnci Kolye</p>
                                            </div>
                                            <div onclick="selectModelProfile('pearl_ear')" class="model-card hidden p-2 rounded-lg border border-slate-700 text-center cursor-pointer" data-model="pearl_ear" data-category="pearl">
                                                <i class="fa-solid fa-circle text-slate-300 text-sm mb-1"></i>
                                                <p class="text-[9px]">İnci Küpe</p>
                                            </div>
                                        </div>
                                        <p id="categoryDesc" class="text-[9px] text-slate-500 mt-1">Standart takı çekimleri için genel modeller</p>
                                    </div>

                                    <!-- Stil Presetleri -->
                                    <div>
                                        <label class="text-[10px] text-slate-400 mb-2 block">Çekim Stili</label>
                                        <div class="grid grid-cols-3 gap-1.5" id="stylePresets">
                                            <div onclick="selectStyle('studio')" class="style-card selected p-2 rounded-lg border border-slate-700 text-center" data-style="studio">
                                                <div class="w-full h-6 bg-gradient-to-b from-gray-100 to-gray-200 rounded mb-1"></div>
                                                <p class="text-[9px]">Studio</p>
                                            </div>
                                            <div onclick="selectStyle('boho')" class="style-card p-2 rounded-lg border border-slate-700 text-center" data-style="boho">
                                                <div class="w-full h-6 bg-gradient-to-br from-amber-100 to-orange-200 rounded mb-1"></div>
                                                <p class="text-[9px]">Boho</p>
                                            </div>
                                            <div onclick="selectStyle('luxury')" class="style-card p-2 rounded-lg border border-slate-700 text-center" data-style="luxury">
                                                <div class="w-full h-6 bg-gradient-to-br from-slate-900 to-slate-700 rounded mb-1"></div>
                                                <p class="text-[9px]">Luxury</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Poz Seçimi -->
                                    <div>
                                        <label class="text-[10px] text-slate-400 mb-2 block">Poz / Açı</label>
                                        <div class="grid grid-cols-6 gap-1" id="posePresets">
                                            <div onclick="selectPose('front')" class="pose-card selected p-1.5 rounded-lg border border-slate-700 text-center cursor-pointer" data-pose="front">
                                                <i class="fa-solid fa-user text-xs text-slate-400"></i>
                                            </div>
                                            <div onclick="selectPose('right')" class="pose-card p-1.5 rounded-lg border border-slate-700 text-center cursor-pointer" data-pose="right">
                                                <i class="fa-solid fa-arrow-right text-xs text-slate-400"></i>
                                            </div>
                                            <div onclick="selectPose('left')" class="pose-card p-1.5 rounded-lg border border-slate-700 text-center cursor-pointer" data-pose="left">
                                                <i class="fa-solid fa-arrow-left text-xs text-slate-400"></i>
                                            </div>
                                            <div onclick="selectPose('down')" class="pose-card p-1.5 rounded-lg border border-slate-700 text-center cursor-pointer" data-pose="down">
                                                <i class="fa-solid fa-arrow-down text-xs text-slate-400"></i>
                                            </div>
                                            <div onclick="selectPose('closeup')" class="pose-card p-1.5 rounded-lg border border-slate-700 text-center cursor-pointer" data-pose="closeup">
                                                <i class="fa-solid fa-magnifying-glass-plus text-xs text-slate-400"></i>
                                            </div>
                                            <div onclick="selectPose('surface')" class="pose-card p-1.5 rounded-lg border border-slate-700 text-center cursor-pointer" data-pose="surface">
                                                <i class="fa-solid fa-square text-xs text-slate-400"></i>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="modelProfileInfo" class="p-2 bg-purple-500/10 border border-purple-500/20 rounded-lg">
                                        <p class="text-[9px] text-purple-300" id="modelProfileDesc">
                                            <i class="fa-solid fa-info-circle mr-1"></i>
                                            Kolye Odaklı: Gerçekçi cilt dokusu, doğal kusurlar.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Accordion 2: Kıyafet & Sahne -->
                        <div class="glass rounded-xl overflow-hidden">
                            <div class="accordion-header p-3 flex items-center justify-between" onclick="toggleAccordion(this)">
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid fa-shirt text-pink-400"></i>
                                    <span class="font-medium text-sm">Kıyafet & Sahne</span>
                                </div>
                                <i class="fa-solid fa-chevron-down accordion-icon text-slate-400 text-xs"></i>
                            </div>
                            <div class="accordion-content">
                                <div class="p-4 pt-0 space-y-3">
                                    <!-- Auto Toggle -->
                                    <div class="flex items-center justify-between p-2 bg-slate-800/50 rounded-lg">
                                        <span class="text-[10px] text-slate-300">
                                            <i class="fa-solid fa-robot mr-1 text-pink-400"></i>AI Otomatik
                                        </span>
                                        <button onclick="toggleAutoOutfit()" id="autoOutfitBtn" class="w-9 h-5 rounded-full bg-slate-600 relative transition-all">
                                            <div id="autoOutfitDot" class="w-4 h-4 rounded-full bg-slate-400 absolute top-0.5 left-0.5 transition-all"></div>
                                        </button>
                                    </div>

                                    <div id="manualOutfitSection">
                                        <!-- Kıyafet -->
                                        <div class="mb-3">
                                            <label class="text-[10px] text-slate-400 mb-1.5 block">Kıyafet</label>
                                            <div class="grid grid-cols-4 gap-1" id="outfitPresets">
                                                <div onclick="selectOutfit('black_vneck')" class="outfit-card selected p-1.5 rounded-lg border border-slate-700 text-center cursor-pointer" data-outfit="black_vneck">
                                                    <div class="w-full h-5 bg-gradient-to-b from-slate-900 to-black rounded mb-0.5"></div>
                                                    <p class="text-[8px]">Siyah</p>
                                                </div>
                                                <div onclick="selectOutfit('white_off')" class="outfit-card p-1.5 rounded-lg border border-slate-700 text-center cursor-pointer" data-outfit="white_off">
                                                    <div class="w-full h-5 bg-gradient-to-b from-white to-slate-100 rounded mb-0.5"></div>
                                                    <p class="text-[8px]">Beyaz</p>
                                                </div>
                                                <div onclick="selectOutfit('cream_silk')" class="outfit-card p-1.5 rounded-lg border border-slate-700 text-center cursor-pointer" data-outfit="cream_silk">
                                                    <div class="w-full h-5 bg-gradient-to-b from-amber-50 to-amber-100 rounded mb-0.5"></div>
                                                    <p class="text-[8px]">Krem</p>
                                                </div>
                                                <div onclick="selectOutfit('burgundy')" class="outfit-card p-1.5 rounded-lg border border-slate-700 text-center cursor-pointer" data-outfit="burgundy">
                                                    <div class="w-full h-5 bg-gradient-to-b from-rose-900 to-rose-950 rounded mb-0.5"></div>
                                                    <p class="text-[8px]">Bordo</p>
                                                </div>
                                                <div onclick="selectOutfit('navy')" class="outfit-card p-1.5 rounded-lg border border-slate-700 text-center cursor-pointer" data-outfit="navy">
                                                    <div class="w-full h-5 bg-gradient-to-b from-blue-900 to-blue-950 rounded mb-0.5"></div>
                                                    <p class="text-[8px]">Lacivert</p>
                                                </div>
                                                <div onclick="selectOutfit('nude')" class="outfit-card p-1.5 rounded-lg border border-slate-700 text-center cursor-pointer" data-outfit="nude">
                                                    <div class="w-full h-5 bg-gradient-to-b from-orange-100 to-orange-200 rounded mb-0.5"></div>
                                                    <p class="text-[8px]">Ten</p>
                                                </div>
                                                <div onclick="selectOutfit('forest')" class="outfit-card p-1.5 rounded-lg border border-slate-700 text-center cursor-pointer" data-outfit="forest">
                                                    <div class="w-full h-5 bg-gradient-to-b from-emerald-800 to-emerald-900 rounded mb-0.5"></div>
                                                    <p class="text-[8px]">Yeşil</p>
                                                </div>
                                                <div onclick="selectOutfit('none')" class="outfit-card p-1.5 rounded-lg border border-slate-700 text-center cursor-pointer" data-outfit="none">
                                                    <div class="w-full h-5 bg-gradient-to-b from-rose-200 to-rose-300 rounded mb-0.5 flex items-center justify-center">
                                                        <i class="fa-solid fa-xmark text-rose-600 text-[8px]"></i>
                                                    </div>
                                                    <p class="text-[8px]">Yok</p>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Sahne -->
                                        <div>
                                            <label class="text-[10px] text-slate-400 mb-1.5 block">Sahne</label>
                                            <div class="grid grid-cols-4 gap-1" id="scenePresets">
                                                <div onclick="selectScene('studio_clean')" class="scene-card selected p-1.5 rounded-lg border border-slate-700 text-center cursor-pointer" data-scene="studio_clean">
                                                    <i class="fa-solid fa-lightbulb text-slate-400 text-[10px]"></i>
                                                    <p class="text-[8px]">Stüdyo</p>
                                                </div>
                                                <div onclick="selectScene('romantic')" class="scene-card p-1.5 rounded-lg border border-slate-700 text-center cursor-pointer" data-scene="romantic">
                                                    <i class="fa-solid fa-heart text-pink-400 text-[10px]"></i>
                                                    <p class="text-[8px]">Romantik</p>
                                                </div>
                                                <div onclick="selectScene('luxury_dark')" class="scene-card p-1.5 rounded-lg border border-slate-700 text-center cursor-pointer" data-scene="luxury_dark">
                                                    <i class="fa-solid fa-gem text-purple-400 text-[10px]"></i>
                                                    <p class="text-[8px]">Lüks</p>
                                                </div>
                                                <div onclick="selectScene('golden_hour')" class="scene-card p-1.5 rounded-lg border border-slate-700 text-center cursor-pointer" data-scene="golden_hour">
                                                    <i class="fa-solid fa-sun text-amber-400 text-[10px]"></i>
                                                    <p class="text-[8px]">Golden</p>
                                                </div>
                                                <div onclick="selectScene('minimalist')" class="scene-card p-1.5 rounded-lg border border-slate-700 text-center cursor-pointer" data-scene="minimalist">
                                                    <i class="fa-solid fa-minus text-slate-400 text-[10px]"></i>
                                                    <p class="text-[8px]">Minimal</p>
                                                </div>
                                                <div onclick="selectScene('editorial')" class="scene-card p-1.5 rounded-lg border border-slate-700 text-center cursor-pointer" data-scene="editorial">
                                                    <i class="fa-solid fa-camera text-blue-400 text-[10px]"></i>
                                                    <p class="text-[8px]">Editorial</p>
                                                </div>
                                                <div onclick="selectScene('nature')" class="scene-card p-1.5 rounded-lg border border-slate-700 text-center cursor-pointer" data-scene="nature">
                                                    <i class="fa-solid fa-leaf text-green-400 text-[10px]"></i>
                                                    <p class="text-[8px]">Doğal</p>
                                                </div>
                                                <div onclick="selectScene('festive')" class="scene-card p-1.5 rounded-lg border border-slate-700 text-center cursor-pointer" data-scene="festive">
                                                    <i class="fa-solid fa-sparkles text-yellow-400 text-[10px]"></i>
                                                    <p class="text-[8px]">Gece</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="autoOutfitResult" class="hidden">
                                        <div class="p-2 bg-pink-500/10 border border-pink-500/20 rounded-lg">
                                            <p class="text-[9px] text-pink-300">
                                                <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>
                                                AI takıyı analiz edip en uygun kombinasyonu seçecek
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Accordion 3: Model Şablonu -->
                        <div class="glass rounded-xl overflow-hidden">
                            <div class="accordion-header p-3 flex items-center justify-between" onclick="toggleAccordion(this)">
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid fa-user-plus text-cyan-400"></i>
                                    <span class="font-medium text-sm">Model Şablonu</span>
                                    <span class="text-[9px] text-slate-500">Opsiyonel</span>
                                </div>
                                <i class="fa-solid fa-chevron-down accordion-icon text-slate-400 text-xs"></i>
                            </div>
                            <div class="accordion-content">
                                <div class="p-4 pt-0 space-y-3">
                                    <div id="templateDropZone" class="border-2 border-dashed border-slate-600 rounded-lg p-3 text-center hover:border-cyan-500 transition-colors cursor-pointer">
                                        <input type="file" id="templateInput" class="hidden" accept="image/*">
                                        <div id="templatePlaceholder" class="flex items-center justify-center gap-2">
                                            <i class="fa-solid fa-image text-xl text-slate-500"></i>
                                            <div class="text-left">
                                                <p class="text-xs text-slate-400">Model şablonu yükle</p>
                                                <p class="text-[9px] text-slate-500">Takısız boyun fotoğrafı</p>
                                            </div>
                                        </div>
                                        <div id="templatePreview" class="hidden">
                                            <img id="templateImage" class="max-h-20 mx-auto rounded-lg">
                                            <p id="templateName" class="text-[10px] text-cyan-400 mt-1"></p>
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-2 gap-2">
                                        <div>
                                            <label class="text-[9px] text-slate-500 flex justify-between">
                                                <span>Dikey (Y)</span><span id="yOffsetValue" class="text-cyan-400">50%</span>
                                            </label>
                                            <input type="range" id="yOffsetSlider" min="20" max="80" value="50" class="w-full" onchange="updatePositionValue('y')">
                                        </div>
                                        <div>
                                            <label class="text-[9px] text-slate-500 flex justify-between">
                                                <span>Yatay (X)</span><span id="xOffsetValue" class="text-cyan-400">50%</span>
                                            </label>
                                            <input type="range" id="xOffsetSlider" min="20" max="80" value="50" class="w-full" onchange="updatePositionValue('x')">
                                        </div>
                                        <div>
                                            <label class="text-[9px] text-slate-500 flex justify-between">
                                                <span>Boyut</span><span id="scaleValue" class="text-cyan-400">60%</span>
                                            </label>
                                            <input type="range" id="scaleSlider" min="20" max="100" value="60" class="w-full" onchange="updatePositionValue('scale')">
                                        </div>
                                        <div>
                                            <label class="text-[9px] text-slate-500 flex justify-between">
                                                <span>Döndür</span><span id="rotationValue" class="text-purple-400">0°</span>
                                            </label>
                                            <input type="range" id="rotationSlider" min="-180" max="180" value="0" class="w-full" onchange="updatePositionValue('rotation')">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Accordion 4: Akıllı Prompt -->
                        <div class="glass rounded-xl overflow-hidden">
                            <div class="accordion-header open p-3 flex items-center justify-between" onclick="toggleAccordion(this)">
                                <div class="flex items-center gap-2">
                                    <i class="fa-solid fa-brain text-indigo-400"></i>
                                    <span class="font-medium text-sm">Akıllı Prompt</span>
                                    <span class="text-[9px] bg-indigo-500/20 text-indigo-300 px-2 py-0.5 rounded-full">AI</span>
                                </div>
                                <i class="fa-solid fa-chevron-down accordion-icon text-slate-400 text-xs"></i>
                            </div>
                            <div class="accordion-content open">
                                <div class="p-4 pt-0">
                                    <textarea id="smartPromptInput"
                                        placeholder="Örnek: kıyafet mor olsun, yakın çekim, sarışın model..."
                                        class="w-full bg-slate-800/50 border border-slate-600 rounded-lg p-2 text-sm placeholder-slate-500 focus:border-indigo-500 focus:outline-none resize-none"
                                        rows="2"></textarea>

                                    <div class="flex flex-wrap gap-1 mt-2">
                                        <button onclick="addSmartPrompt('yakın çekim')" class="px-2 py-1 text-[9px] bg-slate-700/50 hover:bg-indigo-500/30 rounded-md transition-all">Yakın</button>
                                        <button onclick="addSmartPrompt('uzak çekim')" class="px-2 py-1 text-[9px] bg-slate-700/50 hover:bg-indigo-500/30 rounded-md transition-all">Uzak</button>
                                        <button onclick="addSmartPrompt('sağdan çekim')" class="px-2 py-1 text-[9px] bg-slate-700/50 hover:bg-indigo-500/30 rounded-md transition-all">Sağ</button>
                                        <button onclick="addSmartPrompt('soldan çekim')" class="px-2 py-1 text-[9px] bg-slate-700/50 hover:bg-indigo-500/30 rounded-md transition-all">Sol</button>
                                        <button onclick="addSmartPrompt('kıyafet siyah')" class="px-2 py-1 text-[9px] bg-slate-700/50 hover:bg-indigo-500/30 rounded-md transition-all">Siyah</button>
                                        <button onclick="addSmartPrompt('altın saat ışığı')" class="px-2 py-1 text-[9px] bg-slate-700/50 hover:bg-indigo-500/30 rounded-md transition-all">Golden</button>
                                        <button onclick="addSmartPrompt('karanlık stüdyo')" class="px-2 py-1 text-[9px] bg-slate-700/50 hover:bg-indigo-500/30 rounded-md transition-all">Dark</button>
                                    </div>

                                    <p class="text-[9px] text-indigo-400 mt-2">
                                        <i class="fa-solid fa-arrow-up mr-1"></i>
                                        Yazdıktan sonra yukarıdaki <strong>"Oluştur"</strong> butonuna tıklayın
                                    </p>
                                    <p class="text-[8px] text-slate-500 mt-1">
                                        <i class="fa-solid fa-shield-check text-green-400 mr-1"></i>
                                        Ürün asla değişmez - sadece model, kıyafet, sahne değişir
                                    </p>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Right Panel: Preview & SEO -->
                <div class="lg:col-span-7 xl:col-span-8 space-y-3 md:space-y-4">

                    <!-- Preview + SEO Grid -->
                    <div class="grid grid-cols-1 2xl:grid-cols-2 gap-3 md:gap-4">

                        <!-- Preview Column -->
                        <div class="space-y-4">
                            <!-- Main Preview -->
                            <div class="glass rounded-2xl p-4 md:p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold flex items-center gap-2">
                                <i class="fa-solid fa-eye text-slate-400"></i>
                                Önizleme
                            </h3>
                            <div class="flex items-center gap-2">
                                <span id="engineBadge" class="text-[10px] px-2 py-1 bg-blue-500/20 text-blue-400 rounded-full">
                                    <i class="fa-solid fa-magic-wand-sparkles mr-1"></i>Inpaint
                                </span>
                            </div>
                        </div>

                        <div id="previewArea" class="relative rounded-xl overflow-hidden min-h-[280px] sm:min-h-[350px] md:min-h-[400px] bg-slate-800/50 flex items-center justify-center">
                            <!-- Loading Overlay -->
                            <div id="previewLoader" class="hidden absolute inset-0 bg-black/70 flex flex-col items-center justify-center z-10">
                                <div class="loader mb-4"></div>
                                <p id="loaderText" class="text-sm text-slate-300">İşleniyor...</p>
                                <p id="loaderSubtext" class="text-xs text-slate-500 mt-1">Lütfen bekleyin</p>
                            </div>

                            <!-- Interactive Canvas Preview (Şablon + Takı) -->
                            <canvas id="interactiveCanvas" class="hidden max-w-full max-h-[300px] sm:max-h-[400px] md:max-h-[500px] rounded-lg shadow-2xl cursor-move"></canvas>

                            <!-- Preview Image (Sonuç) -->
                            <div id="previewPlaceholder" class="text-center text-slate-500">
                                <i class="fa-solid fa-image text-4xl mb-3"></i>
                                <p class="text-sm">Ürün yükleyin ve AI görsel oluşturun</p>
                            </div>
                            <img id="previewImage" class="hidden max-w-full max-h-[300px] sm:max-h-[400px] md:max-h-[500px] rounded-lg shadow-2xl">

                            <!-- Interactive Position Controls (Şablon modunda görünür) -->
                            <div id="positionControls" class="hidden absolute inset-0 pointer-events-none">
                                <!-- Yukarı -->
                                <button onclick="moveJewelry('up')" class="pointer-events-auto absolute top-2 left-1/2 -translate-x-1/2 w-10 h-10 rounded-full bg-black/50 hover:bg-purple-600 border border-white/30 flex items-center justify-center transition-colors">
                                    <i class="fa-solid fa-arrow-up"></i>
                                </button>
                                <!-- Aşağı -->
                                <button onclick="moveJewelry('down')" class="pointer-events-auto absolute bottom-2 left-1/2 -translate-x-1/2 w-10 h-10 rounded-full bg-black/50 hover:bg-purple-600 border border-white/30 flex items-center justify-center transition-colors">
                                    <i class="fa-solid fa-arrow-down"></i>
                                </button>
                                <!-- Sol -->
                                <button onclick="moveJewelry('left')" class="pointer-events-auto absolute left-2 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full bg-black/50 hover:bg-purple-600 border border-white/30 flex items-center justify-center transition-colors">
                                    <i class="fa-solid fa-arrow-left"></i>
                                </button>
                                <!-- Sağ -->
                                <button onclick="moveJewelry('right')" class="pointer-events-auto absolute right-2 top-1/2 -translate-y-1/2 w-10 h-10 rounded-full bg-black/50 hover:bg-purple-600 border border-white/30 flex items-center justify-center transition-colors">
                                    <i class="fa-solid fa-arrow-right"></i>
                                </button>
                                <!-- Döndürme Kontrolleri -->
                                <div class="pointer-events-auto absolute bottom-2 right-2 flex gap-1">
                                    <button onclick="rotateJewelry(-15)" class="w-8 h-8 rounded-full bg-black/50 hover:bg-purple-600 border border-white/30 flex items-center justify-center text-xs transition-colors" title="Sola döndür">
                                        <i class="fa-solid fa-rotate-left"></i>
                                    </button>
                                    <button onclick="rotateJewelry(15)" class="w-8 h-8 rounded-full bg-black/50 hover:bg-purple-600 border border-white/30 flex items-center justify-center text-xs transition-colors" title="Sağa döndür">
                                        <i class="fa-solid fa-rotate-right"></i>
                                    </button>
                                </div>
                                <!-- Boyut Kontrolleri -->
                                <div class="pointer-events-auto absolute bottom-2 left-2 flex gap-1">
                                    <button onclick="scaleJewelry(-5)" class="w-8 h-8 rounded-full bg-black/50 hover:bg-purple-600 border border-white/30 flex items-center justify-center text-xs transition-colors" title="Küçült">
                                        <i class="fa-solid fa-minus"></i>
                                    </button>
                                    <button onclick="scaleJewelry(5)" class="w-8 h-8 rounded-full bg-black/50 hover:bg-purple-600 border border-white/30 flex items-center justify-center text-xs transition-colors" title="Büyüt">
                                        <i class="fa-solid fa-plus"></i>
                                    </button>
                                </div>
                                <!-- Bilgi -->
                                <div class="pointer-events-auto absolute top-2 left-2 px-2 py-1 bg-black/70 rounded text-[10px] text-white/70">
                                    <i class="fa-solid fa-arrows-up-down-left-right mr-1"></i>Sürükle veya ok tuşları
                                </div>
                            </div>
                        </div>

                        <!-- Download Actions -->
                        <div id="downloadActions" class="hidden mt-3 md:mt-4 space-y-2 md:space-y-3">
                            <!-- İndirme Butonları -->
                            <div class="flex flex-wrap gap-2 md:gap-3">
                                <button onclick="downloadImage('jpeg')" class="flex-1 min-w-[80px] py-2.5 md:py-3 rounded-xl bg-green-600 hover:bg-green-500 font-semibold transition-colors text-sm md:text-base">
                                    <i class="fa-solid fa-download mr-1 md:mr-2"></i>JPEG
                                </button>
                                <button onclick="downloadImage('png')" class="flex-1 min-w-[80px] py-2.5 md:py-3 rounded-xl bg-blue-600 hover:bg-blue-500 font-semibold transition-colors text-sm md:text-base">
                                    <i class="fa-solid fa-download mr-1 md:mr-2"></i>PNG
                                </button>
                                <button onclick="addToGallery()" class="py-2.5 md:py-3 px-4 md:px-6 rounded-xl bg-purple-600 hover:bg-purple-500 font-semibold transition-colors text-sm md:text-base">
                                    <i class="fa-solid fa-plus mr-1 md:mr-2"></i>Galeriye
                                </button>
                            </div>
                        </div>

                        <!-- Manual Edit Panel -->
                        <div id="editPanel" class="hidden mt-4 p-4 bg-slate-800/50 rounded-xl border border-slate-700">
                            <h4 class="text-sm font-semibold mb-3 flex items-center gap-2">
                                <i class="fa-solid fa-sliders text-amber-400"></i>
                                Manuel Rötuş
                            </h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="text-xs text-slate-400 flex justify-between">
                                        <span>Parlaklık</span>
                                        <span id="brightnessValue" class="text-amber-400">0</span>
                                    </label>
                                    <input type="range" id="brightnessSlider" min="-50" max="50" value="0" class="w-full" onchange="applyImageAdjustments()">
                                </div>
                                <div>
                                    <label class="text-xs text-slate-400 flex justify-between">
                                        <span>Kontrast</span>
                                        <span id="contrastValue" class="text-amber-400">0</span>
                                    </label>
                                    <input type="range" id="contrastSlider" min="-50" max="50" value="0" class="w-full" onchange="applyImageAdjustments()">
                                </div>
                                <div>
                                    <label class="text-xs text-slate-400 flex justify-between">
                                        <span>Doygunluk</span>
                                        <span id="saturationValue" class="text-amber-400">0</span>
                                    </label>
                                    <input type="range" id="saturationSlider" min="-50" max="50" value="0" class="w-full" onchange="applyImageAdjustments()">
                                </div>
                                <div class="flex gap-2 pt-2">
                                    <button onclick="resetAdjustments()" class="flex-1 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-xs font-medium">
                                        <i class="fa-solid fa-rotate-left mr-1"></i>Sıfırla
                                    </button>
                                    <button onclick="applyAndSaveAdjustments()" class="flex-1 py-2 rounded-lg bg-amber-600 hover:bg-amber-500 text-xs font-medium">
                                        <i class="fa-solid fa-check mr-1"></i>Uygula
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                        </div>
                        <!-- END Preview Column -->

                        <!-- SEO Column -->
                        <div>
                            <!-- SEO Generator Panel -->
                            <div class="glass rounded-2xl p-4 md:p-5 border border-emerald-500/30 2xl:h-full">
                        <h3 class="font-semibold mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-magnifying-glass-chart text-emerald-400"></i>
                            Trendyol SEO Pro
                            <span class="text-[10px] px-2 py-0.5 bg-emerald-500/20 text-emerald-400 rounded-full ml-auto">AI Optimized</span>
                        </h3>

                        <!-- ÜRÜN ÖZELLİKLERİ - BASİTLEŞTİRİLMİŞ -->
                        <div class="mb-4 p-4 bg-slate-800/30 rounded-xl border border-slate-700">
                            <h4 class="text-xs font-semibold text-purple-400 mb-3 flex items-center gap-2">
                                <i class="fa-solid fa-gem"></i>
                                Ürün Özellikleri
                                <span class="text-[9px] text-slate-500 font-normal">(AI görseli analiz edecek)</span>
                            </h4>

                            <textarea id="seoProductFeatures" rows="3"
                                      class="w-full bg-slate-800 border border-slate-600 rounded-lg px-3 py-2 text-xs resize-none placeholder-slate-500 focus:border-purple-500 outline-none"
                                      placeholder="Teknik özellikleri yazın (Trendyol alanları için):&#10;Örnek: 925 ayar gümüş, zirkon taş, rose gold kaplama, 45+5cm zincir"></textarea>

                            <p class="text-[10px] text-slate-500 mt-2 mb-3">
                                <i class="fa-solid fa-info-circle text-blue-400 mr-1"></i>
                                Teknik bilgiler → Trendyol özellikleri | Başlık → AI arama kelimeleri oluşturur
                            </p>

                            <!-- SEO Oluştur Butonu -->
                            <button onclick="generateSEO()" class="w-full py-2.5 rounded-lg bg-gradient-to-r from-emerald-600 to-teal-500 hover:from-emerald-500 hover:to-teal-400 text-xs font-bold transition-all">
                                <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>
                                SEO İçeriği Oluştur
                            </button>
                        </div>

                        <div id="seoContent" class="space-y-3">
                            <div id="seoPlaceholder" class="text-center py-4 text-slate-500">
                                <i class="fa-solid fa-robot text-xl mb-2"></i>
                                <p class="text-xs">Görsel yükleyin, AI analiz edip SEO oluşturacak</p>
                                <p class="text-[10px] text-slate-600 mt-1">İsterseniz ürün özelliklerini de yazabilirsiniz</p>
                            </div>

                            <div id="seoResults" class="hidden space-y-4">
                                <!-- Görsel Analiz Sonuçları -->
                                <div id="visualAnalysisSection" class="p-3 bg-purple-500/10 border border-purple-500/30 rounded-lg">
                                    <label class="text-xs text-purple-400 mb-2 block font-semibold">
                                        <i class="fa-solid fa-eye mr-1"></i>AI Görsel Analizi
                                    </label>
                                    <div id="visualAnalysisContent" class="grid grid-cols-2 gap-2 text-[10px]"></div>
                                </div>

                                <!-- Barkod ve Model Kodu - Hızlı Kopyalama -->
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="p-2 bg-slate-800/50 rounded-lg border border-slate-700">
                                        <label class="text-[10px] text-slate-400 mb-1 block">
                                            <i class="fa-solid fa-barcode mr-1"></i>Barkod
                                        </label>
                                        <div class="flex items-center gap-2">
                                            <input type="text" id="seoBarcode" class="flex-1 bg-slate-900 border border-slate-600 rounded px-2 py-1 text-xs font-mono" readonly>
                                            <button onclick="copySEO('barcode')" class="p-1.5 bg-emerald-600 hover:bg-emerald-500 rounded text-xs" title="Kopyala">
                                                <i class="fa-solid fa-copy"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="p-2 bg-slate-800/50 rounded-lg border border-slate-700">
                                        <label class="text-[10px] text-slate-400 mb-1 block">
                                            <i class="fa-solid fa-tag mr-1"></i>Model Kodu
                                        </label>
                                        <div class="flex items-center gap-2">
                                            <input type="text" id="seoModelCode" class="flex-1 bg-slate-900 border border-slate-600 rounded px-2 py-1 text-xs font-mono" readonly>
                                            <button onclick="copySEO('modelCode')" class="p-1.5 bg-emerald-600 hover:bg-emerald-500 rounded text-xs" title="Kopyala">
                                                <i class="fa-solid fa-copy"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Başlık Önerileri -->
                                <div>
                                    <label class="text-xs text-slate-400 flex justify-between mb-1">
                                        <span><i class="fa-solid fa-heading mr-1"></i>Ürün Başlığı (max 99 kar.)</span>
                                        <span id="titleCharCount" class="text-emerald-400">0/99</span>
                                    </label>
                                    <input type="text" id="seoTitle" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm"
                                           oninput="updateCharCount('title')" maxlength="105">
                                    <button onclick="copySEO('title')" class="text-[10px] text-emerald-400 hover:text-emerald-300 mt-1">
                                        <i class="fa-solid fa-copy mr-1"></i>Kopyala
                                    </button>
                                </div>

                                <!-- Alternatif Başlıklar -->
                                <div>
                                    <label class="text-xs text-slate-400 mb-1 block">
                                        <i class="fa-solid fa-list mr-1"></i>Alternatif Başlıklar
                                    </label>
                                    <div id="altTitles" class="space-y-1"></div>
                                </div>

                                <!-- Kategori Önerisi -->
                                <div>
                                    <label class="text-xs text-slate-400 flex justify-between mb-1">
                                        <span><i class="fa-solid fa-folder-tree mr-1"></i>Kategori Yolu</span>
                                        <button onclick="copySEO('category')" class="text-emerald-400 hover:text-emerald-300">
                                            <i class="fa-solid fa-copy"></i>
                                        </button>
                                    </label>
                                    <input type="text" id="seoCategory" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-xs" readonly>
                                </div>

                                <!-- Teknik Açıklama -->
                                <div>
                                    <label class="text-xs text-slate-400 flex justify-between mb-1">
                                        <span><i class="fa-solid fa-align-left mr-1"></i>Teknik Açıklama</span>
                                        <span id="descCharCount" class="text-emerald-400">0/500</span>
                                    </label>
                                    <textarea id="seoDescription" rows="3" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm resize-none"
                                              oninput="updateCharCount('desc')" maxlength="500"></textarea>
                                    <button onclick="copySEO('description')" class="text-[10px] text-emerald-400 hover:text-emerald-300">
                                        <i class="fa-solid fa-copy mr-1"></i>Kopyala
                                    </button>
                                </div>

                                <!-- Hikayeleştirilmiş Açıklama -->
                                <div>
                                    <label class="text-xs text-slate-400 flex justify-between mb-1">
                                        <span><i class="fa-solid fa-heart mr-1 text-pink-400"></i>Hikayeleştirilmiş Açıklama</span>
                                        <button onclick="copySEO('story')" class="text-emerald-400 hover:text-emerald-300">
                                            <i class="fa-solid fa-copy"></i>
                                        </button>
                                    </label>
                                    <div id="seoStoryDescription" class="bg-slate-800/50 border border-pink-500/30 rounded-lg px-3 py-2 text-sm text-pink-200"></div>
                                </div>

                                <!-- Anahtar Kelimeler -->
                                <div>
                                    <label class="text-xs text-slate-400 mb-1 block">
                                        <i class="fa-solid fa-key mr-1"></i>Anahtar Kelimeler
                                    </label>
                                    <div id="seoKeywords" class="flex flex-wrap gap-1 mb-2"></div>
                                    <button onclick="copySEO('keywords')" class="text-[10px] text-emerald-400 hover:text-emerald-300">
                                        <i class="fa-solid fa-copy mr-1"></i>Tümünü Kopyala
                                    </button>
                                </div>

                                <!-- Long-tail Keywords -->
                                <div>
                                    <label class="text-xs text-slate-400 mb-1 block">
                                        <i class="fa-solid fa-magnifying-glass mr-1"></i>Long-tail Aramalar
                                    </label>
                                    <div id="seoLongTail" class="space-y-1 text-xs"></div>
                                </div>

                                <!-- Sosyal Medya Hashtag'leri -->
                                <div>
                                    <label class="text-xs text-slate-400 flex justify-between mb-1">
                                        <span><i class="fa-brands fa-instagram mr-1"></i>Sosyal Medya</span>
                                        <button onclick="copySEO('hashtags')" class="text-emerald-400 hover:text-emerald-300">
                                            <i class="fa-solid fa-copy"></i>
                                        </button>
                                    </label>
                                    <div id="seoHashtags" class="text-xs text-pink-400"></div>
                                </div>

                                <!-- Regenerate Button -->
                                <div class="flex gap-2 pt-2">
                                    <button onclick="generateSEO()" class="flex-1 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-xs font-medium">
                                        <i class="fa-solid fa-rotate mr-1"></i>Yeniden Oluştur
                                    </button>
                                    <button onclick="copyAllSEO()" class="flex-1 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 text-xs font-medium">
                                        <i class="fa-solid fa-clipboard mr-1"></i>Tümünü Kopyala
                                    </button>
                                </div>
                            </div>
                        </div>
                            </div>
                        </div>
                        <!-- END SEO Column -->
                    </div>
                    <!-- END Preview + SEO Grid -->

                    <!-- Mini Gallery (4 slots) -->
                    <div class="glass rounded-2xl p-4 md:p-5">
                        <h3 class="font-semibold mb-3 md:mb-4 flex items-center gap-2 text-sm md:text-base">
                            <i class="fa-solid fa-grip text-slate-400"></i>
                            Hızlı Galeri
                            <span class="text-[11px] md:text-xs text-slate-500 ml-auto">4 slot</span>
                        </h3>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 md:gap-3" id="miniGallery">
                            <div class="gallery-slot border-2 border-dashed border-slate-700 rounded-xl flex items-center justify-center" data-slot="0">
                                <i class="fa-solid fa-plus text-slate-600"></i>
                            </div>
                            <div class="gallery-slot border-2 border-dashed border-slate-700 rounded-xl flex items-center justify-center" data-slot="1">
                                <i class="fa-solid fa-plus text-slate-600"></i>
                            </div>
                            <div class="gallery-slot border-2 border-dashed border-slate-700 rounded-xl flex items-center justify-center" data-slot="2">
                                <i class="fa-solid fa-plus text-slate-600"></i>
                            </div>
                            <div class="gallery-slot border-2 border-dashed border-slate-700 rounded-xl flex items-center justify-center" data-slot="3">
                                <i class="fa-solid fa-plus text-slate-600"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Gallery Tab -->
        <section id="galleryTab" class="hidden">
            <div class="glass rounded-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="font-semibold text-lg">Tüm Görseller</h3>
                    <button onclick="clearGallery()" class="text-xs text-red-400 hover:text-red-300">
                        <i class="fa-solid fa-trash mr-1"></i>Temizle
                    </button>
                </div>
                <div id="fullGallery" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="text-center text-slate-500 col-span-full py-12">
                        <i class="fa-solid fa-images text-4xl mb-3"></i>
                        <p>Henüz görsel yok</p>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4" onclick="if(event.target === this) closeSettings()">
        <div class="glass rounded-2xl w-full max-w-lg p-6 relative z-10">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-lg">API Ayarları</h3>
                <button onclick="closeSettings()" class="text-slate-400 hover:text-white">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <div class="space-y-4">
                <!-- Gemini 2.5 -->
                <div class="p-4 bg-slate-800/30 rounded-xl border border-purple-500/30">
                    <label class="text-sm font-medium text-white mb-2 block flex items-center gap-2">
                        <i class="fa-solid fa-brain text-purple-400"></i> Gemini 2.5 Flash
                        <span class="text-[10px] px-2 py-0.5 bg-purple-500/20 text-purple-400 rounded-full">CİLT ÜRETİM</span>
                    </label>
                    <input type="password" id="geminiKeyInput"
                           class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-sm focus:border-purple-500 outline-none"
                           placeholder="Gemini API Key">
                    <p class="text-xs text-slate-500 mt-1">
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-purple-400 hover:underline">Gemini API key al →</a>
                    </p>
                </div>

                <!-- Fal.ai BiRefNet -->
                <div class="p-4 bg-slate-800/30 rounded-xl border border-green-500/30">
                    <label class="text-sm font-medium text-white mb-2 block flex items-center gap-2">
                        <i class="fa-solid fa-cut text-green-400"></i> Fal.ai BiRefNet
                        <span class="text-[10px] px-2 py-0.5 bg-green-500/20 text-green-400 rounded-full">ARKA PLAN KALDIRMA</span>
                    </label>
                    <input type="password" id="falKeyInput"
                           class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-sm focus:border-green-500 outline-none"
                           placeholder="Fal.ai API Key">
                    <p class="text-xs text-slate-500 mt-1">
                        <a href="https://fal.ai/dashboard/keys" target="_blank" class="text-green-400 hover:underline">Fal.ai API key al →</a>
                    </p>
                </div>

            </div>

            <button onclick="saveSettings()" class="w-full mt-6 py-3 bg-gradient-to-r from-orange-500 to-amber-500 rounded-xl font-bold">
                <i class="fa-solid fa-save mr-2"></i>Kaydet
            </button>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-4 right-4 hidden z-50">
        <div class="glass rounded-xl px-6 py-4 flex items-center gap-3">
            <i id="toastIcon" class="fa-solid fa-check-circle text-green-400 text-xl"></i>
            <span id="toastMessage">İşlem başarılı</span>
        </div>
    </div>

    <script>
        // ========== GEMINI MODEL CONFIG ==========
        const GEMINI_CONFIG = {
            // Gemini 3 - Text analiz için
            textModel: 'gemini-3-flash-preview',           // Analiz, SEO, JSON çıktı (hızlı)

            // Gemini 2.5 Flash Image - Edit için (daha sadık, az halüsinasyon)
            // NOT: Gemini 3 Pro Image çok yaratıcı, renkleri değiştiriyor!
            imageModel: 'gemini-2.5-flash-image',  // Eski çalışan model - renkleri koruyor

            // Fallback modeller
            fallbackTextModel: 'gemini-2.5-flash',
            fallbackImageModel: 'gemini-2.0-flash-exp',

            // API ayarları
            baseUrl: 'https://generativelanguage.googleapis.com/v1beta/models',
            maxRetries: 3,
            retryDelayMs: 1000
        };

        // Retry mekanizması ile API çağrısı
        async function callGeminiAPI(model, body, apiKey, retries = GEMINI_CONFIG.maxRetries) {
            const url = `${GEMINI_CONFIG.baseUrl}/${model}:generateContent?key=${apiKey}`;

            for (let attempt = 1; attempt <= retries; attempt++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });

                    if (response.ok) {
                        return await response.json();
                    }

                    // 429 (rate limit) veya 5xx hatalarında retry
                    if (response.status === 429 || response.status >= 500) {
                        if (attempt < retries) {
                            const delay = GEMINI_CONFIG.retryDelayMs * Math.pow(2, attempt - 1);
                            console.log(`⏳ API hatası (${response.status}), ${delay}ms sonra tekrar deneniyor... (${attempt}/${retries})`);
                            await new Promise(r => setTimeout(r, delay));
                            continue;
                        }
                    }

                    // Model bulunamadı - fallback'e geç
                    if (response.status === 404) {
                        const fallbackModel = model.includes('image')
                            ? GEMINI_CONFIG.fallbackImageModel
                            : GEMINI_CONFIG.fallbackTextModel;
                        console.log(`⚠️ ${model} bulunamadı, ${fallbackModel} deneniyor...`);
                        return callGeminiAPI(fallbackModel, body, apiKey, 1);
                    }

                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || `API hatası: ${response.status}`);

                } catch (error) {
                    if (attempt === retries) throw error;
                    const delay = GEMINI_CONFIG.retryDelayMs * Math.pow(2, attempt - 1);
                    console.log(`⏳ Hata: ${error.message}, ${delay}ms sonra tekrar... (${attempt}/${retries})`);
                    await new Promise(r => setTimeout(r, delay));
                }
            }
        }

        // ========== STATE ==========
        let state = {
            originalImage: null,
            originalBase64: null,
            originalProcessedImage: null, // Rötuş öncesi orijinal
            templateBase64: null,  // Model şablonu
            processedImage: null,
            gallery: [],
            workMode: 'mannequin', // 'mannequin' veya 'flatlay'
            settings: {
                modelProfile: 'neck_model',
                style: 'studio',
                pose: 'front',  // Varsayılan: önden
                jewelryCategory: 'general',  // Takı kategorisi
                necklaceLength: 'short',  // Kolye uzunluğu: choker, short, medium, long
                jewelrySize: 'medium',  // Takı/pendant boyutu: small, medium, large, xlarge
                outfit: 'black_vneck',  // Kıyafet
                scene: 'studio_clean',  // Sahne
                autoOutfit: false  // AI otomatik öneri
            },
            position: {
                x: 50,      // Yatay pozisyon (%)
                y: 50,      // Dikey pozisyon (%)
                scale: 60,  // Takı boyutu (%)
                rotation: 0 // Döndürme (derece)
            },
            extractedJewelry: null, // BiRefNet ile çıkarılan takı (şeffaf arka plan)
            detectedProperties: null, // Otomatik tespit edilen takı özellikleri
            seo: {
                title: '',
                altTitles: [],
                category: '',
                attributes: {},
                description: '',
                storyDescription: '',
                triggerWords: [],
                keywords: [],
                longTail: [],
                hashtags: ''
            }
        };

        // ========== ACCORDION TOGGLE ==========
        function toggleAccordion(header) {
            const content = header.nextElementSibling;
            const isOpen = content.classList.contains('open');

            // Toggle current accordion
            header.classList.toggle('open');
            content.classList.toggle('open');
        }

        // ========== WORK MODE ==========
        // Tek mod - setWorkMode artık gerekli değil
        function setWorkMode(mode) {
            // Artık tek mod var: Stüdyo Pro (halüsinasyonsuz)
            state.workMode = 'mannequin';
        }

        // ========== MANUAL IMAGE ADJUSTMENTS ==========
        function applyImageAdjustments() {
            if (!state.processedImage) return;

            const brightness = parseInt(document.getElementById('brightnessSlider').value);
            const contrast = parseInt(document.getElementById('contrastSlider').value);
            const saturation = parseInt(document.getElementById('saturationSlider').value);

            // Değerleri göster
            document.getElementById('brightnessValue').textContent = brightness;
            document.getElementById('contrastValue').textContent = contrast;
            document.getElementById('saturationValue').textContent = saturation;

            // CSS filter uygula
            const previewImg = document.getElementById('previewImage');
            const brightnessVal = 100 + brightness;
            const contrastVal = 100 + contrast;
            const saturationVal = 100 + saturation;

            previewImg.style.filter = `brightness(${brightnessVal}%) contrast(${contrastVal}%) saturate(${saturationVal}%)`;
        }

        function resetAdjustments() {
            document.getElementById('brightnessSlider').value = 0;
            document.getElementById('contrastSlider').value = 0;
            document.getElementById('saturationSlider').value = 0;

            document.getElementById('brightnessValue').textContent = '0';
            document.getElementById('contrastValue').textContent = '0';
            document.getElementById('saturationValue').textContent = '0';

            document.getElementById('previewImage').style.filter = '';

            // Orijinal görüntüyü geri yükle
            if (state.originalProcessedImage) {
                state.processedImage = state.originalProcessedImage;
                document.getElementById('previewImage').src = state.processedImage;
            }
        }

        function applyAndSaveAdjustments() {
            if (!state.processedImage) return;

            const brightness = parseInt(document.getElementById('brightnessSlider').value);
            const contrast = parseInt(document.getElementById('contrastSlider').value);
            const saturation = parseInt(document.getElementById('saturationSlider').value);

            // Canvas ile kalıcı uygulama
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = img.width;
                canvas.height = img.height;

                // Filter uygula
                ctx.filter = `brightness(${100 + brightness}%) contrast(${100 + contrast}%) saturate(${100 + saturation}%)`;
                ctx.drawImage(img, 0, 0);

                // Yeni base64 oluştur
                state.processedImage = canvas.toDataURL('image/png');
                state.originalProcessedImage = state.processedImage;

                // UI güncelle
                document.getElementById('previewImage').src = state.processedImage;
                document.getElementById('previewImage').style.filter = '';

                // Slider'ları sıfırla
                document.getElementById('brightnessSlider').value = 0;
                document.getElementById('contrastSlider').value = 0;
                document.getElementById('saturationSlider').value = 0;
                document.getElementById('brightnessValue').textContent = '0';
                document.getElementById('contrastValue').textContent = '0';
                document.getElementById('saturationValue').textContent = '0';

                showToast('Rötuş uygulandı!', 'success');
            };
            img.src = state.processedImage;
        }

        // ========== SEO GENERATOR - ADVANCED ==========
        async function generateSEO() {
            const geminiKey = localStorage.getItem('gemini_api_key');
            if (!geminiKey) {
                showToast('Gemini API key gerekli', 'error');
                return;
            }

            showToast('SEO Pro oluşturuluyor... AI analizi başlıyor', 'success');

            // ===== BASİTLEŞTİRİLMİŞ GİRDİ =====
            const productFeatures = document.getElementById('seoProductFeatures').value.trim();

            // Kullanıcının girdiği özellikler
            const userInputSection = productFeatures
                ? `\n\n===== KULLANICININ GİRDİĞİ ÜRÜN ÖZELLİKLERİ =====\n${productFeatures}\n\nBu özellikleri SEO içeriğinde MUTLAKA kullan ve vurgula!`
                : '';

            try {
                const seoRequestBody = {
                    contents: [{
                        parts: [
                            {
                                text: `SEN BİR TRENDYOL SEO UZMANSIN.

===== TRENDYOL ÜRÜN YAPISI (ÇOK ÖNEMLİ!) =====
Trendyol'da ürün listelerken 3 farklı alan var:

1️⃣ BAŞLIK (99 karakter) → SADECE ARAMA KELİMELERİ!
   İnsanların Trendyol arama çubuğuna yazdığı kelimeler.

2️⃣ ÜRÜN ÖZELLİKLERİ → Trendyol'un AYRI dropdown/checkbox alanları:
   • Malzeme (dropdown)
   • Taş Türü (dropdown)
   • Zincir Uzunluğu (dropdown)
   • Renk (dropdown)
   • Hediye Paketi Yapılabilir mi? (evet/hayır) ← AYRI ALAN!
   • Ayarlanabilir mi? (evet/hayır) ← AYRI ALAN!

3️⃣ AÇIKLAMA → Detaylı bilgi ve hikaye

===== BAŞLIKTA KULLANILMAMASI GEREKEN KELİMELER =====
🚫 Bu kelimeler Trendyol'da AYRI alanlar olduğu için başlıkta YER KAPLAYIP işe yaramaz:
- "Hediye kutulu", "Hediye paketli" (ayrı checkbox)
- "Ayarlanabilir" (ayrı checkbox)
- "45cm", "50cm" vb uzunluklar (ayrı dropdown)
- "Hipoalerjenik" (ayrı alan)
- "Su geçirmez" (ayrı alan)
- "Sertifikalı" (ayrı alan)
- "Hızlı kargo" (Trendyol zaten gösteriyor)

===== BAŞLIKTA KULLANILMASI GEREKEN KELİMELER =====
✅ Yüksek arama hacimli, insanların gerçekten aradığı kelimeler:

ÜRÜN TİPİ (zorunlu): Kolye, Yüzük, Bileklik, Küpe, Set, Halhal, Broş
CİNSİYET: Kadın, Erkek, Unisex, Kız Çocuk
MALZEME: Gümüş, 925 Ayar, Altın, 14 Ayar, 22 Ayar
KAPLAMA: Rose Gold, Altın Kaplama, Rodyum
TAŞ: Zirkon, Pırlanta, Safir, Yakut, İnci, Turkuaz
STİL: Minimal, Şık, Zarif, Günlük, Bohem, Vintage, Modern, Elegant
TASARIM: Damla, Kalp, Yaprak, Kelebek, Yıldız, Ay, Sonsuzluk, İsim, Harf
ÖZEL: Trend, Moda, Yeni Sezon, Özel Tasarım

===== BAŞLIK FORMÜLÜ =====
[Cinsiyet] + [Malzeme] + [Ürün Tipi] + [Taş] + [Tasarım] + [Stil kelimeleri]

ÖRNEK BAŞLIKLAR (her biri FARKLI stil):
• Minimal ürün: "Kadın 925 Ayar Gümüş Kolye Minimal Sade İnce Zincir Günlük Rose Gold Kaplama"
• Vintage ürün: "Gümüş Küpe Kadın 925 Ayar Vintage Antik Model Damla Retro Osmanlı Motif"
• Bohem ürün: "Kadın Bileklik Doğal Taş Turkuaz Bohem Etnik El Yapımı Ayarlanabilir Yaz"
• Lüks ürün: "925 Gümüş Kolye Kadın Pırlanta Montür Lüks Premium Özel Tasarım Parlak"

===== KULLANICI BİLGİLERİ =====
${userInputSection || 'Kullanıcı ek bilgi girmedi. Görseli analiz ederek ürünü tanımla.'}

===== KRİTİK: STİL KELİMELERİ =====
🚫 HER ÜRÜNE AYNI KELİMELERİ KOYMA! Bu spam/keyword stuffing olur.
Her ürünün sonuna "Trend Şık Zarif Moda Yeni Sezon" KOYMA!

✅ Görseldeki ürünün GERÇEK stiline göre kelime seç:
- Minimal/sade görünüm → "Minimal Sade İnce"
- Vintage/antik görünüm → "Vintage Retro Antik"
- Bohem/etnik görünüm → "Bohem Etnik Doğal"
- Lüks/gösterişli → "Lüks Premium Parlak"
- Günlük/basit → "Günlük Casual Rahat"
- Romantik/kalp → "Romantik Sevgili Aşk"

Sadece 2-3 stil kelimesi yeterli, abartma!

===== GÖREV =====
1. Görseli DETAYLİ analiz et (aşağıdaki rehberi kullan)
2. Kullanıcının verdiği teknik bilgileri (renk, kaplama, malzeme) BAŞLIĞA DAHİL ET
3. Başlığı yüksek arama hacimli kelimeler + ürün özellikleri ile oluştur
4. 99 karakteri DOLDUR ama geçme

===== GÖRSEL ANALİZ REHBERİ (DİKKATLİ İNCELE!) =====

🎨 RENK ANALİZİ:
- Metal rengi: Altın sarısı, rose gold (pembe altın), gümüş gri, antik bronz, bakır
- Taş renkleri: Şeffaf/beyaz, mavi, yeşil, kırmızı, siyah, mor, turkuaz, pembe
- Boncuk/inci renkleri: Beyaz inci, siyah inci, krem, çok renkli
- Genel ton: Sıcak (altın tonları) veya soğuk (gümüş tonları)

💎 TASARIM ANALİZİ:
- Şekil/Motif: Çiçek, yaprak, kalp, yıldız, ay, geometrik, damla, kelebek, kuş, hayvan, harf/isim, sonsuzluk, haç, nazar, fatma eli, fil, baykuş
- Doku: Pürüzsüz parlak, mat, dokulu, örgü, zincir, hasır
- Stil: Minimal/sade, statement/gösterişli, bohem/etnik, vintage/antik, modern/geometrik, romantik, gotik

📏 YAPI ANALİZİ:
- Zincir tipi: İnce zincir, kalın zincir, boncuklu, örgü, yılan zincir, top zincir
- Pendant/Uç: Tek taş, çoklu taş, figür, plaka, madalyon
- Boyut hissi: Minimal/küçük, orta, büyük/statement

🔍 MALZEME TAHMİNİ (görünüme göre):
- Parlak sarı metal → Altın veya altın kaplama
- Parlak beyaz metal → Gümüş veya çelik
- Pembe/rose tonlu metal → Rose gold
- Mat/kararmış metal → Antik, oksitli
- Parlak kesimli taşlar → Zirkon, kristal
- Doğal görünümlü taşlar → Doğal taş (turkuaz, akik, oniks vb.)
- Yuvarlak parlak boncuklar → İnci veya boncuk

===== ÖNEMLİ: ÜRÜN ÖZELLİKLERİ BAŞLIĞA GİRER =====
Kullanıcı "925 ayar gümüş, rose gold kaplama, zirkon taş" verdiyse:
BAŞLIK: "Kadın 925 Ayar Gümüş Kolye Rose Gold Kaplama Zirkon Taş Minimal Şık"

Görsel analizinden çıkardığın renk ve tasarım bilgileri → MUTLAKA başlıkta olmalı!

===== JSON ÇIKTISI =====
{
    "visualAnalysis": {
        "productType": "Kolye/Yüzük/Bileklik/Küpe/Set",
        "metalColor": "Altın/Gümüş/Rose Gold/Antik",
        "stoneType": "Zirkon/İnci/Doğal Taş/Yok",
        "stoneColor": "Şeffaf/Mavi/Yeşil/Siyah vb.",
        "designMotif": "Çiçek/Kalp/Yaprak/Geometrik vb.",
        "style": "Minimal/Bohem/Vintage/Statement",
        "chainType": "İnce zincir/Boncuklu/Örgü vb."
    },
    "barcode": "8680XXXXXXXXX (13 haneli benzersiz barkod - 8680 ile başla, rastgele 9 rakam ekle)",
    "modelCode": "KLY-RG-001 (Ürün tipi kısaltması + renk kodu + 3 haneli numara)",
    "title": "Görsel analizinden çıkan özellikler + arama kelimeleri (99 karakter)",
    "altTitles": ["3 farklı kelime sıralaması ile alternatif başlıklar"],
    "category": "Takı > Kolye / Yüzük / Bileklik > Alt kategori",
    "description": "Teknik açıklama - ürün özellikleri maddeler halinde",
    "storyDescription": "✨ Duygusal açıklama - kadınlara hitap eden samimi ton",
    "keywords": ["15 adet yüksek hacimli arama kelimesi"],
    "longTail": ["5 adet 4-6 kelimelik arama sorgusu"],
    "hashtags": "#trendyol #kolye #gümüş #takı #moda"
}

MODEL KODU FORMATI:
- Kolye → KLY, Yüzük → YZK, Bileklik → BLK, Küpe → KPE, Set → SET, Halhal → HLH
- Renk: RG (Rose Gold), GMS (Gümüş), ALT (Altın), ANT (Antik)
- Örnek: KLY-RG-847, YZK-GMS-213, BLK-ALT-456

SADECE JSON döndür, başka bir şey yazma!`
                            },
                            ...(state.originalBase64 ? [{ inlineData: { mimeType: 'image/jpeg', data: state.originalBase64.split(',')[1] } }] : [])
                        ]
                    }],
                    generationConfig: { temperature: 0.3 }
                };

                const data = await callGeminiAPI(GEMINI_CONFIG.textModel, seoRequestBody, geminiKey);
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';

                // JSON parse - markdown code block'u da yakala
                let jsonStr = text;
                const codeBlockMatch = text.match(/```(?:json)?\s*([\s\S]*?)```/);
                if (codeBlockMatch) {
                    jsonStr = codeBlockMatch[1].trim();
                }

                const jsonMatch = jsonStr.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const seoData = JSON.parse(jsonMatch[0]);
                    state.seo = seoData;

                    // === UI GÜNCELLE ===

                    // 0. Görsel Analiz Sonuçları
                    const vaContainer = document.getElementById('visualAnalysisContent');
                    vaContainer.innerHTML = '';
                    if (seoData.visualAnalysis) {
                        const va = seoData.visualAnalysis;
                        const analysisLabels = {
                            productType: '📦 Ürün Tipi',
                            metalColor: '🎨 Metal Rengi',
                            stoneType: '💎 Taş Tipi',
                            stoneColor: '🔮 Taş Rengi',
                            designMotif: '✨ Tasarım',
                            style: '🏷️ Stil',
                            chainType: '⛓️ Zincir'
                        };
                        Object.entries(va).forEach(([key, value]) => {
                            if (value && value !== 'Yok' && value !== '-') {
                                const div = document.createElement('div');
                                div.className = 'bg-purple-500/10 rounded px-2 py-1';
                                div.innerHTML = `<span class="text-purple-300">${analysisLabels[key] || key}:</span> <span class="text-white">${value}</span>`;
                                vaContainer.appendChild(div);
                            }
                        });
                    }

                    // 0.5 Barkod ve Model Kodu
                    // Barkod: Her zaman yeni benzersiz barkod üret (8680 + 9 rastgele rakam)
                    const uniqueBarcode = '8680' + Math.floor(Math.random() * 900000000 + 100000000).toString();
                    document.getElementById('seoBarcode').value = uniqueBarcode;
                    document.getElementById('seoModelCode').value = seoData.modelCode || '';

                    // 1. Ana Başlık
                    document.getElementById('seoTitle').value = seoData.title || '';
                    updateCharCount('title');

                    // 2. Alternatif Başlıklar
                    const altTitlesContainer = document.getElementById('altTitles');
                    altTitlesContainer.innerHTML = '';
                    (seoData.altTitles || []).forEach((title, idx) => {
                        const div = document.createElement('div');
                        div.className = 'flex items-center gap-2 bg-slate-800/50 rounded-lg px-3 py-2';
                        div.innerHTML = `
                            <span class="text-slate-500 text-xs">${idx + 1}.</span>
                            <span class="flex-1 text-xs">${title}</span>
                            <button onclick="copyText('${title.replace(/'/g, "\\'")}')" class="text-emerald-400 hover:text-emerald-300">
                                <i class="fa-solid fa-copy text-xs"></i>
                            </button>
                        `;
                        altTitlesContainer.appendChild(div);
                    });

                    // 3. Kategori
                    document.getElementById('seoCategory').value = seoData.category || '';

                    // 4. Teknik Açıklama
                    document.getElementById('seoDescription').value = seoData.description || '';
                    updateCharCount('desc');

                    // 5b. Hikayeleştirilmiş Açıklama
                    document.getElementById('seoStoryDescription').textContent = seoData.storyDescription || '';

                    // 6. Keywords
                    const keywordsContainer = document.getElementById('seoKeywords');
                    keywordsContainer.innerHTML = '';
                    (seoData.keywords || []).forEach(kw => {
                        const tag = document.createElement('span');
                        tag.className = 'px-2 py-1 bg-emerald-500/20 text-emerald-400 text-xs rounded-full cursor-pointer hover:bg-emerald-500/30';
                        tag.textContent = kw;
                        tag.onclick = () => copyText(kw);
                        keywordsContainer.appendChild(tag);
                    });

                    // 7. Long-tail Keywords
                    const longTailContainer = document.getElementById('seoLongTail');
                    longTailContainer.innerHTML = '';
                    (seoData.longTail || []).forEach(lt => {
                        const div = document.createElement('div');
                        div.className = 'flex items-center gap-2 bg-blue-500/10 rounded-lg px-3 py-2';
                        div.innerHTML = `
                            <i class="fa-solid fa-magnifying-glass text-blue-400 text-[10px]"></i>
                            <span class="flex-1 text-xs text-blue-300">${lt}</span>
                            <button onclick="copyText('${lt.replace(/'/g, "\\'")}')" class="text-blue-400 hover:text-blue-300">
                                <i class="fa-solid fa-copy text-xs"></i>
                            </button>
                        `;
                        longTailContainer.appendChild(div);
                    });

                    // 8. Hashtags
                    document.getElementById('seoHashtags').textContent = seoData.hashtags || '';

                    // Sonuçları göster
                    document.getElementById('seoPlaceholder').classList.add('hidden');
                    document.getElementById('seoResults').classList.remove('hidden');

                    showToast('SEO Pro oluşturuldu!', 'success');
                }
            } catch (error) {
                console.error('SEO error:', error);
                showToast('SEO oluşturulamadı: ' + error.message, 'error');
            }
        }

        // Karakter sayacı güncelle
        function updateCharCount(type) {
            if (type === 'title') {
                const title = document.getElementById('seoTitle').value;
                const count = title.length;
                const counter = document.getElementById('titleCharCount');
                counter.textContent = `${count}/99`;
                counter.className = count > 99 ? 'text-red-400' : 'text-emerald-400';
            } else if (type === 'desc') {
                const desc = document.getElementById('seoDescription').value;
                const count = desc.length;
                const counter = document.getElementById('descCharCount');
                counter.textContent = `${count}/500`;
                counter.className = count > 500 ? 'text-red-400' : 'text-emerald-400';
            }
        }

        // Tek metin kopyala
        function copyText(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Kopyalandı!', 'success');
            });
        }

        // SEO alanı kopyala
        function copySEO(type) {
            let text = '';
            if (type === 'title') text = document.getElementById('seoTitle').value;
            else if (type === 'description') text = document.getElementById('seoDescription').value;
            else if (type === 'story') text = state.seo.storyDescription || '';
            else if (type === 'keywords') text = state.seo.keywords?.join(', ') || '';
            else if (type === 'category') text = document.getElementById('seoCategory').value;
            else if (type === 'hashtags') text = state.seo.hashtags || '';
            else if (type === 'triggers') text = state.seo.triggerWords?.join(', ') || '';
            else if (type === 'barcode') text = document.getElementById('seoBarcode').value;
            else if (type === 'modelCode') text = document.getElementById('seoModelCode').value;

            navigator.clipboard.writeText(text).then(() => {
                showToast('Kopyalandı!', 'success');
            });
        }

        // Tüm SEO verilerini kopyala
        function copyAllSEO() {
            const seo = state.seo;
            if (!seo || !seo.title) {
                showToast('Önce SEO oluşturun', 'error');
                return;
            }

            const allText = `📦 TRENDYOL ÜRÜN SEO BİLGİLERİ
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🔢 BARKOD: ${seo.barcode || '-'}
🏷️ MODEL KODU: ${seo.modelCode || '-'}

📌 BAŞLIK (${(seo.title || '').length}/99 karakter):
${seo.title}

📝 ALTERNATİF BAŞLIKLAR:
${(seo.altTitles || []).map((t, i) => `${i + 1}. ${t}`).join('\n')}

📂 KATEGORİ:
${seo.category || '-'}

📄 TEKNİK AÇIKLAMA:
${seo.description}

💕 HİKAYELEŞTİRİLMİŞ AÇIKLAMA:
${seo.storyDescription || '-'}

🔑 ANAHTAR KELİMELER (${(seo.keywords || []).length} adet):
${(seo.keywords || []).join(', ')}

🔍 LONG-TAIL ARAMALAR:
${(seo.longTail || []).map(lt => `• ${lt}`).join('\n')}

#️⃣ HASHTAG'LER:
${seo.hashtags || ''}
`;

            navigator.clipboard.writeText(allText).then(() => {
                showToast('Tüm SEO verileri kopyalandı!', 'success');
            });
        }

        // ========== POSITION CONTROLS ==========
        function updatePositionValue(type) {
            if (type === 'y') {
                state.position.y = parseInt(document.getElementById('yOffsetSlider').value);
                document.getElementById('yOffsetValue').textContent = state.position.y + '%';
            } else if (type === 'x') {
                state.position.x = parseInt(document.getElementById('xOffsetSlider').value);
                document.getElementById('xOffsetValue').textContent = state.position.x + '%';
            } else if (type === 'scale') {
                state.position.scale = parseInt(document.getElementById('scaleSlider').value);
                document.getElementById('scaleValue').textContent = state.position.scale + '%';
            } else if (type === 'rotation') {
                state.position.rotation = parseInt(document.getElementById('rotationSlider').value);
                document.getElementById('rotationValue').textContent = state.position.rotation + '°';
            }
            // İnteraktif önizlemeyi güncelle
            updateInteractivePreview();
        }

        // ========== İNTERAKTİF ÖNİZLEME SİSTEMİ ==========
        let interactiveImages = { template: null, jewelry: null };

        // Takıyı hareket ettir
        function moveJewelry(direction) {
            const step = 2; // Her adımda %2
            if (direction === 'up') state.position.y = Math.max(0, state.position.y - step);
            else if (direction === 'down') state.position.y = Math.min(100, state.position.y + step);
            else if (direction === 'left') state.position.x = Math.max(0, state.position.x - step);
            else if (direction === 'right') state.position.x = Math.min(100, state.position.x + step);

            syncSlidersWithState();
            updateInteractivePreview();
        }

        // Takıyı döndür
        function rotateJewelry(degrees) {
            state.position.rotation += degrees;
            if (state.position.rotation > 180) state.position.rotation -= 360;
            if (state.position.rotation < -180) state.position.rotation += 360;

            syncSlidersWithState();
            updateInteractivePreview();
        }

        // Takı boyutunu değiştir
        function scaleJewelry(delta) {
            state.position.scale = Math.max(10, Math.min(150, state.position.scale + delta));

            syncSlidersWithState();
            updateInteractivePreview();
        }

        // Slider'ları state ile senkronize et
        function syncSlidersWithState() {
            document.getElementById('xOffsetSlider').value = state.position.x;
            document.getElementById('xOffsetValue').textContent = state.position.x + '%';
            document.getElementById('yOffsetSlider').value = state.position.y;
            document.getElementById('yOffsetValue').textContent = state.position.y + '%';
            document.getElementById('scaleSlider').value = state.position.scale;
            document.getElementById('scaleValue').textContent = state.position.scale + '%';
            document.getElementById('rotationSlider').value = state.position.rotation;
            document.getElementById('rotationValue').textContent = state.position.rotation + '°';
        }

        // İnteraktif önizlemeyi güncelle
        function updateInteractivePreview() {
            if (!state.templateBase64 || !state.extractedJewelry) return;

            const canvas = document.getElementById('interactiveCanvas');
            const ctx = canvas.getContext('2d');

            // Eğer resimler yüklenmediyse yükle
            if (!interactiveImages.template || !interactiveImages.jewelry) {
                loadInteractiveImages();
                return;
            }

            const templateImg = interactiveImages.template;
            const jewelryImg = interactiveImages.jewelry;

            // Canvas boyutunu ayarla
            canvas.width = templateImg.width;
            canvas.height = templateImg.height;

            // 1. Şablonu çiz
            ctx.drawImage(templateImg, 0, 0);

            // 2. Takıyı pozisyon ayarlarına göre çiz
            const pos = state.position;
            const jewelryWidth = templateImg.width * (pos.scale / 100);
            const jewelryHeight = (jewelryImg.height / jewelryImg.width) * jewelryWidth;

            const x = (templateImg.width * (pos.x / 100)) - (jewelryWidth / 2);
            const y = (templateImg.height * (pos.y / 100)) - (jewelryHeight / 2);

            const rotation = (pos.rotation || 0) * Math.PI / 180;

            ctx.save();
            ctx.translate(x + jewelryWidth / 2, y + jewelryHeight / 2);
            ctx.rotate(rotation);
            ctx.drawImage(jewelryImg, -jewelryWidth / 2, -jewelryHeight / 2, jewelryWidth, jewelryHeight);
            ctx.restore();
        }

        // İnteraktif resimları yükle
        function loadInteractiveImages() {
            if (!state.templateBase64 || !state.extractedJewelry) return;

            const templateImg = new Image();
            const jewelryImg = new Image();
            let loaded = 0;

            const onLoad = () => {
                loaded++;
                if (loaded === 2) {
                    interactiveImages.template = templateImg;
                    interactiveImages.jewelry = jewelryImg;
                    updateInteractivePreview();
                }
            };

            templateImg.onload = onLoad;
            jewelryImg.onload = onLoad;
            templateImg.src = state.templateBase64;
            jewelryImg.src = state.extractedJewelry;
        }

        // İnteraktif modu aç
        function showInteractivePreview() {
            if (!state.templateBase64 || !state.extractedJewelry) return;

            document.getElementById('previewPlaceholder').classList.add('hidden');
            document.getElementById('previewImage').classList.add('hidden');
            document.getElementById('interactiveCanvas').classList.remove('hidden');
            document.getElementById('positionControls').classList.remove('hidden');

            loadInteractiveImages();
        }

        // İnteraktif modu kapat
        function hideInteractivePreview() {
            document.getElementById('interactiveCanvas').classList.add('hidden');
            document.getElementById('positionControls').classList.add('hidden');
        }

        // Canvas sürükleme desteği
        function setupCanvasDrag() {
            const canvas = document.getElementById('interactiveCanvas');
            let isDragging = false;

            canvas.addEventListener('mousedown', (e) => {
                isDragging = true;
                canvas.style.cursor = 'grabbing';
            });

            canvas.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const rect = canvas.getBoundingClientRect();
                state.position.x = Math.round((e.clientX - rect.left) / rect.width * 100);
                state.position.y = Math.round((e.clientY - rect.top) / rect.height * 100);
                state.position.x = Math.max(0, Math.min(100, state.position.x));
                state.position.y = Math.max(0, Math.min(100, state.position.y));
                syncSlidersWithState();
                updateInteractivePreview();
            });

            canvas.addEventListener('mouseup', () => {
                isDragging = false;
                canvas.style.cursor = 'move';
            });

            canvas.addEventListener('mouseleave', () => {
                isDragging = false;
                canvas.style.cursor = 'move';
            });

            // Mouse wheel ile zoom
            canvas.addEventListener('wheel', (e) => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -3 : 3;
                scaleJewelry(delta);
            });
        }

        // Klavye ok tuşları desteği
        function setupKeyboardControls() {
            document.addEventListener('keydown', (e) => {
                // Sadece canvas görünürse çalış
                const canvas = document.getElementById('interactiveCanvas');
                if (canvas.classList.contains('hidden')) return;

                // Input alanlarında çalışmasın
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

                switch(e.key) {
                    case 'ArrowUp': moveJewelry('up'); e.preventDefault(); break;
                    case 'ArrowDown': moveJewelry('down'); e.preventDefault(); break;
                    case 'ArrowLeft': moveJewelry('left'); e.preventDefault(); break;
                    case 'ArrowRight': moveJewelry('right'); e.preventDefault(); break;
                    case 'q': case 'Q': rotateJewelry(-5); e.preventDefault(); break;
                    case 'e': case 'E': rotateJewelry(5); e.preventDefault(); break;
                    case '+': case '=': scaleJewelry(3); e.preventDefault(); break;
                    case '-': case '_': scaleJewelry(-3); e.preventDefault(); break;
                }
            });
        }

        // Init interactive controls
        window.addEventListener('load', () => {
            setupCanvasDrag();
            setupKeyboardControls();
        });

        // ========== ÖNİZLEME FONKSİYONU ==========
        async function previewJewelryPlacement() {
            // Kontroller
            if (!state.originalBase64) {
                showToast('Önce bir ürün fotoğrafı yükleyin', 'error');
                return;
            }

            if (!state.templateBase64) {
                showToast('Önce bir model şablonu yükleyin', 'error');
                return;
            }

            const falKey = localStorage.getItem('fal_api_key');
            if (!falKey) {
                showToast('Fal.ai API key gerekli - BiRefNet için', 'error');
                openSettings();
                return;
            }

            try {
                showLoader('Önizleme hazırlanıyor...', '1/2 Takı çıkarılıyor');

                // BiRefNet ile takıyı çıkar
                const birefnetResponse = await fetch('https://fal.run/fal-ai/birefnet', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Key ${falKey}`
                    },
                    body: JSON.stringify({
                        image_url: state.originalBase64,
                        model: "General Use (Light)",
                        operating_resolution: state.isHighRes ? "2048x2048" : "1024x1024",
                        output_format: "png"
                    })
                });

                if (!birefnetResponse.ok) {
                    throw new Error('BiRefNet hatası');
                }

                const birefnetData = await birefnetResponse.json();
                const transparentJewelryUrl = birefnetData.image?.url;

                if (!transparentJewelryUrl) {
                    throw new Error('Takı çıkarılamadı');
                }

                // URL'den base64'e çevir ve state'e kaydet
                showLoader('Önizleme hazırlanıyor...', '2/2 Önizleme oluşturuluyor');
                state.extractedJewelry = await fetchImageAsBase64(transparentJewelryUrl);

                // Önceki interaktif resimleri temizle
                interactiveImages = { template: null, jewelry: null };

                // İnteraktif önizlemeyi göster
                hideLoader();
                showInteractivePreview();

                showToast('Önizleme hazır! Takıyı sürükleyerek konumlandırın', 'success');

            } catch (error) {
                console.error('Preview error:', error);
                hideLoader();
                showToast('Önizleme hatası: ' + error.message, 'error');
            }
        }

        // ========== MODEL PROFILES - REALISM BOOST ==========
        const modelProfiles = {
            // ========== GENEL MODELLER ==========
            'neck_model': {
                desc: "Jewelry Photography: Headless cropped shot of a female model focusing on the neck. Real human skin texture with pores and natural imperfections. Clean skin but NOT airbrushed. Hands completely away from the necklace/neck area. Hair tied back. Clear view of the decolletage.",
                info: "Kolye Odaklı: Gerçekçi cilt dokusu, doğal kusurlar.",
                category: "general",
                icon: "fa-circle-user",
                color: "rose"
            },
            'hand_model': {
                desc: "Hand jewelry photography: Elegant female hands with natural skin texture. Visible pores, subtle veins, and realistic nail beds. Fingers slightly spread to showcase rings. Wrist visible for bracelets. Real human hands, not mannequin.",
                info: "El Modeli: Yüzük & bileklik için doğal el görünümü.",
                category: "general",
                icon: "fa-hand",
                color: "amber"
            },
            'set_model': {
                desc: "Jewelry set photography: Female model from shoulders up, showing both neck and ears. Real skin texture with natural undertones. Hair elegantly styled away from ears and neck. Coordinated necklace and earring display on living human skin.",
                info: "Set Modeli: Kolye + küpe birlikte görüntüleme.",
                category: "general",
                icon: "fa-users",
                color: "violet"
            },
            'boho_model': {
                desc: "Bohemian lifestyle jewelry photography: Sun-kissed skin with natural warmth. Outdoor lighting feel. Relaxed, natural pose. Visible freckles and tan lines welcome. Beach or nature vibes. Authentic human appearance.",
                info: "Bohem Modeli: Doğal & yazlık görünüm.",
                category: "general",
                icon: "fa-sun",
                color: "orange"
            },
            // ========== MİNİMAL TAKI MODELLERİ ==========
            'minimal_neck': {
                desc: "MINIMAL/DELICATE JEWELRY NECK: Ultra-close crop focusing ONLY on collarbone and lower neck area. Very soft, even diffused lighting with NO harsh shadows. Maximum negative space around the jewelry. Smooth realistic skin with subtle pores. Perfect for thin chains, small pendants, delicate chokers. Soft gradient background. The delicate jewelry is the ONLY focal point.",
                info: "Minimal Kolye: İnce zincir, küçük pendant için optimize.",
                category: "minimal",
                icon: "fa-minus",
                color: "sky"
            },
            'minimal_hand': {
                desc: "MINIMAL/DELICATE HAND JEWELRY: Elegant hand pose with fingers gently together or slightly curved. Soft, even lighting to capture thin bands and small stones without overpowering them. Clean, uncluttered composition with lots of negative space. Natural or bare nails. Real skin texture. Focus entirely on the delicate minimalist ring details.",
                info: "Minimal Yüzük: İnce band, küçük taş detayları.",
                category: "minimal",
                icon: "fa-ring",
                color: "sky"
            },
            // ========== STATEMENT TAKI MODELLERİ ==========
            'statement_neck': {
                desc: "STATEMENT/BOLD NECKLACE: Wider frame showing full shoulders and upper chest to capture the SCALE of large jewelry. More dramatic lighting with intentional highlights on metallic surfaces. Confident presentation. The bold jewelry commands attention and fills the frame. Can include subtle background texture. Editorial fashion feel. Real skin with natural warmth.",
                info: "Statement Kolye: Büyük, gösterişli parçalar için geniş kadraj.",
                category: "statement",
                icon: "fa-gem",
                color: "fuchsia"
            },
            'statement_ear': {
                desc: "STATEMENT EARRINGS: Side profile or 3/4 angle showing the FULL DROP LENGTH of large earrings. Hair pulled completely back and away. Dramatic lighting to catch sparkle, movement and dimension. Neck and jawline visible to emphasize scale. Editorial fashion photography style. Real human ear with natural skin texture.",
                info: "Statement Küpe: Sarkık, büyük küpeler için profil çekim.",
                category: "statement",
                icon: "fa-star",
                color: "fuchsia"
            },
            // ========== İNCİ TAKI MODELLERİ ==========
            'pearl_neck': {
                desc: "PEARL NECKLACE SPECIALIST: Soft, DIFFUSED wrap-around lighting essential for pearl luster - absolutely NO harsh directional light or hot spots. Neutral warm skin tone that complements cream/white pearl colors. Very smooth, clean gradient background. Close framing to show pearl quality, surface, and natural overtones. Gentle soft shadows only. Lighting must make pearls GLOW naturally.",
                info: "İnci Kolye: İnci parlaklığı için özel yumuşak aydınlatma.",
                category: "pearl",
                icon: "fa-circle",
                color: "slate"
            },
            'pearl_ear': {
                desc: "PEARL EARRING SPECIALIST: Soft wrap-around diffused lighting for maximum pearl luster and iridescence. Clean composition focusing on ear area. Hair elegantly swept away from ears. Neutral background that doesn't compete with pearl colors (cream, white, pink overtones). Capture the natural glow and surface quality of pearls. Flattering soft light on skin.",
                info: "İnci Küpe: İnci parlaklığını öne çıkaran kompozisyon.",
                category: "pearl",
                icon: "fa-circle",
                color: "slate"
            }
        };

        // ========== STYLE PRESETS ==========
        const stylePresets = {
            'studio': {
                prompt: "Style: Commercial Studio Photography. Pure white or light grey background. Even lighting, no hard shadows. Clean, minimalist, high-end e-commerce look. Pandora/Tiffany aesthetic.",
                bg: "#f5f5f5"
            },
            'boho': {
                prompt: "Style: Bohemian Aesthetic. Warm earth tones, beige/sand colors. Natural organic textures (stone, wood, linen) in background. Soft sun flare. Lifestyle photography feel.",
                bg: "#f5e6d3"
            },
            'luxury': {
                prompt: "Style: Luxury Dark Mode. Black or deep navy background. Marble or velvet textures. Spot lighting to create dramatic highlights. Premium, expensive look. Cartier/Bulgari aesthetic.",
                bg: "#1a1a1a"
            }
        };

        // ========== OUTFIT PRESETS - KIYAFET ==========
        const outfitPresets = {
            'black_vneck': {
                name: "Siyah V-Yaka",
                prompt: "Model wearing an elegant BLACK V-neck top/dress. The V-neckline perfectly frames the necklace. Sophisticated, timeless look.",
                color: "#000000"
            },
            'white_off': {
                name: "Beyaz Straplez",
                prompt: "Model wearing a WHITE off-shoulder or strapless top. Clean, bridal aesthetic. Maximum focus on the necklace against white fabric.",
                color: "#FFFFFF"
            },
            'cream_silk': {
                name: "Krem İpek",
                prompt: "Model wearing a CREAM/IVORY silk blouse or camisole. Soft, luxurious fabric with subtle sheen. Elegant and feminine.",
                color: "#F5F5DC"
            },
            'burgundy': {
                name: "Bordo",
                prompt: "Model wearing a deep BURGUNDY/WINE colored top. Rich, warm color that complements gold jewelry beautifully. Elegant evening look.",
                color: "#722F37"
            },
            'navy': {
                name: "Lacivert",
                prompt: "Model wearing a NAVY BLUE elegant top. Classic, sophisticated color that works with both gold and silver jewelry.",
                color: "#1B3A5F"
            },
            'nude': {
                name: "Ten Rengi",
                prompt: "Model wearing a NUDE/SKIN-TONE colored top that blends with skin. Minimal visual distraction, all focus on the jewelry.",
                color: "#E8BEAC"
            },
            'forest': {
                name: "Koyu Yeşil",
                prompt: "Model wearing a deep FOREST GREEN or EMERALD top. Rich, jewel-toned color that creates beautiful contrast.",
                color: "#228B22"
            },
            'none': {
                name: "Yok (Sadece Cilt)",
                prompt: "Model with bare shoulders and neck, no clothing visible in frame. Focus entirely on skin and jewelry. Tasteful, artistic nude shoulders.",
                color: null
            }
        };

        // ========== SCENE PRESETS - SAHNE ==========
        const scenePresets = {
            'studio_clean': {
                name: "Stüdyo",
                prompt: "SCENE: Professional photography studio. Pure white or light grey seamless background. Even, soft lighting. Clean, commercial e-commerce aesthetic.",
            },
            'romantic': {
                name: "Romantik",
                prompt: "SCENE: Soft, romantic atmosphere. Blush pink or soft peach tones. Dreamy, slightly diffused lighting. Rose petals or soft fabrics in background blur. Valentine's Day feel.",
            },
            'luxury_dark': {
                name: "Lüks Dark",
                prompt: "SCENE: Luxurious dark setting. Deep black or navy background. Dramatic spot lighting. Velvet or marble textures. High-end jewelry store aesthetic. Cartier/Bulgari mood.",
            },
            'golden_hour': {
                name: "Golden Hour",
                prompt: "SCENE: Warm golden hour sunlight. Soft, warm lighting from the side. Natural sun flare. Outdoor or window-lit feel. Instagram-worthy aesthetic.",
            },
            'minimalist': {
                name: "Minimal",
                prompt: "SCENE: Ultra-minimalist setting. Pure, clean background with maximum negative space. No distractions. Scandinavian design aesthetic. Focus 100% on jewelry.",
            },
            'editorial': {
                name: "Editorial",
                prompt: "SCENE: High-fashion editorial setting. Dramatic, artistic lighting. Strong shadows and highlights. Vogue/Harper's Bazaar magazine style photography.",
            },
            'nature': {
                name: "Doğal",
                prompt: "SCENE: Natural, organic setting. Soft natural daylight. Greenery or natural elements in soft background blur. Fresh, lifestyle photography feel.",
            },
            'festive': {
                name: "Şık Gece",
                prompt: "SCENE: Festive evening atmosphere. Soft bokeh lights in background. Glamorous, party-ready mood. New Year's Eve or special occasion feel. Subtle sparkle.",
            }
        };

        // ========== POSE PRESETS - ÜRÜN POZLARI ==========
        const posePresets = {
            'front': {
                name: "Önden (Varsayılan)",
                prompt: "Model facing camera directly, front view. Jewelry clearly visible from the front."
            },
            'right': {
                name: "Sağ Profil",
                prompt: "Model turned to show RIGHT side profile (3/4 view). Camera captures the right side of neck/ear. Good for showing earrings or side of necklace."
            },
            'left': {
                name: "Sol Profil",
                prompt: "Model turned to show LEFT side profile (3/4 view). Camera captures the left side of neck/ear. Good for showing earrings or side of necklace."
            },
            'down': {
                name: "Aşağı Bakış",
                prompt: "Model looking down slightly, chin tilted down. Camera captures from slightly above. Shows top view of necklace on décolletage."
            },
            'closeup': {
                name: "Yakın Çekim",
                prompt: "Close-up shot focusing tightly on the jewelry area. Less body visible, more jewelry detail. Macro-style product focus."
            },
            'surface': {
                name: "Düz Yüzey",
                prompt: "NO MODEL. Jewelry laid flat on elegant surface (marble, velvet, or wood). Top-down flat lay photography. Product-only shot."
            }
        };

        // ========== CRITICAL: SKIN FIX PROMPT ==========
        const skinFix = " Render the neck/skin as hyper-realistic living human skin with pores and texture. REMOVE any plastic mannequin seams, stands, or artificial holders. The jewelry should rest naturally on human skin. NO mannequin, NO plastic, NO artificial appearance. ";

        // ========== INIT ==========
        window.onload = () => {
            loadSettings();
            setupDragDrop();
            setupTemplateUpload();
        };

        // ========== TEMPLATE UPLOAD ==========
        function setupTemplateUpload() {
            const dropZone = document.getElementById('templateDropZone');
            const input = document.getElementById('templateInput');

            dropZone.onclick = () => input.click();

            input.onchange = (e) => {
                if (e.target.files[0]) handleTemplateFile(e.target.files[0]);
            };

            dropZone.ondragover = (e) => {
                e.preventDefault();
                dropZone.classList.add('border-cyan-500');
            };

            dropZone.ondragleave = () => {
                dropZone.classList.remove('border-cyan-500');
            };

            dropZone.ondrop = (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-cyan-500');
                if (e.dataTransfer.files[0]) handleTemplateFile(e.dataTransfer.files[0]);
            };
        }

        function handleTemplateFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                state.templateBase64 = e.target.result;

                document.getElementById('templatePlaceholder').classList.add('hidden');
                document.getElementById('templatePreview').classList.remove('hidden');
                document.getElementById('templateImage').src = e.target.result;
                document.getElementById('templateName').textContent = file.name;

                showToast('Model şablonu yüklendi!', 'success');
            };
            reader.readAsDataURL(file);
        }

        // ========== TAB SWITCHING ==========
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.closest('.tab-btn').classList.add('active');

            document.getElementById('studioTab').classList.toggle('hidden', tab !== 'studio');
            document.getElementById('galleryTab').classList.toggle('hidden', tab !== 'gallery');
        }

        // ========== SETTINGS ==========
        function loadSettings() {
            const geminiKey = localStorage.getItem('gemini_api_key');
            const falKey = localStorage.getItem('fal_api_key');
            if (geminiKey) {
                document.getElementById('geminiKeyInput').value = geminiKey;
            }
            if (falKey) {
                document.getElementById('falKeyInput').value = falKey;
            }
            updateApiStatus();
        }

        function updateApiStatus() {
            const hasGemini = localStorage.getItem('gemini_api_key');
            const hasFal = localStorage.getItem('fal_api_key');

            if (hasGemini && hasFal) {
                document.getElementById('apiDot').className = 'w-2 h-2 rounded-full bg-green-500';
                document.getElementById('apiStatus').textContent = 'Hibrit Mod Hazır';
                document.getElementById('apiStatus').className = 'text-xs text-green-400';
            } else if (hasGemini || hasFal) {
                document.getElementById('apiDot').className = 'w-2 h-2 rounded-full bg-yellow-500';
                document.getElementById('apiStatus').textContent = 'API Eksik';
                document.getElementById('apiStatus').className = 'text-xs text-yellow-400';
            } else {
                document.getElementById('apiDot').className = 'w-2 h-2 rounded-full bg-red-500';
                document.getElementById('apiStatus').textContent = 'API Key Gerekli';
                document.getElementById('apiStatus').className = 'text-xs text-slate-400';
            }
        }

        function openSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function saveSettings() {
            const geminiKey = document.getElementById('geminiKeyInput').value.trim();
            const falKey = document.getElementById('falKeyInput').value.trim();

            if (!geminiKey || !falKey) {
                showToast('Lütfen her iki API Key girin', 'error');
                return;
            }

            localStorage.setItem('gemini_api_key', geminiKey);
            localStorage.setItem('fal_api_key', falKey);
            updateApiStatus();
            closeSettings();
            showToast('Hibrit mod hazır!', 'success');
        }

        // ========== FILE UPLOAD ==========
        function setupDragDrop() {
            const dropZone = document.getElementById('dropZone');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
                dropZone.addEventListener(e, (ev) => { ev.preventDefault(); ev.stopPropagation(); }, false);
            });

            ['dragenter', 'dragover'].forEach(e => {
                dropZone.addEventListener(e, () => dropZone.classList.add('border-orange-500', 'bg-orange-500/10'), false);
            });

            ['dragleave', 'drop'].forEach(e => {
                dropZone.addEventListener(e, () => dropZone.classList.remove('border-orange-500', 'bg-orange-500/10'), false);
            });

            dropZone.addEventListener('drop', (e) => {
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    processFile(file);
                }
            }, false);
        }

        function handleUpload(e) {
            const file = e.target.files[0];
            if (file) processFile(file);
        }

        function processFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                state.originalBase64 = e.target.result;

                const img = new Image();
                img.onload = async () => {
                    state.originalImage = img;
                    // Orijinal boyutları sakla
                    state.originalWidth = img.width;
                    state.originalHeight = img.height;
                    state.isHighRes = img.width >= 1500 || img.height >= 1500;

                    document.getElementById('uploadPrompt').classList.add('hidden');
                    document.getElementById('uploadPreviewContainer').classList.remove('hidden');
                    document.getElementById('uploadPreview').src = state.originalBase64;
                    document.getElementById('fileName').textContent = `${file.name} (${img.width}x${img.height})${state.isHighRes ? ' HD' : ''}`;

                    showToast(`Ürün yüklendi${state.isHighRes ? ' (Yüksek çözünürlük)' : ''}`, 'success');

                    // Auto-detect jewelry properties
                    try {
                        showToast('🔍 Takı analiz ediliyor...', 'info');
                        const detected = await autoDetectJewelryProperties(state.originalBase64);
                        if (detected) {
                            applyDetectedProperties(detected);
                            // Store for later use in prompts
                            state.detectedProperties = detected;
                        }
                    } catch (err) {
                        console.warn('Auto-detect atlandı:', err);
                    }
                };
                img.src = state.originalBase64;
            };
            reader.readAsDataURL(file);
        }

        // ========== JEWELRY CATEGORY SELECTION ==========
        const categoryDescriptions = {
            general: "Standart takı çekimleri için genel modeller",
            minimal: "İnce zincir, küçük pendant, minimalist parçalar için optimize edilmiş",
            statement: "Büyük, gösterişli, dikkat çekici takılar için geniş kadraj",
            pearl: "İnci parlaklığı ve yansıması için özel yumuşak aydınlatma"
        };

        function selectJewelryCategory(category) {
            state.settings.jewelryCategory = category;

            // Update category tabs
            document.querySelectorAll('.jewelry-cat-btn').forEach(btn => {
                if (btn.dataset.cat === category) {
                    btn.classList.add('active', 'bg-purple-600', 'text-white');
                    btn.classList.remove('text-slate-400');
                } else {
                    btn.classList.remove('active', 'bg-purple-600', 'text-white');
                    btn.classList.add('text-slate-400');
                }
            });

            // Show/hide model cards based on category
            document.querySelectorAll('.model-card').forEach(card => {
                if (card.dataset.category === category) {
                    card.classList.remove('hidden');
                } else {
                    card.classList.add('hidden');
                }
            });

            // Update category description
            document.getElementById('categoryDesc').textContent = categoryDescriptions[category];

            // Auto-select first model in category
            const firstModel = document.querySelector(`.model-card[data-category="${category}"]`);
            if (firstModel) {
                const modelKey = firstModel.dataset.model;
                selectModelProfile(modelKey);
            }
        }

        // ========== NECKLACE LENGTH SELECTION ==========
        const necklaceLengthConfig = {
            choker: {
                name: 'Choker',
                cm: '35-40cm',
                framing: 'Close-up from chin to upper chest. Necklace sits tight around neck.',
                placement: 'Necklace wraps tightly around the base of neck, sitting at throat level.'
            },
            short: {
                name: 'Kısa',
                cm: '45-50cm',
                framing: 'Frame from chin to mid-chest. Necklace hangs just below collarbone.',
                placement: 'Necklace hangs just below collarbone, pendant at upper chest.'
            },
            medium: {
                name: 'Orta',
                cm: '55-65cm',
                framing: 'Frame from chin to lower chest. Need more chest visible for necklace to hang properly.',
                placement: 'Necklace hangs to mid-chest level, pendant resting at center of chest.'
            },
            long: {
                name: 'Uzun',
                cm: '70cm+',
                framing: 'Wide frame from chin to stomach area. MUST show full chest and upper stomach for long necklace.',
                placement: 'LONG necklace hanging well below chest. Pendant reaches stomach/belly level. DO NOT shorten.'
            }
        };

        // ========== JEWELRY SIZE CONFIG ==========
        const jewelrySizeConfig = {
            small: {
                name: 'Küçük',
                size: '1-2cm',
                desc: 'Small, delicate pendant/charm. Approximately 1-2cm diameter. Dainty and subtle jewelry piece.',
                scaleHint: 'SMALL pendant - should appear as a tiny, delicate accent. About the size of a fingernail.',
                preserveRule: 'This is a SMALL piece - do NOT enlarge it. Keep it dainty and subtle.'
            },
            medium: {
                name: 'Orta',
                size: '2-4cm',
                desc: 'Medium-sized pendant/centerpiece. Approximately 2-4cm diameter. Standard jewelry size.',
                scaleHint: 'MEDIUM pendant - normal jewelry size. About the size of a coin (2-4cm).',
                preserveRule: 'Maintain MEDIUM scale - natural, standard jewelry proportions.'
            },
            large: {
                name: 'Büyük',
                size: '4-7cm',
                desc: 'Large statement pendant. Approximately 4-7cm diameter. Eye-catching centerpiece.',
                scaleHint: 'LARGE pendant - prominent statement piece. About 4-7cm, covering significant chest area.',
                preserveRule: 'This is a LARGE statement piece - preserve its impressive size. Do NOT shrink.'
            },
            xlarge: {
                name: 'Çok Büyük',
                size: '7cm+',
                desc: 'Extra large/oversized jewelry. 7cm+ diameter. Bold statement piece that dominates.',
                scaleHint: 'EXTRA LARGE jewelry - oversized statement. 7cm+ spread, covering large chest area.',
                preserveRule: 'OVERSIZED piece - MUST remain very large. Do NOT reduce. This is intentionally big.'
            }
        };

        function selectJewelrySize(size) {
            state.settings.jewelrySize = size;

            // Update buttons
            document.querySelectorAll('.jewelry-size-btn').forEach(btn => {
                if (btn.dataset.size === size) {
                    btn.classList.add('active');
                    btn.classList.remove('text-slate-400');
                } else {
                    btn.classList.remove('active');
                    btn.classList.add('text-slate-400');
                }
            });

            const config = jewelrySizeConfig[size];
            showToast(`${config.name} boyut (${config.size}) seçildi`, 'success');
        }

        function selectNecklaceLength(length) {
            state.settings.necklaceLength = length;

            // Update buttons
            document.querySelectorAll('.necklace-len-btn').forEach(btn => {
                if (btn.dataset.len === length) {
                    btn.classList.add('active');
                    btn.classList.remove('text-slate-400');
                } else {
                    btn.classList.remove('active');
                    btn.classList.add('text-slate-400');
                }
            });

            const config = necklaceLengthConfig[length];
            showToast(`${config.name} kolye (${config.cm}) seçildi`, 'success');
        }

        // ========== AUTO-DETECT JEWELRY PROPERTIES ==========
        async function autoDetectJewelryProperties(imageBase64) {
            const geminiKey = localStorage.getItem('gemini_api_key');
            if (!geminiKey) return null;

            console.log('🔍 Takı özellikleri otomatik analiz ediliyor...');

            const analysisPrompt = `You are a jewelry expert. Analyze this jewelry image VERY CAREFULLY.

CRITICAL: Look at WHERE the necklace sits on the body/mannequin to determine length.
- If pendant reaches MID-CHEST or BELOW = "medium" or "long"
- If necklace sits TIGHT at throat = "choker"
- If just below collarbone = "short"

ANALYZE THESE PROPERTIES:

1. NECKLACE LENGTH (based on WHERE it hangs on body):
   - "choker": Tight around throat only (35-40cm)
   - "short": Just at/below collarbone (45-50cm)
   - "medium": Pendant at MID-CHEST level (55-65cm) ← MOST COMMON
   - "long": Pendant at LOWER chest or stomach (70cm+)

   🔍 TIP: If you see a pendant hanging at chest level, it's AT LEAST "medium"!

2. PENDANT/CENTERPIECE SIZE (compare to neck width):
   - "small": Smaller than 2cm, tiny delicate charm
   - "medium": About 2-4cm, standard pendant
   - "large": 4-7cm, prominent statement piece ← Faceted stones are usually LARGE
   - "xlarge": Bigger than 7cm, oversized

   🔍 TIP: Faceted gemstone pendants (like tiger eye, crystal) are usually "large"!

3. MULTI-LAYER: Does it have 2 or more separate chains/rows?
   - Multi-layer necklaces need MORE vertical space on model
   - If multi-layer AND one chain hangs lower = use the LONGEST chain's length

4. TOTAL VERTICAL SPREAD: How much vertical space does the entire piece occupy?
   - This affects how much of the model's chest needs to be visible

Return ONLY this JSON:
{
  "length": "choker|short|medium|long",
  "size": "small|medium|large|xlarge",
  "multiLayer": true|false,
  "layerCount": 1|2|3,
  "verticalSpread": "compact|moderate|wide|very_wide",
  "confidence": "high|medium|low"
}`;

            try {
                const response = await fetch(`${GEMINI_CONFIG.baseUrl}/${GEMINI_CONFIG.textModel}:generateContent?key=${geminiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: analysisPrompt },
                                { inlineData: { mimeType: 'image/jpeg', data: imageBase64.split(',')[1] } }
                            ]
                        }],
                        generationConfig: {
                            temperature: 0.1,
                            maxOutputTokens: 200
                        }
                    })
                });

                if (!response.ok) {
                    console.warn('Auto-detect API hatası');
                    return null;
                }

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';

                // Extract JSON from response
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const result = JSON.parse(jsonMatch[0]);
                    console.log('✅ Otomatik analiz sonucu:', result);
                    return result;
                }
            } catch (err) {
                console.warn('Auto-detect parse hatası:', err);
            }
            return null;
        }

        // Apply detected properties to UI
        function applyDetectedProperties(detected) {
            if (!detected) return;

            let finalLength = detected.length;
            let finalSize = detected.size;

            // Multi-layer necklaces need extra space - bump up length if needed
            if (detected.multiLayer && detected.layerCount >= 2) {
                // If detected as short but multi-layer, upgrade to medium
                if (finalLength === 'short') finalLength = 'medium';
                // If detected as medium but very wide spread, upgrade to long
                if (finalLength === 'medium' && detected.verticalSpread === 'very_wide') {
                    finalLength = 'long';
                }
                console.log(`📏 Çift sıra kolye tespit edildi - uzunluk: ${finalLength}`);
            }

            // Wide vertical spread needs more framing
            if (detected.verticalSpread === 'wide' || detected.verticalSpread === 'very_wide') {
                if (finalLength === 'short') finalLength = 'medium';
                if (finalLength === 'medium' && detected.verticalSpread === 'very_wide') {
                    finalLength = 'long';
                }
            }

            // Update necklace length
            if (finalLength && necklaceLengthConfig[finalLength]) {
                selectNecklaceLength(finalLength);
            }

            // Update jewelry size
            if (finalSize && jewelrySizeConfig[finalSize]) {
                selectJewelrySize(finalSize);
            }

            // Store enhanced detection info
            state.detectedProperties = {
                ...detected,
                adjustedLength: finalLength,
                adjustedSize: finalSize
            };

            // Show detection result
            const lengthName = necklaceLengthConfig[finalLength]?.name || finalLength;
            const sizeName = jewelrySizeConfig[finalSize]?.name || finalSize;
            const multiLayerText = detected.multiLayer ? ` (${detected.layerCount} sıra)` : '';
            showToast(`🔍 Tespit: ${lengthName} kolye${multiLayerText}, ${sizeName} boyut`, 'info');
        }

        // ========== MODEL PROFILE SELECTION ==========
        function selectModelProfile(profile) {
            state.settings.modelProfile = profile;

            // Only update visible cards
            document.querySelectorAll('.model-card:not(.hidden)').forEach(c => c.classList.remove('selected'));
            document.querySelector(`[data-model="${profile}"]`)?.classList.add('selected');

            document.getElementById('modelProfileDesc').innerHTML =
                '<i class="fa-solid fa-info-circle mr-1"></i>' + modelProfiles[profile].info;
        }

        // ========== STYLE SELECTION ==========
        function selectStyle(style) {
            state.settings.style = style;

            document.querySelectorAll('.style-card').forEach(c => c.classList.remove('selected'));
            document.querySelector(`[data-style="${style}"]`)?.classList.add('selected');

            showToast(`${style.charAt(0).toUpperCase() + style.slice(1)} stili seçildi`, 'success');
        }

        // ========== POSE SELECTION ==========
        function selectPose(pose) {
            state.settings.pose = pose;

            document.querySelectorAll('.pose-card').forEach(c => c.classList.remove('selected'));
            document.querySelector(`[data-pose="${pose}"]`)?.classList.add('selected');

            const poseName = posePresets[pose]?.name || pose;
            showToast(`${poseName} pozu seçildi`, 'success');
        }

        // ========== OUTFIT & SCENE SELECTION ==========
        function selectOutfit(outfit) {
            state.settings.outfit = outfit;

            document.querySelectorAll('.outfit-card').forEach(c => c.classList.remove('selected'));
            document.querySelector(`[data-outfit="${outfit}"]`)?.classList.add('selected');

            const outfitName = outfitPresets[outfit]?.name || outfit;
            showToast(`${outfitName} kıyafeti seçildi`, 'success');
        }

        function selectScene(scene) {
            state.settings.scene = scene;

            document.querySelectorAll('.scene-card').forEach(c => c.classList.remove('selected'));
            document.querySelector(`[data-scene="${scene}"]`)?.classList.add('selected');

            const sceneName = scenePresets[scene]?.name || scene;
            showToast(`${sceneName} sahnesi seçildi`, 'success');
        }

        function toggleAutoOutfit() {
            state.settings.autoOutfit = !state.settings.autoOutfit;

            const btn = document.getElementById('autoOutfitBtn');
            const dot = document.getElementById('autoOutfitDot');
            const manualSection = document.getElementById('manualOutfitSection');
            const autoResult = document.getElementById('autoOutfitResult');

            if (state.settings.autoOutfit) {
                btn.classList.remove('bg-slate-600');
                btn.classList.add('bg-pink-600');
                dot.classList.remove('bg-slate-400', 'left-0.5');
                dot.classList.add('bg-white', 'left-5');
                manualSection.classList.add('hidden');
                autoResult.classList.remove('hidden');
                showToast('AI otomatik öneri aktif', 'success');
            } else {
                btn.classList.add('bg-slate-600');
                btn.classList.remove('bg-pink-600');
                dot.classList.add('bg-slate-400', 'left-0.5');
                dot.classList.remove('bg-white', 'left-5');
                manualSection.classList.remove('hidden');
                autoResult.classList.add('hidden');
                showToast('Manuel seçim aktif', 'success');
            }
        }

        // ========== AKILLI PROMPT SİSTEMİ ==========

        // Hızlı tag ekleme
        function addSmartPrompt(text) {
            const input = document.getElementById('smartPromptInput');
            const current = input.value.trim();
            if (current) {
                input.value = current + ', ' + text;
            } else {
                input.value = text;
            }
            showToast(`"${text}" eklendi`, 'success');
        }

        // Akıllı prompt'u parse et ve talimat oluştur
        function getSmartPromptInstructions() {
            const smartPrompt = document.getElementById('smartPromptInput')?.value?.trim() || '';

            if (!smartPrompt) {
                return ''; // Boş ise ek talimat yok
            }

            // Türkçe komutları analiz et
            const instructions = [];
            const lowerPrompt = smartPrompt.toLowerCase();

            // ===== ZOOM / FRAMING =====
            if (lowerPrompt.includes('yakın') || lowerPrompt.includes('close') || lowerPrompt.includes('yaklaştır')) {
                instructions.push('FRAMING: Close-up shot, jewelry fills 60-70% of frame, model visible from shoulders to chin only');
            }
            if (lowerPrompt.includes('uzak') || lowerPrompt.includes('uzaklaştır') || lowerPrompt.includes('tam boy') || lowerPrompt.includes('full')) {
                instructions.push('FRAMING: Full body or waist-up shot, model clearly visible with jewelry as focal point');
            }
            if (lowerPrompt.includes('çok yakın') || lowerPrompt.includes('macro') || lowerPrompt.includes('detay')) {
                instructions.push('FRAMING: Extreme close-up, jewelry fills 80% of frame, only neck/chest visible');
            }

            // ===== CAMERA ANGLE (PRIORITY INSTRUCTIONS) =====
            if (lowerPrompt.includes('sağ') || lowerPrompt.includes('right') || lowerPrompt.includes('sağdan')) {
                instructions.push('⚠️ CAMERA ANGLE [MANDATORY]: Position camera to the RIGHT of the model. Model body faces slightly LEFT (30-45 degrees). This is a 3/4 RIGHT side view. DO NOT use front view. The right side of the jewelry and model must be more visible.');
            }
            if (lowerPrompt.includes('sol') || lowerPrompt.includes('left') || lowerPrompt.includes('soldan')) {
                instructions.push('⚠️ CAMERA ANGLE [MANDATORY]: Position camera to the LEFT of the model. Model body faces slightly RIGHT (30-45 degrees). This is a 3/4 LEFT side view. DO NOT use front view. The left side of the jewelry and model must be more visible.');
            }
            if (lowerPrompt.includes('profil') || lowerPrompt.includes('profile') || lowerPrompt.includes('yandan')) {
                instructions.push('⚠️ CAMERA ANGLE [MANDATORY]: Pure SIDE PROFILE view - model facing 90 degrees to camera. Show the silhouette of face/neck. Jewelry visible from the side.');
            }
            if (lowerPrompt.includes('önden') || lowerPrompt.includes('front') || lowerPrompt.includes('karşıdan')) {
                instructions.push('⚠️ CAMERA ANGLE [MANDATORY]: Straight FRONT-FACING shot. Model looking directly at camera. Symmetrical view of jewelry.');
            }
            if (lowerPrompt.includes('yukarıdan') || lowerPrompt.includes('üstten') || lowerPrompt.includes('top')) {
                instructions.push('⚠️ CAMERA ANGLE [MANDATORY]: HIGH ANGLE shot - camera positioned ABOVE looking DOWN at the model and jewelry.');
            }
            if (lowerPrompt.includes('aşağıdan') || lowerPrompt.includes('alttan') || lowerPrompt.includes('low')) {
                instructions.push('⚠️ CAMERA ANGLE [MANDATORY]: LOW ANGLE shot - camera positioned BELOW looking UP at the model. Dramatic upward perspective.');
            }

            // ===== OUTFIT COLOR =====
            const colorMap = {
                'siyah': 'black', 'beyaz': 'white', 'kırmızı': 'red', 'mor': 'purple',
                'mavi': 'navy blue', 'yeşil': 'forest green', 'pembe': 'pink', 'bordo': 'burgundy',
                'bej': 'beige', 'krem': 'cream', 'altın': 'gold', 'gümüş': 'silver',
                'nude': 'nude/skin tone', 'lacivert': 'navy', 'turuncu': 'orange', 'sarı': 'yellow'
            };

            for (const [tr, en] of Object.entries(colorMap)) {
                if (lowerPrompt.includes(`kıyafet ${tr}`) || lowerPrompt.includes(`${tr} kıyafet`) ||
                    lowerPrompt.includes(`elbise ${tr}`) || lowerPrompt.includes(`${tr} elbise`)) {
                    instructions.push(`OUTFIT COLOR: Model wearing elegant ${en} clothing that complements the jewelry`);
                    break;
                }
            }

            // ===== OUTFIT STYLE =====
            if (lowerPrompt.includes('straplez') || lowerPrompt.includes('strapless') || lowerPrompt.includes('askısız')) {
                instructions.push('OUTFIT STYLE: Strapless top/dress, completely bare shoulders, perfect for showcasing necklaces');
            }
            if (lowerPrompt.includes('v yaka') || lowerPrompt.includes('v-neck')) {
                instructions.push('OUTFIT STYLE: V-neck top, elegant neckline that frames the jewelry');
            }
            if (lowerPrompt.includes('yuvarlak yaka') || lowerPrompt.includes('crew') || lowerPrompt.includes('round')) {
                instructions.push('OUTFIT STYLE: Round/crew neck top, classic and elegant');
            }
            if (lowerPrompt.includes('omuz açık') || lowerPrompt.includes('off-shoulder') || lowerPrompt.includes('düşük omuz')) {
                instructions.push('OUTFIT STYLE: Off-shoulder top, romantic and elegant, showcases collarbone area');
            }

            // ===== MODEL APPEARANCE =====
            if (lowerPrompt.includes('sarışın') || lowerPrompt.includes('blonde')) {
                instructions.push('MODEL: Blonde hair, elegant appearance');
            }
            if (lowerPrompt.includes('esmer') || lowerPrompt.includes('brunette') || lowerPrompt.includes('koyu saç')) {
                instructions.push('MODEL: Dark/brunette hair, sophisticated look');
            }
            if (lowerPrompt.includes('kızıl') || lowerPrompt.includes('red hair') || lowerPrompt.includes('auburn')) {
                instructions.push('MODEL: Auburn/red hair, striking appearance');
            }
            if (lowerPrompt.includes('kısa saç') || lowerPrompt.includes('short hair')) {
                instructions.push('MODEL: Short hair, modern and chic style');
            }
            if (lowerPrompt.includes('uzun saç') || lowerPrompt.includes('long hair')) {
                instructions.push('MODEL: Long flowing hair, elegant and feminine');
            }
            if (lowerPrompt.includes('topuz') || lowerPrompt.includes('bun') || lowerPrompt.includes('updo')) {
                instructions.push('MODEL: Hair in elegant updo/bun, neck fully visible for jewelry display');
            }

            // ===== SCENE / LIGHTING =====
            if (lowerPrompt.includes('altın saat') || lowerPrompt.includes('golden hour') || lowerPrompt.includes('gün batımı')) {
                instructions.push('LIGHTING: Golden hour warm lighting, soft orange/gold tones, romantic atmosphere');
            }
            if (lowerPrompt.includes('karanlık') || lowerPrompt.includes('dark') || lowerPrompt.includes('moody')) {
                instructions.push('LIGHTING: Dark moody studio, dramatic shadows, luxury feel, black/charcoal background');
            }
            if (lowerPrompt.includes('parlak') || lowerPrompt.includes('bright') || lowerPrompt.includes('aydınlık')) {
                instructions.push('LIGHTING: Bright, high-key lighting, clean and fresh look');
            }
            if (lowerPrompt.includes('stüdyo') || lowerPrompt.includes('studio')) {
                instructions.push('LIGHTING: Professional studio lighting, soft boxes, clean gradient background');
            }
            if (lowerPrompt.includes('doğal ışık') || lowerPrompt.includes('natural light') || lowerPrompt.includes('pencere')) {
                instructions.push('LIGHTING: Natural window light, soft and flattering, lifestyle feel');
            }

            // ===== BACKGROUND =====
            if (lowerPrompt.includes('arka plan siyah') || lowerPrompt.includes('siyah arka') || lowerPrompt.includes('black background')) {
                instructions.push('BACKGROUND: Pure black or very dark charcoal background, luxury feel');
            }
            if (lowerPrompt.includes('arka plan beyaz') || lowerPrompt.includes('beyaz arka') || lowerPrompt.includes('white background')) {
                instructions.push('BACKGROUND: Clean pure white background, e-commerce standard');
            }
            if (lowerPrompt.includes('arka plan gri') || lowerPrompt.includes('gri arka') || lowerPrompt.includes('gray background')) {
                instructions.push('BACKGROUND: Neutral gray gradient background, professional look');
            }
            if (lowerPrompt.includes('doğa') || lowerPrompt.includes('outdoor') || lowerPrompt.includes('dış mekan')) {
                instructions.push('BACKGROUND: Outdoor/nature setting, soft bokeh, natural environment');
            }

            // ===== MOOD / STYLE =====
            if (lowerPrompt.includes('romantik') || lowerPrompt.includes('romantic')) {
                instructions.push('MOOD: Romantic and dreamy atmosphere, soft focus, warm tones');
            }
            if (lowerPrompt.includes('lüks') || lowerPrompt.includes('luxury') || lowerPrompt.includes('premium')) {
                instructions.push('MOOD: Luxury high-end feel, sophisticated, premium quality aesthetic');
            }
            if (lowerPrompt.includes('minimal') || lowerPrompt.includes('sade')) {
                instructions.push('MOOD: Minimalist and clean, simple composition, focus on jewelry');
            }
            if (lowerPrompt.includes('editorial') || lowerPrompt.includes('dergi')) {
                instructions.push('MOOD: Editorial/magazine style, artistic, high fashion feel');
            }

            // Eğer hiçbir pattern match olmadıysa, raw prompt'u gönder
            if (instructions.length === 0 && smartPrompt) {
                instructions.push(`CUSTOM REQUEST: ${smartPrompt}`);
            }

            // Tümünü birleştir
            if (instructions.length > 0) {
                return `\n\n===== USER'S SMART PROMPT INSTRUCTIONS =====\n${instructions.join('\n')}\n\nIMPORTANT: Apply these customizations to the MODEL, OUTFIT, SCENE, and CAMERA only.\nThe JEWELRY must remain 100% IDENTICAL to the original - never modify the product!\n==============================================`;
            }

            return '';
        }

        function getOutfitScenePrompt() {
            if (state.settings.autoOutfit) {
                // AI will analyze the jewelry and choose appropriate outfit/scene
                return `
OUTFIT & SCENE INSTRUCTIONS:
Analyze the jewelry's style, color, and aesthetic. Then choose the most complementary:
- Outfit: Choose clothing color and neckline that best showcases this specific jewelry
- Scene: Choose lighting and background that enhances the jewelry's appeal
Make choices that create harmony without distracting from the jewelry.
The jewelry must remain EXACTLY as provided - only the model's outfit and scene should complement it.`;
            } else {
                const outfit = outfitPresets[state.settings.outfit];
                const scene = scenePresets[state.settings.scene];
                return `
OUTFIT & SCENE INSTRUCTIONS:
${outfit?.prompt || ''}
${scene?.prompt || ''}
The jewelry must remain EXACTLY as provided - do not modify the jewelry in any way.`;
            }
        }

        // ========== MAIN IMAGE GENERATION - GEMINI 2.5 ONLY ==========
        async function generateImage() {
            const geminiKey = localStorage.getItem('gemini_api_key');
            if (!geminiKey) {
                openSettings();
                showToast('Lütfen Gemini API Key girin', 'error');
                return;
            }

            if (!state.originalBase64) {
                showToast('Önce bir ürün yükleyin', 'error');
                return;
            }

            showLoader('Stüdyo Pro...', '1/3 Ürün çıkarılıyor');

            try {
                // Tek mod: Halüsinasyonsuz Stüdyo Pro
                console.log('🎯 Stüdyo Pro - Halüsinasyonsuz mod başlatılıyor...');
                state.processedImage = await generateWithGemini25();

                // STUDIO ENHANCE - Fal.ai ile kalite artırma
                console.log('🎬 Stüdyo kalitesi uygulanıyor...');
                state.processedImage = await studioEnhance(state.processedImage);

                // Orijinal processed image'ı sakla (rötuş için)
                state.originalProcessedImage = state.processedImage;

                // Show result
                document.getElementById('previewPlaceholder').classList.add('hidden');
                document.getElementById('previewImage').classList.remove('hidden');
                document.getElementById('previewImage').src = state.processedImage;
                document.getElementById('downloadActions').classList.remove('hidden');

                // Manuel düzenleme panelini göster
                document.getElementById('editPanel').classList.remove('hidden');

                hideLoader();
                showToast('Stüdyo kalitesinde görsel hazır!', 'success');

                // Otomatik SEO oluştur
                generateSEO();

            } catch (error) {
                console.error('Generation error:', error);
                hideLoader();
                showToast('Hata: ' + error.message, 'error');
            }
        }

        // ========== FLATLAY MODE - DÜZ ZEMİNDEN MODELE ==========
        async function generateFlatlayMode() {
            const geminiKey = localStorage.getItem('gemini_api_key');
            const falKey = localStorage.getItem('fal_api_key');
            const profile = modelProfiles[state.settings.modelProfile];
            const style = stylePresets[state.settings.style];
            const pose = posePresets[state.settings.pose];

            // STEP 1: BiRefNet ile takıyı arka plandan ayır
            console.log('✂️ ADIM 1: BiRefNet ile takı çıkarılıyor...');
            showLoader('Düz Zemin Modu...', '1/3 Takı çıkarılıyor');

            if (!falKey) {
                throw new Error('Fal.ai API key gerekli - Düz zemin modu için BiRefNet lazım');
            }

            const birefnetResponse = await fetch('https://fal.run/fal-ai/birefnet', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Key ${falKey}`
                },
                body: JSON.stringify({
                    image_url: state.originalBase64,
                    model: "General Use (Light)",
                    operating_resolution: state.isHighRes ? "2048x2048" : "1024x1024",
                    output_format: "png"
                })
            });

            if (!birefnetResponse.ok) {
                const err = await birefnetResponse.json();
                throw new Error('BiRefNet hatası: ' + (err.detail || 'Arka plan kaldırılamadı'));
            }

            const birefnetData = await birefnetResponse.json();
            const transparentJewelryUrl = birefnetData.image?.url;
            if (!transparentJewelryUrl) {
                throw new Error('Takı çıkarılamadı');
            }
            console.log('✅ Takı şeffaf arka planla çıkarıldı');

            // STEP 2: Gemini ile model + takı görseli oluştur
            console.log('🎨 ADIM 2: Gemini ile model oluşturuluyor...');
            showLoader('Düz Zemin Modu...', '2/3 Model oluşturuluyor');

            // Takıyı base64'e çevir
            const jewelryBase64 = await fetchImageAsBase64(transparentJewelryUrl);

            // ========== ŞABLON MODU: Canvas Composite (Hallucination YOK) ==========
            if (state.templateBase64) {
                console.log('📐 ŞABLON MODU: Canvas composite başlatılıyor...');
                showLoader('Şablon Modu...', '2/3 Takı yerleştiriliyor');

                // Canvas ile takıyı şablona yerleştir (client-side, AI yok)
                const compositeResult = await compositeJewelryOnTemplate(jewelryBase64, state.templateBase64);

                // AI'ya sadece kenarları yumuşatmasını söyle
                showLoader('Şablon Modu...', '3/3 Kenarlar yumuşatılıyor');

                const blendPrompt = `Enhance this jewelry product photo. The jewelry is already correctly placed.

YOUR ONLY TASKS:
1. Blend the jewelry edges naturally with the skin (soft, seamless transition)
2. Add realistic soft shadows under the jewelry
3. Make the lighting consistent across the entire image
4. Enhance skin texture slightly for realism

ABSOLUTELY DO NOT:
- Change the jewelry design, shape, color, or details
- Move or reposition the jewelry
- Modify the jewelry in ANY way
- Change the composition or framing

The jewelry placement is FINAL. Only enhance the blending and overall image quality.`;

                const blendResponse = await fetch(`${GEMINI_CONFIG.baseUrl}/${GEMINI_CONFIG.imageModel}:generateContent?key=${geminiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: blendPrompt },
                                { inlineData: { mimeType: 'image/png', data: compositeResult.split(',')[1] } }
                            ]
                        }],
                        generationConfig: {
                            responseModalities: ["IMAGE", "TEXT"],
                            temperature: 0.2
                        }
                    })
                });

                if (blendResponse.ok) {
                    const blendData = await blendResponse.json();
                    const blendParts = blendData.candidates?.[0]?.content?.parts || [];
                    for (const part of blendParts) {
                        if (part.inlineData?.mimeType?.startsWith('image/')) {
                            console.log('✅ Şablon modu + AI blend tamamlandı!');
                            return `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
                        }
                    }
                }

                // AI başarısız olursa composite'i döndür
                console.log('⚠️ AI blend atlandı, composite döndürülüyor');
                return compositeResult;
            }

            // ========== ŞABLON YOK: Yeni Güvenli Mod ==========
            // ADIM 1: Gemini sadece model/kıyafet/sahne oluşturur (takı YOK)
            // ADIM 2: Canvas ile orijinal takıyı üzerine yerleştiririz
            console.log('🎨 ADIM 2a: Gemini ile takısız model oluşturuluyor...');
            showLoader('Düz Zemin Modu...', '2/4 Model oluşturuluyor');

            const outfitSceneInstructions = getOutfitScenePrompt();
            const smartPromptInstructions = getSmartPromptInstructions();

            // Smart prompt'ta açı var mı kontrol et
            const hasAngleInstruction = smartPromptInstructions.includes('CAMERA ANGLE:');

            // Kolye uzunluğu ayarları
            const neckLenConfig = necklaceLengthConfig[state.settings.necklaceLength] || necklaceLengthConfig.short;

            // Takı boyutu ayarları
            const sizeConfig = jewelrySizeConfig[state.settings.jewelrySize] || jewelrySizeConfig.medium;

            // Çift sıra/katmanlı kolye kontrolü
            const isMultiLayer = state.detectedProperties?.multiLayer || false;
            const layerCount = state.detectedProperties?.layerCount || 1;
            const verticalSpread = state.detectedProperties?.verticalSpread || 'moderate';

            // Takısız model oluşturma prompt'u - KESINLIKLE TAKISIZ
            const modelOnlyPrompt = `Generate a professional model photo for jewelry product photography.

🚨🚨🚨 ABSOLUTELY NO JEWELRY 🚨🚨🚨
The model must NOT wear ANY jewelry:
- NO necklaces
- NO earrings
- NO bracelets
- NO rings
- COMPLETELY BARE neck and chest area
- The jewelry will be added LATER via digital editing

${smartPromptInstructions ? `USER CUSTOM INSTRUCTIONS (PRIORITY):\n${smartPromptInstructions}\n` : ''}

MODEL REQUIREMENTS:
- ${profile.desc}
- ${outfitSceneInstructions}
- Professional studio lighting
- BARE neck - absolutely no accessories

🚫 MODESTY RULES:
- CONSERVATIVE clothing only - NO low-cut, NO deep V-neck, NO cleavage
- High neckline or modest V-neck that covers chest appropriately
- This is for e-commerce, must be FAMILY-FRIENDLY
- Think: department store catalog style

FACE & FRAMING:
- Natural "headless crop" from above eyebrows preferred
- Show enough chest/body area for necklace placement
- Clear, unobstructed neck area

POSE: ${pose?.prompt || 'Front facing, clear view of neck area'}
${hasAngleInstruction ? 'Use the CAMERA ANGLE from USER CUSTOM INSTRUCTIONS' : ''}

⛔ FORBIDDEN - ZERO TOLERANCE:
- ANY jewelry whatsoever
- ANY necklace or chain
- ANY accessories on neck/chest
- The neck MUST be completely bare

OUTPUT: Professional model photo with COMPLETELY BARE neck, ready for jewelry overlay.`;

            // NOT: Takı görselini GÖNDERMİYORUZ - AI görünce kopyalıyor!
            const modelResponse = await fetch(`${GEMINI_CONFIG.baseUrl}/${GEMINI_CONFIG.imageModel}:generateContent?key=${geminiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: modelOnlyPrompt }
                            // Takı görseli YOK - AI kopyalamasın diye
                        ]
                    }],
                    generationConfig: {
                        responseModalities: ["IMAGE", "TEXT"],
                        temperature: 0.3  // Düşük = daha az yaratıcılık
                    }
                })
            });

            if (!modelResponse.ok) {
                const err = await modelResponse.json();
                throw new Error(err.error?.message || 'Model oluşturulamadı');
            }

            const modelData = await modelResponse.json();
            const modelParts = modelData.candidates?.[0]?.content?.parts || [];
            let modelImageBase64 = null;

            for (const part of modelParts) {
                if (part.inlineData?.mimeType?.startsWith('image/')) {
                    modelImageBase64 = `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
                    break;
                }
            }

            if (!modelImageBase64) {
                throw new Error('Model görseli oluşturulamadı');
            }

            console.log('✅ Takısız model oluşturuldu');

            // ADIM 2b: Gemini Edit ile takıyı model üzerine doğal yerleştir
            console.log('💎 ADIM 2b: Gemini Edit ile takı yerleştiriliyor...');
            showLoader('Düz Zemin Modu...', '3/3 Takı yerleştiriliyor');

            // Kıyafet ve sahne bilgilerini al
            const outfit = outfitPresets[state.settings.outfit];
            const scene = scenePresets[state.settings.scene];

            // ÖNEMLİ: 3 GÖRSEL GÖNDERİYORUZ - Orijinal boyut referansı için
            const placeJewelryPrompt = `You have THREE input images:
[Input Image 1] = ORIGINAL photo showing the jewelry - USE THIS FOR SCALE REFERENCE!
[Input Image 2] = EXTRACTED jewelry with transparent background - USE THIS FOR EXACT DETAILS
[Input Image 3] = Generated model (no jewelry) - PLACE JEWELRY HERE

🚨🚨🚨 CRITICAL SCALE INSTRUCTION 🚨🚨🚨

Look at [Input Image 1] (the ORIGINAL):
- See how LARGE the jewelry appears in the original context?
- See how FAR DOWN the necklace hangs?
- See how WIDE the pendant is?

THE JEWELRY ON [Input Image 3] MUST HAVE THE EXACT SAME PROPORTIONS!

[STEP-BY-STEP PROCESS]
1. In [Input Image 1], measure: What % of the visible area does the jewelry cover vertically?
2. In [Input Image 1], measure: What % of the width does the jewelry span?
3. Apply these EXACT SAME proportions to [Input Image 3]!

Example: If necklace covers 60% of visible chest in Image 1 → It MUST cover 60% of visible chest in Image 3.

[USE IMAGE 2 FOR]
• Exact jewelry details (every bead, link, stone)
• Colors and textures
• Shape accuracy

[COPY FROM ORIGINAL - Image 1]
• SCALE and SIZE relative to body
• How far down it hangs
• Width relative to neck/shoulders
• Chain drape and curvature

[ABSOLUTE RULES] ⚠️
• The pendant in output must be SAME SIZE as in original (Image 1)
• The chain must hang to the SAME LEVEL as in original
• Multi-layer spacing must match original
• If anything, err on the side of LARGER

[FORBIDDEN - ZERO TOLERANCE] ❌
• NEVER shrink the jewelry compared to original
• NEVER make pendant smaller than original
• NEVER shorten the necklace compared to original
• NEVER compress chain spacing

OUTPUT: Jewelry on model at EXACT SAME SCALE as seen in [Input Image 1].`;

            const placeResponse = await fetch(`${GEMINI_CONFIG.baseUrl}/${GEMINI_CONFIG.imageModel}:generateContent?key=${geminiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: placeJewelryPrompt },
                            // Image 1: ORIGINAL - boyut referansı için
                            { inlineData: { mimeType: 'image/jpeg', data: state.originalBase64.split(',')[1] } },
                            // Image 2: BiRefNet çıktısı - detay için
                            { inlineData: { mimeType: 'image/png', data: jewelryBase64.split(',')[1] } },
                            // Image 3: Üretilen model
                            { inlineData: { mimeType: 'image/png', data: modelImageBase64.split(',')[1] } }
                        ]
                    }],
                    generationConfig: {
                        responseModalities: ["IMAGE", "TEXT"],
                        temperature: 0.1
                    }
                })
            });

            if (!placeResponse.ok) {
                const err = await placeResponse.json();
                throw new Error(err.error?.message || 'Takı yerleştirilemedi');
            }

            const placeData = await placeResponse.json();
            const placeParts = placeData.candidates?.[0]?.content?.parts || [];

            for (const part of placeParts) {
                if (part.inlineData?.mimeType?.startsWith('image/')) {
                    console.log('✅ Flatlay modu tamamlandı (Gemini Edit)!');
                    return `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
                }
            }

            throw new Error('Görsel üretilemedi');
        }

        // ========== SADECE ÜRÜN MODU - HALÜSİNASYON-FREE ==========
        // 1. BiRefNet ile ürünü çıkar (orijinal korunur)
        // 2. Gemini ile temiz arka plan oluştur (model yok)
        // 3. Orijinal ürünü arka plana yerleştir
        async function generateProductOnlyMode() {
            const geminiKey = localStorage.getItem('gemini_api_key');
            const falKey = localStorage.getItem('fal_api_key');
            const style = stylePresets[state.settings.style];

            console.log('✨ Sadece Ürün Modu (Hallucination-Free) başlatılıyor...');

            // ===== ADIM 1: BiRefNet ile ürünü çıkar =====
            showLoader('Sadece Ürün Modu...', '1/3 Ürün çıkarılıyor (BiRefNet)');

            if (!falKey) {
                throw new Error('Fal.ai API key gerekli - Hallucination-free mod için BiRefNet lazım');
            }

            const birefnetResponse = await fetch('https://fal.run/fal-ai/birefnet', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Key ${falKey}`
                },
                body: JSON.stringify({
                    image_url: state.originalBase64,
                    model: "General Use (Light)",
                    operating_resolution: state.isHighRes ? "2048x2048" : "1024x1024",
                    output_format: "png"
                })
            });

            if (!birefnetResponse.ok) {
                const err = await birefnetResponse.json();
                throw new Error('BiRefNet hatası: ' + (err.detail || 'Ürün çıkarılamadı'));
            }

            const birefnetData = await birefnetResponse.json();
            const transparentProductUrl = birefnetData.image?.url;
            if (!transparentProductUrl) {
                throw new Error('Ürün çıkarılamadı');
            }
            console.log('✅ Ürün şeffaf arka planla çıkarıldı');

            const productBase64 = await fetchImageAsBase64(transparentProductUrl);

            // ===== ADIM 2: Gemini ile temiz arka plan oluştur =====
            showLoader('Sadece Ürün Modu...', '2/3 Arka plan oluşturuluyor');

            const smartPromptInstructions = getSmartPromptInstructions();

            // Smart prompt'tan arka plan bilgilerini çıkar
            let backgroundStyle = style.prompt;
            if (smartPromptInstructions.includes('BACKGROUND:')) {
                const bgMatch = smartPromptInstructions.match(/BACKGROUND: ([^\n]+)/);
                if (bgMatch) backgroundStyle = bgMatch[1];
            }
            if (smartPromptInstructions.includes('LIGHTING:')) {
                const lightMatch = smartPromptInstructions.match(/LIGHTING: ([^\n]+)/);
                if (lightMatch) backgroundStyle += '. ' + lightMatch[1];
            }

            const backgroundPrompt = `Create a clean, professional product photography background.

REQUIREMENTS:
- ${backgroundStyle}
- NO jewelry, NO products, NO objects - ONLY background
- Professional studio quality
- Subtle shadows/gradients allowed
- E-commerce ready aesthetic
- Size: Match a jewelry product photo (portrait orientation preferred)

This background will be used for jewelry product photography.
DO NOT include any jewelry or objects - just the empty background/surface.

OUTPUT: Clean, professional background only.`;

            const bgResponse = await fetch(`${GEMINI_CONFIG.baseUrl}/${GEMINI_CONFIG.imageModel}:generateContent?key=${geminiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [{ text: backgroundPrompt }]
                    }],
                    generationConfig: {
                        responseModalities: ["IMAGE", "TEXT"],
                        temperature: 0.5
                    }
                })
            });

            let backgroundBase64 = null;

            if (bgResponse.ok) {
                const bgData = await bgResponse.json();
                const bgParts = bgData.candidates?.[0]?.content?.parts || [];
                for (const part of bgParts) {
                    if (part.inlineData?.mimeType?.startsWith('image/')) {
                        backgroundBase64 = `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
                        break;
                    }
                }
            }

            if (!backgroundBase64) {
                // Fallback: Basit beyaz arka plan
                console.log('⚠️ Arka plan oluşturulamadı, beyaz kullanılıyor');
                const canvas = document.createElement('canvas');
                canvas.width = 1024;
                canvas.height = 1024;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, 1024, 1024);
                backgroundBase64 = canvas.toDataURL('image/png');
            }
            console.log('✅ Arka plan oluşturuldu');

            // ===== ADIM 3: Orijinal ürünü arka plana yerleştir =====
            showLoader('Sadece Ürün Modu...', '3/3 Ürün yerleştiriliyor (Orijinal)');

            const placeProductPrompt = `[TASK] Place the product from [Input Image 1] onto the background in [Input Image 2].

[CRITICAL PRESERVATION CONSTRAINTS] ⚠️ PRIMARY RULE: PRODUCT FIDELITY ⚠️
The product in Input Image 1 MUST remain EXACTLY THE SAME in the final image.
NO re-interpretation, artistic alteration, or modification allowed.

PRESERVE 100%:
• Texture & Material: Exact metal shine, surfaces, details
• Pattern & Color: All colors, hues - no changes
• Form & Shape: Every detail must remain identical
• Size & Scale: Keep ORIGINAL proportions - do NOT resize

[PLACEMENT]
• Center the product naturally on the background
• Add realistic shadows beneath the product
• Match lighting between product and background
• Product should look naturally placed, not floating

[FORBIDDEN ACTIONS] ❌
• Do NOT enlarge or shrink the product
• Do NOT add any human, model, or body parts
• Do NOT simplify any detail
• Do NOT change colors or materials
• Do NOT re-interpret the design

OUTPUT: The product must be PIXEL-PERFECT identical to Input Image 1, naturally placed on the background.`;

            const placeResponse = await fetch(`${GEMINI_CONFIG.baseUrl}/${GEMINI_CONFIG.imageModel}:generateContent?key=${geminiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: placeProductPrompt },
                            { inlineData: { mimeType: 'image/png', data: productBase64.split(',')[1] } },
                            { inlineData: { mimeType: 'image/png', data: backgroundBase64.split(',')[1] } }
                        ]
                    }],
                    generationConfig: {
                        responseModalities: ["IMAGE", "TEXT"],
                        temperature: 0.1
                    }
                })
            });

            if (!placeResponse.ok) {
                const err = await placeResponse.json();
                throw new Error(err.error?.message || 'Ürün yerleştirilemedi');
            }

            const placeData = await placeResponse.json();
            const placeParts = placeData.candidates?.[0]?.content?.parts || [];

            for (const part of placeParts) {
                if (part.inlineData?.mimeType?.startsWith('image/')) {
                    console.log('✅ Sadece Ürün modu tamamlandı (Hallucination-Free)!');
                    return `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
                }
            }

            // Fallback: Şeffaf ürünü döndür
            console.log('⚠️ Yerleştirme başarısız, şeffaf ürün döndürülüyor');
            return productBase64;
        }

        // Helper: URL'den base64'e çevir
        async function fetchImageAsBase64(url) {
            const response = await fetch(url);
            const blob = await response.blob();
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(blob);
            });
        }

        // ========== CANVAS COMPOSITE - TAKILAYI ŞABLONA YERLEŞTİR ==========
        // Client-side işlem, AI yok, hallucination yok
        async function compositeJewelryOnTemplate(jewelryBase64, templateBase64) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                const templateImg = new Image();
                const jewelryImg = new Image();

                let loadedCount = 0;

                const onBothLoaded = () => {
                    loadedCount++;
                    if (loadedCount < 2) return;

                    // Canvas boyutunu şablona göre ayarla
                    canvas.width = templateImg.width;
                    canvas.height = templateImg.height;

                    // 1. Şablonu çiz (arka plan)
                    ctx.drawImage(templateImg, 0, 0);

                    // 2. Takıyı pozisyon ayarlarına göre çiz
                    const pos = state.position;
                    const jewelryWidth = templateImg.width * (pos.scale / 100);
                    const jewelryHeight = (jewelryImg.height / jewelryImg.width) * jewelryWidth;

                    const x = (templateImg.width * (pos.x / 100)) - (jewelryWidth / 2);
                    const y = (templateImg.height * (pos.y / 100)) - (jewelryHeight / 2);

                    // Rotation desteği
                    const rotation = (pos.rotation || 0) * Math.PI / 180;

                    ctx.save();
                    ctx.translate(x + jewelryWidth / 2, y + jewelryHeight / 2);
                    ctx.rotate(rotation);
                    ctx.drawImage(jewelryImg, -jewelryWidth / 2, -jewelryHeight / 2, jewelryWidth, jewelryHeight);
                    ctx.restore();

                    // Canvas'ı base64'e çevir
                    resolve(canvas.toDataURL('image/png'));
                };

                templateImg.onload = onBothLoaded;
                jewelryImg.onload = onBothLoaded;
                templateImg.onerror = () => reject(new Error('Şablon yüklenemedi'));
                jewelryImg.onerror = () => reject(new Error('Takı yüklenemedi'));

                templateImg.src = templateBase64;
                jewelryImg.src = jewelryBase64;
            });
        }

        // ========== GEMINI EDIT MODE - HALÜSİNASYON-FREE ==========
        // 1. BiRefNet ile takıyı çıkar (orijinal korunur)
        // 2. Gemini ile model/sahne oluştur (takısız)
        // 3. Gemini Edit ile orijinal takıyı yerleştir
        async function generateWithGemini25() {
            const geminiKey = localStorage.getItem('gemini_api_key');
            const falKey = localStorage.getItem('fal_api_key');
            const profile = modelProfiles[state.settings.modelProfile];
            const style = stylePresets[state.settings.style];
            const pose = posePresets[state.settings.pose];

            console.log('🎨 Manken Modu (Hallucination-Free) başlatılıyor...');

            // ===== ADIM 1: BiRefNet ile takıyı çıkar =====
            showLoader('Manken Modu...', '1/3 Takı çıkarılıyor (BiRefNet)');

            if (!falKey) {
                throw new Error('Fal.ai API key gerekli - Hallucination-free mod için BiRefNet lazım');
            }

            const birefnetResponse = await fetch('https://fal.run/fal-ai/birefnet', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Key ${falKey}`
                },
                body: JSON.stringify({
                    image_url: state.originalBase64,
                    model: "General Use (Light)",
                    operating_resolution: state.isHighRes ? "2048x2048" : "1024x1024",
                    output_format: "png"
                })
            });

            if (!birefnetResponse.ok) {
                const err = await birefnetResponse.json();
                throw new Error('BiRefNet hatası: ' + (err.detail || 'Takı çıkarılamadı'));
            }

            const birefnetData = await birefnetResponse.json();
            const transparentJewelryUrl = birefnetData.image?.url;
            if (!transparentJewelryUrl) {
                throw new Error('Takı çıkarılamadı');
            }
            console.log('✅ Takı şeffaf arka planla çıkarıldı');

            const jewelryBase64 = await fetchImageAsBase64(transparentJewelryUrl);

            // ===== ADIM 1.5: Takıyı analiz et - boyut ve alan ihtiyacı =====
            showLoader('Manken Modu...', '2/4 Takı analiz ediliyor');
            console.log('🔍 Takı analiz ediliyor...');

            const jewelryAnalysisPrompt = `Analyze this jewelry image and provide specifications for model generation.

Return ONLY a JSON object with these fields:
{
  "type": "necklace/earring/bracelet/ring",
  "length": "choker/short/medium/long/very_long",
  "verticalSpace": "small/medium/large/very_large",
  "width": "narrow/medium/wide",
  "hasLargePendant": true/false,
  "recommendedNeckline": "high/medium/low/deep_v",
  "recommendedFraming": "close_up/medium/wide",
  "description": "brief description"
}

IMPORTANT:
- "very_long" = necklace hangs below chest, needs lots of vertical space
- "long" = hangs to mid-chest
- "medium" = sits at collarbone level
- "short/choker" = sits at neck

Return ONLY the JSON, no other text.`;

            const jewelryBase64Data = jewelryBase64.split(',')[1];
            let jewelryAnalysis = {
                type: 'necklace',
                length: 'medium',
                verticalSpace: 'medium',
                width: 'medium',
                hasLargePendant: false,
                recommendedNeckline: 'medium',
                recommendedFraming: 'medium',
                description: 'standard necklace'
            };

            try {
                const analysisResponse = await fetch(`${GEMINI_CONFIG.baseUrl}/${GEMINI_CONFIG.textModel}:generateContent?key=${geminiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: jewelryAnalysisPrompt },
                                {
                                    inlineData: {
                                        mimeType: 'image/png',
                                        data: jewelryBase64Data
                                    }
                                }
                            ]
                        }],
                        generationConfig: {
                            temperature: 0.1
                        }
                    })
                });

                if (analysisResponse.ok) {
                    const analysisData = await analysisResponse.json();
                    const analysisText = analysisData.candidates?.[0]?.content?.parts?.[0]?.text || '';
                    // JSON'u parse et
                    const jsonMatch = analysisText.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        jewelryAnalysis = { ...jewelryAnalysis, ...JSON.parse(jsonMatch[0]) };
                    }
                }
                console.log('✅ Takı analizi:', jewelryAnalysis);
            } catch (e) {
                console.log('⚠️ Takı analizi başarısız, varsayılan kullanılıyor:', e.message);
            }

            // ===== ADIM 2: Gemini ile model + kolye TEK ADIMDA =====
            // Model ayrı üretip birleştirmek yerine, kolyeyi verip direkt model oluştur
            showLoader('Manken Modu...', '3/3 Model + kolye oluşturuluyor');

            const outfitSceneInstructions = getOutfitScenePrompt();
            const smartPromptInstructions = getSmartPromptInstructions();
            const hasAngleInstruction = smartPromptInstructions.includes('CAMERA ANGLE:');

            const aspectRatio = state.originalWidth && state.originalHeight
                ? (state.originalWidth / state.originalHeight).toFixed(2)
                : 1;
            const isPortrait = aspectRatio < 1;
            const isLandscape = aspectRatio > 1;

            // Takı analizine göre frame ayarları
            const frameSettings = {
                'very_long': { neckline: 'very deep V-neck', frame: 'full torso - chin to waist' },
                'long': { neckline: 'deep V-neck', frame: 'chin to below chest' },
                'medium': { neckline: 'medium V-neck', frame: 'full neck and chest visible' },
                'short': { neckline: 'V-neck', frame: 'neck and upper chest' },
                'choker': { neckline: 'open neckline', frame: 'neck area visible' }
            };
            const frameSetting = frameSettings[jewelryAnalysis.length] || frameSettings.medium;

            // TEK ADIM: Kolyeyi verip model oluştur
            const singleStepPrompt = `Görseldeki kolyeyi/takıyı takan profesyonel bir model fotoğrafı oluştur.

🚨 EN ÖNEMLİ KURAL - MUTLAKA UYULMALI 🚨
Görseldeki kolye BİREBİR AYNI kalmalı:
- AYNI boyut (küçültme/büyütme YOK)
- AYNI renkler (değiştirme YOK)
- AYNI taşlar, boncuklar, zincir detayları
- AYNI pendant/uç kısmı
- Kolyeyi YENİDEN ÜRETME - görseldekini AYNEN kullan

📐 FRAME/ÇERÇEVELEME:
- ${frameSetting.frame}
- Kolye tam görünsün, kesilmesin
- Boyutlar: ${state.originalWidth || 1024}x${state.originalHeight || 1024}

👗 KIYAFET & SAHNE:
- ${frameSetting.neckline} - kolyeyi gösterecek açık yaka
- Kolye kıyafetin üstünde otursun
${outfitSceneInstructions}

👩 MODEL:
- ${profile.desc}
- ${style.prompt}
- Profesyonel stüdyo ışıklandırması

📸 POZ / AÇI:
- ${pose?.prompt || 'Front facing, clear view of neck area'}
- ${hasAngleInstruction ? smartPromptInstructions : ''}

✅ SONUÇ:
- Kolye DOĞAL şekilde boyunda otursun
- Zincir boyunun arkasına doğal kavisli
- Gerçekçi gölgeler
- E-ticaret ürün fotoğrafı kalitesi

TEKRAR: Görseldeki kolyeyi DEĞİŞTİRME, AYNEN koru!`;

            const response = await fetch(`${GEMINI_CONFIG.baseUrl}/${GEMINI_CONFIG.imageModel}:generateContent?key=${geminiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: singleStepPrompt },
                            {
                                inlineData: {
                                    mimeType: 'image/png',
                                    data: jewelryBase64.replace(/^data:image\/\w+;base64,/, '')
                                }
                            }
                        ]
                    }],
                    generationConfig: {
                        responseModalities: ["image", "text"],
                        temperature: 0.1  // Çok düşük = yaratıcılık minimum
                    }
                })
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error('Gemini hatası: ' + (err.error?.message || 'Model oluşturulamadı'));
            }

            const data = await response.json();
            const parts = data.candidates?.[0]?.content?.parts || [];

            for (const part of parts) {
                if (part.inlineData?.data) {
                    console.log('✅ Model + kolye tek adımda oluşturuldu!');
                    return `data:image/png;base64,${part.inlineData.data}`;
                }
            }

            throw new Error('Görsel oluşturulamadı');
        }

        // ========== CANVAS COMPOSITE (Yedek - şu an kullanılmıyor) ==========
        async function createCanvasComposite(jewelryBase64, modelBase64, jewelryAnalysis) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const modelImg = new Image();
                const jewelryImg = new Image();
                let loaded = 0;

                const onLoad = () => {
                    loaded++;
                    if (loaded < 2) return;

                    canvas.width = modelImg.width;
                    canvas.height = modelImg.height;

                    // Model arka plan
                    ctx.drawImage(modelImg, 0, 0);

                    // Takı boyutu - uzunluğa göre ayarla
                    const sizeMap = {
                        'very_long': 0.65,
                        'long': 0.55,
                        'medium': 0.45,
                        'short': 0.35,
                        'choker': 0.30
                    };
                    let scale = sizeMap[jewelryAnalysis?.length] || 0.50;

                    // Takının aspect ratio'sunu hesapla
                    const jewelryAspectRatio = jewelryImg.width / jewelryImg.height;

                    // Çok geniş takılar için (genişlik > yükseklik) scale'i azalt
                    if (jewelryAspectRatio > 1.2) {
                        // Geniş kolye - canvas'a sığması için scale küçült
                        const maxWidthRatio = 0.85; // Canvas genişliğinin max %85'i
                        const neededScale = (modelImg.width * maxWidthRatio) / jewelryImg.width;
                        const currentWidth = modelImg.width * scale;

                        // Eğer mevcut genişlik canvas'ı aşıyorsa, küçült
                        if (currentWidth > modelImg.width * maxWidthRatio) {
                            scale = maxWidthRatio * (jewelryImg.height / jewelryImg.width);
                            console.log(`⚠️ Geniş kolye tespit edildi, scale ayarlandı: ${scale.toFixed(2)}`);
                        }
                    }

                    let targetWidth = modelImg.width * scale;
                    const aspectRatio = jewelryImg.height / jewelryImg.width;
                    let targetHeight = targetWidth * aspectRatio;

                    // SON KONTROL: Canvas sınırlarını aşmasın
                    const padding = 20; // Kenarlardan minimum boşluk
                    const maxWidth = modelImg.width - (padding * 2);
                    const maxHeight = modelImg.height * 0.75; // Max yükseklik

                    if (targetWidth > maxWidth) {
                        const reductionRatio = maxWidth / targetWidth;
                        targetWidth = maxWidth;
                        targetHeight = targetHeight * reductionRatio;
                        console.log(`⚠️ Genişlik sınırı aşıldı, küçültüldü: ${targetWidth.toFixed(0)}px`);
                    }

                    if (targetHeight > maxHeight) {
                        const reductionRatio = maxHeight / targetHeight;
                        targetHeight = maxHeight;
                        targetWidth = targetWidth * reductionRatio;
                        console.log(`⚠️ Yükseklik sınırı aşıldı, küçültüldü: ${targetHeight.toFixed(0)}px`);
                    }

                    // Pozisyon - merkez, göğüs hizası (kolye boyunda değil göğüste otursun)
                    const x = (modelImg.width - targetWidth) / 2;
                    const y = modelImg.height * 0.22;  // Üstten %22 - daha aşağıda

                    console.log(`📐 Takı boyutları: ${targetWidth.toFixed(0)}x${targetHeight.toFixed(0)}px, pozisyon: (${x.toFixed(0)}, ${y.toFixed(0)})`);

                    // Yumuşak gölge
                    ctx.save();
                    ctx.shadowColor = 'rgba(0, 0, 0, 0.25)';
                    ctx.shadowBlur = 20;
                    ctx.shadowOffsetX = 3;
                    ctx.shadowOffsetY = 8;

                    // Takıyı çiz
                    ctx.drawImage(jewelryImg, x, y, targetWidth, targetHeight);
                    ctx.restore();

                    resolve(canvas.toDataURL('image/png', 1.0));
                };

                modelImg.onload = onLoad;
                jewelryImg.onload = onLoad;
                modelImg.onerror = () => reject(new Error('Model yüklenemedi'));
                jewelryImg.onerror = () => reject(new Error('Takı yüklenemedi'));
                modelImg.src = modelBase64;
                jewelryImg.src = jewelryBase64;
            });
        }

        // ========== KENAR MASK - Takının alpha şekline göre kenar oluştur ==========
        async function createEdgeOnlyMask(jewelryBase64, modelBase64, jewelryAnalysis) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const modelImg = new Image();
                const jewelryImg = new Image();
                let loaded = 0;

                const onLoad = () => {
                    loaded++;
                    if (loaded < 2) return;

                    canvas.width = modelImg.width;
                    canvas.height = modelImg.height;

                    // Siyah arka plan (korunacak)
                    ctx.fillStyle = 'black';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);

                    // Takı pozisyonu (composite ile AYNI MANTIK)
                    const sizeMap = {
                        'very_long': 0.65,
                        'long': 0.55,
                        'medium': 0.45,
                        'short': 0.35,
                        'choker': 0.30
                    };
                    let scale = sizeMap[jewelryAnalysis?.length] || 0.50;

                    // Geniş takılar için scale ayarla (composite ile aynı)
                    const jewelryAspectRatio = jewelryImg.width / jewelryImg.height;
                    if (jewelryAspectRatio > 1.2) {
                        const maxWidthRatio = 0.85;
                        const currentWidth = modelImg.width * scale;
                        if (currentWidth > modelImg.width * maxWidthRatio) {
                            scale = maxWidthRatio * (jewelryImg.height / jewelryImg.width);
                        }
                    }

                    let targetWidth = modelImg.width * scale;
                    const aspectRatio = jewelryImg.height / jewelryImg.width;
                    let targetHeight = targetWidth * aspectRatio;

                    // Canvas sınır kontrolü (composite ile aynı)
                    const padding = 20;
                    const maxWidth = modelImg.width - (padding * 2);
                    const maxHeight = modelImg.height * 0.75;

                    if (targetWidth > maxWidth) {
                        const reductionRatio = maxWidth / targetWidth;
                        targetWidth = maxWidth;
                        targetHeight = targetHeight * reductionRatio;
                    }

                    if (targetHeight > maxHeight) {
                        const reductionRatio = maxHeight / targetHeight;
                        targetHeight = maxHeight;
                        targetWidth = targetWidth * reductionRatio;
                    }

                    const x = (modelImg.width - targetWidth) / 2;
                    const y = modelImg.height * 0.22;  // Composite ile aynı

                    // Takının alpha kanalını kullanarak gerçek şeklini al
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCanvas.width = Math.round(targetWidth);
                    tempCanvas.height = Math.round(targetHeight);

                    // Takıyı scaled boyutta çiz
                    tempCtx.drawImage(jewelryImg, 0, 0, targetWidth, targetHeight);
                    const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                    const data = imageData.data;

                    // DIŞ KENAR: Takının genişletilmiş versiyonunu beyaz çiz (blur ile)
                    ctx.save();
                    ctx.filter = 'blur(12px)';  // Yumuşak kenar
                    ctx.globalAlpha = 1.0;

                    // Beyaz silhouette - takı şeklinin dışı
                    const edgeCanvas = document.createElement('canvas');
                    const edgeCtx = edgeCanvas.getContext('2d');
                    edgeCanvas.width = tempCanvas.width;
                    edgeCanvas.height = tempCanvas.height;

                    // Alpha > 20 olan pikselleri beyaz yap
                    const edgeData = edgeCtx.createImageData(tempCanvas.width, tempCanvas.height);
                    for (let i = 0; i < data.length; i += 4) {
                        const alpha = data[i + 3];
                        if (alpha > 20) {
                            edgeData.data[i] = 255;     // R
                            edgeData.data[i + 1] = 255; // G
                            edgeData.data[i + 2] = 255; // B
                            edgeData.data[i + 3] = 255; // A
                        }
                    }
                    edgeCtx.putImageData(edgeData, 0, 0);

                    // Blur ile genişletilmiş beyaz kenar çiz
                    ctx.drawImage(edgeCanvas, x, y, targetWidth, targetHeight);
                    ctx.restore();

                    // İÇ ALAN: Takının gerçek şeklini siyah çiz (korunacak)
                    // Daha küçük (erozyon efekti) çizerek sadece kenarları bırak
                    ctx.save();
                    ctx.globalCompositeOperation = 'destination-out';

                    // İç alanı temizle - takının %90'ı korunacak
                    const innerScale = 0.92;  // %92'si korunacak, %8 kenar
                    const innerWidth = targetWidth * innerScale;
                    const innerHeight = targetHeight * innerScale;
                    const innerX = x + (targetWidth - innerWidth) / 2;
                    const innerY = y + (targetHeight - innerHeight) / 2;

                    // Aynı alpha shape'i daha küçük çiz
                    ctx.drawImage(edgeCanvas, innerX, innerY, innerWidth, innerHeight);
                    ctx.restore();

                    resolve(canvas.toDataURL('image/png'));
                };

                modelImg.onload = onLoad;
                jewelryImg.onload = onLoad;
                modelImg.src = modelBase64;
                jewelryImg.src = jewelryBase64;
            });
        }

        // ========== GEMINI IMAGE GENERATION (IMAGEN) ==========
        async function generateWithGeminiImageGen(apiKey, prompt) {
            // Gemini 2.5 Flash ile görsel üretim
            const response = await fetch(`${GEMINI_CONFIG.baseUrl}/${GEMINI_CONFIG.imageModel}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt + "\n\nGenerate an image based on this description."
                        }]
                    }],
                    generationConfig: {
                        responseModalities: ["IMAGE", "TEXT"]
                    }
                })
            });

            if (!response.ok) {
                throw new Error('Gemini görsel üretemedi');
            }

            const data = await response.json();
            const parts = data.candidates?.[0]?.content?.parts || [];

            for (const part of parts) {
                if (part.inlineData?.mimeType?.startsWith('image/')) {
                    return `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
                }
            }

            throw new Error('Görsel üretilemedi - Gemini görsel döndürmedi');
        }

        // ========== STUDIO ENHANCE - CLARITY UPSCALER ==========
        async function studioEnhance(imageBase64) {
            const falKey = localStorage.getItem('fal_api_key');
            if (!falKey) {
                console.warn('⚠️ Fal.ai key yok, upscale atlanıyor');
                return imageBase64;
            }

            try {
                console.log('🔍 Clarity Upscaler ile HD kalite...');
                showLoader('HD Kalite...', 'Yüksek çözünürlük');

                const upscaleResponse = await fetch('https://fal.run/fal-ai/clarity-upscaler', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Key ${falKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        image_url: imageBase64,
                        prompt: "professional jewelry photography, sharp details, high quality, studio lighting, e-commerce product photo",
                        scale: 2,
                        resemblance: 0.95,
                        creativity: 0.1
                    })
                });

                if (upscaleResponse.ok) {
                    const upscaleData = await upscaleResponse.json();
                    if (upscaleData.image?.url) {
                        const imgResponse = await fetch(upscaleData.image.url);
                        const imgBlob = await imgResponse.blob();
                        const result = await new Promise(resolve => {
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result);
                            reader.readAsDataURL(imgBlob);
                        });
                        console.log('✅ Upscale tamamlandı');
                        return result;
                    }
                }

                console.warn('⚠️ Upscaler başarısız');
                return imageBase64;

            } catch (error) {
                console.error('Upscale hatası:', error);
                return imageBase64;
            }
        }

        // ========== SMART POSITION - GEMINI ILE AKILLI KONUMLANDIRMA ==========
        async function calculateSmartPosition(templateBase64, jewelryBase64, templateWidth, templateHeight, jewelryWidth, jewelryHeight) {
            const geminiKey = localStorage.getItem('gemini_api_key');
            if (!geminiKey) {
                console.warn('⚠️ Gemini key yok, varsayılan pozisyon kullanılacak');
                return { x: 50, y: 45, scale: 55 }; // Varsayılan boyun pozisyonu
            }

            console.log('🧠 Gemini ile akıllı pozisyon hesaplanıyor...');

            const prompt = `Sen bir takı montaj uzmanısın. Sana iki görsel veriyorum:
1. ŞABLON: Bir kadın modelin boyun/dekolte fotoğrafı
2. TAKI: Bir kolye/takı (şeffaf arka planlı)

GÖREV: Takıyı şablona DOĞAL görünecek şekilde monte etmek için KOORDİNAT hesapla.

KURALLAR:
- Kolye boyunda durmalı, göğüste veya kafada DEĞİL
- Takı merkezi boyun çukuruna (suprasternal notch) hizalanmalı
- Boyut doğal görünmeli - ne çok büyük ne çok küçük
- Takının orijinal oranları korunacak

TEKNİK BİLGİ:
- Şablon boyutu: ${templateWidth}x${templateHeight} piksel
- Takı boyutu: ${jewelryWidth}x${jewelryHeight} piksel

SADECE JSON DÖNDÜR (başka hiçbir şey yazma):
{
    "x": <0-100 arası yüzde, 50=tam orta>,
    "y": <0-100 arası yüzde, 0=en üst, 100=en alt>,
    "scale": <20-100 arası yüzde, takının göreceli boyutu>
}

NOT: Tipik bir kolye için y=35-50 arası, scale=40-70 arası olur.`;

            try {
                const response = await fetch(`${GEMINI_CONFIG.baseUrl}/${GEMINI_CONFIG.textModel}:generateContent?key=${geminiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: prompt },
                                { inlineData: { mimeType: 'image/jpeg', data: templateBase64.split(',')[1] } },
                                { inlineData: { mimeType: 'image/png', data: jewelryBase64.split(',')[1] } }
                            ]
                        }],
                        generationConfig: {
                            temperature: 0.1,  // Düşük temperature = tutarlı sonuç
                            maxOutputTokens: 256
                        }
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    console.error('Gemini hatası:', err);
                    throw new Error(err.error?.message || 'Gemini yanıt vermedi');
                }

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                console.log('🧠 Gemini yanıtı:', text);

                // JSON'u parse et
                const jsonMatch = text.match(/\{[\s\S]*?\}/);
                if (jsonMatch) {
                    const position = JSON.parse(jsonMatch[0]);
                    console.log('📍 Hesaplanan pozisyon:', position);

                    // Validasyon
                    return {
                        x: Math.max(20, Math.min(80, position.x || 50)),
                        y: Math.max(15, Math.min(85, position.y || 45)),
                        scale: Math.max(20, Math.min(100, position.scale || 55))
                    };
                }
            } catch (error) {
                console.error('Gemini pozisyon hatası:', error);
            }

            // Fallback - varsayılan boyun pozisyonu
            console.warn('⚠️ Varsayılan pozisyon kullanılıyor');
            return { x: 50, y: 45, scale: 55 };
        }

        // ========== TEMPLATE COMPOSITE - CANVAS OVERLAY ==========
        async function compositeWithTemplate() {
            // Şablon varsa canvas overlay kullan
            if (!state.templateBase64) {
                throw new Error('Şablon yüklenmedi');
            }

            console.log('🎨 Canvas composite başlatılıyor...');

            return new Promise(async (resolve, reject) => {
                try {
                    // Load template and original jewelry images
                    const [templateImg, jewelryImg] = await Promise.all([
                        loadImage(state.templateBase64),
                        loadImage(state.originalBase64)
                    ]);

                    // Create canvas with template size
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = templateImg.width;
                    canvas.height = templateImg.height;

                    // Draw template (background - real model)
                    ctx.drawImage(templateImg, 0, 0);

                    // Slider'lardan pozisyon al
                    const smartPos = {
                        x: state.position.x,
                        y: state.position.y,
                        scale: state.position.scale
                    };

                    // Calculate jewelry size and position
                    const scaleFactor = smartPos.scale / 100;
                    const maxScale = Math.min(
                        (canvas.width * 0.9) / jewelryImg.width,
                        (canvas.height * 0.9) / jewelryImg.height
                    );
                    const finalScale = maxScale * scaleFactor;

                    const jWidth = jewelryImg.width * finalScale;
                    const jHeight = jewelryImg.height * finalScale;

                    // Position from sliders
                    const x = (canvas.width - jWidth) * (smartPos.x / 100);
                    const y = (canvas.height - jHeight) * (smartPos.y / 100);

                    console.log(`📍 Pozisyon: X=${smartPos.x}%, Y=${smartPos.y}%, Scale=${smartPos.scale}%`);

                    // Draw jewelry on top
                    ctx.drawImage(jewelryImg, x, y, jWidth, jHeight);

                    console.log('✅ Kompozit tamamlandı!');
                    resolve(canvas.toDataURL('image/jpeg', 0.95));
                } catch (error) {
                    reject(error);
                }
            });
        }

        // Helper: URL'den base64'e çevir
        async function fetchImageAsBase64(url) {
            const response = await fetch(url);
            const blob = await response.blob();
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(blob);
            });
        }

        // ========== STEP 1: ANALYZE PRODUCT FEATURES (JSON) ==========
        async function analyzeProductFeatures(apiKey, base64Image) {
            const analysisPrompt = `Sen bir takı uzmanısın. Bu takı ürününü ÇOK DETAYLI analiz et.

GÖREV: Başka bir AI'ın bu takıyı BIREBIR aynı şekilde üretebilmesi için gereken TÜM detayları çıkar.

JSON formatında yanıt ver:

{
    "product_type": "necklace/ring/bracelet/earrings/set",
    "chain_style": "zincir tipi (boncuklu, halka, yılan, vb.)",
    "pendant": {
        "exists": true/false,
        "shape": "oval/yuvarlak/damla/kare/kalp/vb.",
        "size": "küçük/orta/büyük/çok büyük",
        "color": "renk",
        "material": "taş türü veya malzeme",
        "setting": "çerçeve stili (bezel, prong, vb.)"
    },
    "beads": {
        "exists": true/false,
        "types": ["boncuk türleri - her birini ayrı yaz"],
        "sizes": "boyut varyasyonu açıklaması",
        "arrangement": "diziliş paterni (rastgele, simetrik, gradyan, vb.)",
        "count_estimate": "yaklaşık boncuk sayısı"
    },
    "materials": ["tüm malzemeler listesi"],
    "color_palette": ["TÜM renkler - ana ve aksanlar"],
    "metal_color": "gümüş/altın/rose gold/antik/yok",
    "overall_style": "bohem/klasik/modern/vintage/etnik/minimalist",
    "ultra_detailed_description": "Bu takıyı BIREBIR üretmek için 5-6 cümlelik SÜPER DETAYLI açıklama. Boncuk dizilişi, renk geçişleri, pendant detayları, zincir yapısı HER ŞEYİ yaz."
}

ÖNEMLİ: ultra_detailed_description alanı ÇOK KRİTİK. Başka bir AI bu açıklamayı okuyup takıyı birebir üretebilmeli.

SADECE JSON döndür.`;

            try {
                // Gemini 3 Flash - en yeni ve hızlı model (Ocak 2026)
                const response = await fetch(`${GEMINI_CONFIG.baseUrl}/${GEMINI_CONFIG.textModel}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: analysisPrompt },
                                { inlineData: { mimeType: 'image/jpeg', data: base64Image.split(',')[1] } }
                            ]
                        }],
                        generationConfig: {
                            temperature: 0.2,
                            maxOutputTokens: 2048
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Analiz API hatası:', errorData);
                    throw new Error(errorData.error?.message || 'API yanıt vermedi');
                }

                const data = await response.json();
                console.log('Gemini yanıtı:', data);

                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                console.log('Ham metin:', text);

                // Markdown code block içindeki JSON'u da yakala
                let jsonStr = text;

                // ```json ... ``` formatını temizle
                const codeBlockMatch = text.match(/```(?:json)?\s*([\s\S]*?)```/);
                if (codeBlockMatch) {
                    jsonStr = codeBlockMatch[1].trim();
                }

                // Düz JSON'u bul
                const jsonMatch = jsonStr.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    const parsed = JSON.parse(jsonMatch[0]);
                    console.log('✅ JSON parse başarılı:', parsed);
                    return parsed;
                }

                console.warn('JSON bulunamadı, fallback kullanılıyor');
            } catch (error) {
                console.error('Analiz hatası:', error);
                showToast('Analiz hatası: ' + error.message, 'error');
            }

            // Fallback - hata durumunda basit değerler
            return {
                product_type: "necklace",
                chain_style: "beaded chain",
                pendant: {
                    exists: true,
                    shape: "oval",
                    size: "large",
                    color: "turquoise",
                    material: "natural stone",
                    setting: "silver bezel"
                },
                beads: {
                    exists: true,
                    types: ["silver round beads", "colorful glass beads"],
                    sizes: "mixed sizes from small to medium",
                    arrangement: "alternating pattern",
                    count_estimate: "30-40 beads"
                },
                materials: ["natural stone", "silver metal", "glass beads"],
                color_palette: ["turquoise", "silver", "earth tones"],
                metal_color: "antique silver",
                overall_style: "bohemian",
                ultra_detailed_description: "A handcrafted bohemian style beaded necklace featuring a large oval turquoise natural stone pendant set in an antique silver bezel frame. The chain consists of alternating silver round metal beads and colorful earth-toned glass beads in varying sizes. The beads are strung in a symmetrical pattern leading to the central pendant."
            };
        }

        // Helper function to load image from URL
        function loadImage(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = url;
            });
        }

        // ========== GALLERY FUNCTIONS ==========
        function addToGallery() {
            if (!state.processedImage) return;

            // Find empty slot
            const emptySlotIndex = state.gallery.findIndex(g => !g);
            if (emptySlotIndex === -1 && state.gallery.length >= 4) {
                showToast('Galeri dolu! Önce bir slot boşaltın.', 'error');
                return;
            }

            const slotIndex = emptySlotIndex !== -1 ? emptySlotIndex : state.gallery.length;
            state.gallery[slotIndex] = state.processedImage;

            updateMiniGallery();
            showToast(`Slot ${slotIndex + 1}'e eklendi`, 'success');
        }

        function updateMiniGallery() {
            const slots = document.querySelectorAll('.gallery-slot');
            slots.forEach((slot, index) => {
                if (state.gallery[index]) {
                    slot.innerHTML = `<img src="${state.gallery[index]}" class="w-full h-full object-cover rounded-lg">`;
                    slot.onclick = () => showGalleryImage(index);
                } else {
                    slot.innerHTML = '<i class="fa-solid fa-plus text-slate-600"></i>';
                    slot.onclick = null;
                }
            });
        }

        function showGalleryImage(index) {
            if (state.gallery[index]) {
                document.getElementById('previewImage').src = state.gallery[index];
                document.getElementById('previewImage').classList.remove('hidden');
                document.getElementById('previewPlaceholder').classList.add('hidden');
                state.processedImage = state.gallery[index];
                document.getElementById('downloadActions').classList.remove('hidden');
            }
        }

        function clearGallery() {
            state.gallery = [];
            updateMiniGallery();
            document.getElementById('fullGallery').innerHTML = `
                <div class="text-center text-slate-500 col-span-full py-12">
                    <i class="fa-solid fa-images text-4xl mb-3"></i>
                    <p>Henüz görsel yok</p>
                </div>`;
            showToast('Galeri temizlendi', 'success');
        }

        // ========== DOWNLOAD ==========
        function downloadImage(format) {
            if (!state.processedImage) return;

            const link = document.createElement('a');
            link.download = `trendyol_pro_${Date.now()}.${format}`;

            if (format === 'png') {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                };
                img.src = state.processedImage;
            } else {
                link.href = state.processedImage;
                link.click();
            }

            showToast(`${format.toUpperCase()} indirildi`, 'success');
        }

        // ========== LOADER ==========
        function showLoader(text, subtext) {
            document.getElementById('previewLoader').classList.remove('hidden');
            document.getElementById('loaderText').textContent = text;
            document.getElementById('loaderSubtext').textContent = subtext || 'Lütfen bekleyin';
        }

        function hideLoader() {
            document.getElementById('previewLoader').classList.add('hidden');
        }

        // ========== TOAST ==========
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const msg = document.getElementById('toastMessage');

            msg.textContent = message;
            icon.className = type === 'success'
                ? 'fa-solid fa-check-circle text-green-400 text-xl'
                : 'fa-solid fa-exclamation-circle text-red-400 text-xl';

            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }
    </script>
</body>
</html>
