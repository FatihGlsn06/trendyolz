<!DOCTYPE html>
<!-- Trendyol Pro Studio v4.1 - Professional Jewelry Display Stands -->
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trendyol Pro Studio v3 - AI Fotoğrafçı</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            --primary: #f27a1a;
            --primary-dark: #d96a10;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #0f172a;
            --darker: #020617;
        }
        * { font-family: 'Inter', sans-serif; }
        body {
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 50%, #1e1b4b 100%);
            min-height: 100vh;
        }

        .glass {
            background: rgba(255,255,255,0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.08);
        }

        .glow { box-shadow: 0 0 60px rgba(242,122,26,0.2); }
        .glow-success { box-shadow: 0 0 40px rgba(16,185,129,0.3); }

        .gradient-text {
            background: linear-gradient(135deg, #f27a1a, #fbbf24);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .animate-float { animation: float 3s ease-in-out infinite; }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .loader {
            width: 48px; height: 48px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .step-indicator { transition: all 0.3s ease; }
        .step-indicator.active {
            background: linear-gradient(135deg, var(--primary), #fbbf24);
            transform: scale(1.1);
        }
        .step-indicator.completed {
            background: var(--success);
        }

        .preset-card { transition: all 0.2s ease; }
        .preset-card:hover { transform: translateY(-4px); }
        .preset-card.selected {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(242,122,26,0.3);
        }

        .analysis-score {
            background: conic-gradient(var(--success) calc(var(--score) * 1%), rgba(255,255,255,0.1) 0);
            border-radius: 50%;
        }

        .mannequin-option { transition: all 0.2s ease; cursor: pointer; }
        .mannequin-option:hover { transform: scale(1.05); border-color: rgba(242,122,26,0.5); }
        .mannequin-option.selected {
            border-color: var(--primary) !important;
            background: rgba(242,122,26,0.15) !important;
            box-shadow: 0 0 15px rgba(242,122,26,0.3);
        }

        .scene-option { transition: all 0.2s ease; cursor: pointer; }
        .scene-option:hover { transform: scale(1.02); border-color: rgba(242,122,26,0.5); }
        .scene-option.selected {
            border-color: var(--primary) !important;
            box-shadow: 0 0 15px rgba(242,122,26,0.3);
        }

        input[type="range"] {
            -webkit-appearance: none;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            height: 6px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px; height: 18px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 10px;
            font-weight: 500;
        }
        .status-badge.active { background: rgba(16,185,129,0.2); color: #10b981; }
        .status-badge.inactive { background: rgba(148,163,184,0.2); color: #94a3b8; }
    </style>
</head>
<body class="text-white">

    <!-- Header -->
    <header class="border-b border-white/10">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-orange-500 to-amber-500 flex items-center justify-center">
                    <i class="fa-solid fa-camera-retro text-lg"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg">Trendyol Pro Studio</h1>
                    <p class="text-[10px] text-slate-400">AI Fotoğrafçı Asistanı v4.1</p>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-slate-800/50">
                    <div id="apiDot" class="w-2 h-2 rounded-full bg-red-500"></div>
                    <span id="apiStatus" class="text-xs text-slate-400">API Bağlantısı Yok</span>
                </div>
                <button onclick="openSettings()" class="p-2 rounded-lg hover:bg-white/5 transition-colors">
                    <i class="fa-solid fa-cog text-slate-400"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Progress Steps -->
    <div class="max-w-4xl mx-auto px-4 py-6">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div id="step1" class="step-indicator active w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold">1</div>
                <span class="text-sm text-slate-400">Yükle</span>
            </div>
            <div class="flex-1 h-0.5 bg-slate-700 mx-4"></div>
            <div class="flex items-center gap-2">
                <div id="step2" class="step-indicator w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-sm font-bold">2</div>
                <span class="text-sm text-slate-400">Analiz</span>
            </div>
            <div class="flex-1 h-0.5 bg-slate-700 mx-4"></div>
            <div class="flex items-center gap-2">
                <div id="step3" class="step-indicator w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-sm font-bold">3</div>
                <span class="text-sm text-slate-400">Düzenle</span>
            </div>
            <div class="flex-1 h-0.5 bg-slate-700 mx-4"></div>
            <div class="flex items-center gap-2">
                <div id="step4" class="step-indicator w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-sm font-bold">4</div>
                <span class="text-sm text-slate-400">İndir</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 pb-12">

        <!-- Step 1: Upload -->
        <section id="uploadSection" class="mb-8">
            <div class="glass rounded-2xl p-8 glow">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold mb-2">Ürün Fotoğrafınızı Yükleyin</h2>
                    <p class="text-slate-400">AI fotoğrafçımız görselinizi analiz edecek ve iyileştirme önerileri sunacak</p>
                </div>

                <div id="dropZone" onclick="document.getElementById('fileInput').click()"
                     class="border-2 border-dashed border-slate-600 rounded-2xl p-12 text-center cursor-pointer hover:border-orange-500/50 hover:bg-orange-500/5 transition-all">
                    <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleUpload(event)">
                    <div id="uploadPrompt">
                        <div class="w-20 h-20 rounded-full bg-slate-800 flex items-center justify-center mx-auto mb-4 animate-float">
                            <i class="fa-solid fa-cloud-arrow-up text-3xl text-slate-500"></i>
                        </div>
                        <p class="text-lg font-medium mb-2">Sürükle & Bırak veya Tıkla</p>
                        <p class="text-sm text-slate-500">PNG, JPG, WEBP • Max 20MB</p>
                    </div>
                    <div id="uploadPreviewContainer" class="hidden">
                        <img id="uploadPreview" class="max-h-64 mx-auto rounded-xl shadow-2xl">
                        <p id="fileName" class="mt-4 text-sm text-slate-400"></p>
                    </div>
                </div>

                <div id="uploadActions" class="hidden mt-6 flex justify-center gap-4">
                    <button onclick="clearUpload()" class="px-6 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 transition-colors">
                        <i class="fa-solid fa-trash-can mr-2"></i>Temizle
                    </button>
                    <button onclick="startAnalysis()" class="px-8 py-3 rounded-xl bg-gradient-to-r from-orange-500 to-amber-500 hover:from-orange-600 hover:to-amber-600 font-semibold transition-all">
                        <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>AI Analiz Başlat
                    </button>
                </div>
            </div>
        </section>

        <!-- Step 2: Analysis Results -->
        <section id="analysisSection" class="hidden mb-8">
            <div class="grid lg:grid-cols-3 gap-6">
                <div class="glass rounded-2xl p-6">
                    <h3 class="font-semibold mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-image text-slate-400"></i>
                        Orijinal Görsel
                    </h3>
                    <img id="analysisOriginal" class="w-full rounded-xl">
                    <div class="mt-4 grid grid-cols-2 gap-2 text-xs">
                        <div class="bg-slate-800/50 rounded-lg p-2">
                            <span class="text-slate-500">Boyut:</span>
                            <span id="imgDimensions" class="ml-1">-</span>
                        </div>
                        <div class="bg-slate-800/50 rounded-lg p-2">
                            <span class="text-slate-500">Format:</span>
                            <span id="imgFormat" class="ml-1">-</span>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2 glass rounded-2xl p-6">
                    <h3 class="font-semibold mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-robot text-orange-400"></i>
                        AI Fotoğrafçı Analizi
                        <span id="analysisLoader" class="ml-auto">
                            <div class="loader w-5 h-5 border-2"></div>
                        </span>
                    </h3>

                    <div id="analysisContent" class="hidden">
                        <div class="flex items-center gap-6 mb-6 p-4 bg-slate-800/30 rounded-xl">
                            <div class="relative w-20 h-20">
                                <div class="analysis-score w-full h-full flex items-center justify-center" style="--score: 0">
                                    <div class="w-16 h-16 rounded-full bg-slate-900 flex items-center justify-center">
                                        <span id="scoreValue" class="text-2xl font-bold">0</span>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <p id="scoreLabel" class="font-semibold text-lg">Analiz Ediliyor...</p>
                                <p id="scoreDescription" class="text-sm text-slate-400">Fotoğraf kalite puanı</p>
                            </div>
                        </div>

                        <div class="mb-4">
                            <h4 class="text-sm font-semibold text-slate-400 uppercase mb-2">Ürün Tespiti</h4>
                            <div class="flex flex-wrap gap-2">
                                <span id="productType" class="px-3 py-1 rounded-full bg-orange-500/20 text-orange-400 text-sm"></span>
                                <span id="productCategory" class="px-3 py-1 rounded-full bg-blue-500/20 text-blue-400 text-sm"></span>
                            </div>
                        </div>

                        <div class="mb-4">
                            <h4 class="text-sm font-semibold text-slate-400 uppercase mb-2">Tespit Edilen Sorunlar</h4>
                            <div id="issuesList" class="space-y-2"></div>
                        </div>

                        <div class="mb-4">
                            <h4 class="text-sm font-semibold text-slate-400 uppercase mb-2">AI Önerileri</h4>
                            <div id="recommendationsList" class="space-y-2"></div>
                        </div>

                        <button onclick="proceedToEdit()" class="w-full mt-4 py-3 rounded-xl bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 font-semibold transition-all">
                            <i class="fa-solid fa-arrow-right mr-2"></i>Düzenlemeye Geç
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Step 3: Edit -->
        <section id="editSection" class="hidden mb-8">
            <div class="grid lg:grid-cols-12 gap-6">

                <!-- Left Panel: Settings -->
                <div class="lg:col-span-4 space-y-4">

                    <!-- Trendyol Presets -->
                    <div class="glass rounded-2xl p-5">
                        <h3 class="font-semibold mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-th-large text-orange-400"></i>
                            Trendyol Preset'leri
                        </h3>
                        <div class="grid grid-cols-2 gap-3" id="presetOptions">
                            <div onclick="selectPreset('main')" class="preset-card selected p-4 rounded-xl border border-slate-700 cursor-pointer" data-preset="main">
                                <div class="w-12 h-12 bg-white rounded-lg mb-2 mx-auto flex items-center justify-center">
                                    <i class="fa-solid fa-image text-slate-800"></i>
                                </div>
                                <p class="text-sm font-medium text-center">Ana Görsel</p>
                                <p class="text-xs text-slate-500 text-center">1000x1000</p>
                            </div>
                            <div onclick="selectPreset('detail')" class="preset-card p-4 rounded-xl border border-slate-700 cursor-pointer" data-preset="detail">
                                <div class="w-12 h-8 bg-white rounded-lg mb-2 mx-auto flex items-center justify-center">
                                    <i class="fa-solid fa-search-plus text-slate-800 text-xs"></i>
                                </div>
                                <p class="text-sm font-medium text-center">Detay</p>
                                <p class="text-xs text-slate-500 text-center">1000x1500</p>
                            </div>
                            <div onclick="selectPreset('lifestyle')" class="preset-card p-4 rounded-xl border border-slate-700 cursor-pointer" data-preset="lifestyle">
                                <div class="w-12 h-12 bg-gradient-to-br from-pink-200 to-purple-200 rounded-lg mb-2 mx-auto"></div>
                                <p class="text-sm font-medium text-center">Lifestyle</p>
                                <p class="text-xs text-slate-500 text-center">1000x1000</p>
                            </div>
                            <div onclick="selectPreset('social')" class="preset-card p-4 rounded-xl border border-slate-700 cursor-pointer" data-preset="social">
                                <div class="w-12 h-12 bg-gradient-to-br from-orange-400 to-pink-400 rounded-lg mb-2 mx-auto flex items-center justify-center">
                                    <i class="fa-brands fa-instagram text-white"></i>
                                </div>
                                <p class="text-sm font-medium text-center">Sosyal</p>
                                <p class="text-xs text-slate-500 text-center">1080x1080</p>
                            </div>
                        </div>
                    </div>

                    <!-- Background Options -->
                    <div class="glass rounded-2xl p-5">
                        <h3 class="font-semibold mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-palette text-blue-400"></i>
                            Arka Plan
                        </h3>

                        <div class="mb-4">
                            <label class="text-xs text-slate-400 mb-2 block">Düz Renk</label>
                            <div class="flex gap-2 flex-wrap">
                                <button onclick="setBg('#FFFFFF')" class="bg-btn w-10 h-10 rounded-lg bg-white border-2 border-orange-500" data-bg="#FFFFFF"></button>
                                <button onclick="setBg('#F8F9FA')" class="bg-btn w-10 h-10 rounded-lg border-2 border-transparent hover:border-slate-400" style="background:#F8F9FA" data-bg="#F8F9FA"></button>
                                <button onclick="setBg('#F5F5F5')" class="bg-btn w-10 h-10 rounded-lg border-2 border-transparent hover:border-slate-400" style="background:#F5F5F5" data-bg="#F5F5F5"></button>
                                <button onclick="setBg('#000000')" class="bg-btn w-10 h-10 rounded-lg bg-black border-2 border-transparent hover:border-slate-400" data-bg="#000000"></button>
                                <input type="color" id="customBg" value="#FFFFFF" onchange="setBg(this.value)" class="w-10 h-10 rounded-lg cursor-pointer">
                            </div>
                        </div>

                        <!-- AI Scene Selection -->
                        <div class="mb-2">
                            <label class="text-xs text-slate-400 mb-2 block flex items-center gap-2">
                                <i class="fa-solid fa-wand-magic-sparkles text-purple-400"></i>
                                AI Sahne
                                <span id="sceneStatus" class="status-badge inactive">Seçilmedi</span>
                            </label>
                            <div class="grid grid-cols-3 gap-2" id="sceneOptions">
                                <div onclick="selectScene('none')" class="scene-option selected p-2 rounded-lg border border-slate-700 text-center" data-scene="none">
                                    <div class="w-full h-10 bg-white rounded mb-1"></div>
                                    <p class="text-[10px]">Düz</p>
                                </div>
                                <div onclick="selectScene('studio')" class="scene-option p-2 rounded-lg border border-slate-700 text-center" data-scene="studio">
                                    <div class="w-full h-10 bg-gradient-to-b from-gray-100 to-gray-300 rounded mb-1"></div>
                                    <p class="text-[10px]">Stüdyo</p>
                                </div>
                                <div onclick="selectScene('marble')" class="scene-option p-2 rounded-lg border border-slate-700 text-center" data-scene="marble">
                                    <div class="w-full h-10 bg-gradient-to-br from-gray-100 via-white to-gray-200 rounded mb-1"></div>
                                    <p class="text-[10px]">Mermer</p>
                                </div>
                                <div onclick="selectScene('wood')" class="scene-option p-2 rounded-lg border border-slate-700 text-center" data-scene="wood">
                                    <div class="w-full h-10 bg-gradient-to-r from-amber-700 to-amber-600 rounded mb-1"></div>
                                    <p class="text-[10px]">Ahşap</p>
                                </div>
                                <div onclick="selectScene('velvet')" class="scene-option p-2 rounded-lg border border-slate-700 text-center" data-scene="velvet">
                                    <div class="w-full h-10 bg-gradient-to-br from-purple-900 to-purple-700 rounded mb-1"></div>
                                    <p class="text-[10px]">Kadife</p>
                                </div>
                                <div onclick="selectScene('silk')" class="scene-option p-2 rounded-lg border border-slate-700 text-center" data-scene="silk">
                                    <div class="w-full h-10 bg-gradient-to-br from-rose-100 to-pink-200 rounded mb-1"></div>
                                    <p class="text-[10px]">İpek</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Virtual Mannequin for Jewelry -->
                    <div class="glass rounded-2xl p-5">
                        <h3 class="font-semibold mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-gem text-purple-400"></i>
                            Takı Mankeni
                            <span id="mannequinStatus" class="status-badge inactive ml-auto">Seçilmedi</span>
                        </h3>
                        <p class="text-xs text-slate-500 mb-3">Profesyonel mücevher display standları</p>

                        <div id="mannequinOptions" class="grid grid-cols-3 gap-2">
                            <div onclick="selectMannequin('none')" class="mannequin-option selected p-3 rounded-xl border border-slate-700 text-center" data-mannequin="none">
                                <i class="fa-solid fa-ban text-slate-500 text-xl mb-1 block"></i>
                                <p class="text-xs">Yok</p>
                            </div>
                            <div onclick="selectMannequin('hand_female')" class="mannequin-option p-3 rounded-xl border border-slate-700 text-center" data-mannequin="hand_female">
                                <i class="fa-solid fa-hand text-pink-400 text-xl mb-1 block"></i>
                                <p class="text-xs">Kadın El</p>
                            </div>
                            <div onclick="selectMannequin('hand_male')" class="mannequin-option p-3 rounded-xl border border-slate-700 text-center" data-mannequin="hand_male">
                                <i class="fa-solid fa-hand text-blue-400 text-xl mb-1 block"></i>
                                <p class="text-xs">Erkek El</p>
                            </div>
                            <div onclick="selectMannequin('neck_bust')" class="mannequin-option p-3 rounded-xl border border-slate-700 text-center" data-mannequin="neck_bust">
                                <i class="fa-solid fa-user text-amber-400 text-xl mb-1 block"></i>
                                <p class="text-xs">Boyun Büst</p>
                            </div>
                            <div onclick="selectMannequin('ear_display')" class="mannequin-option p-3 rounded-xl border border-slate-700 text-center" data-mannequin="ear_display">
                                <i class="fa-solid fa-ear-listen text-green-400 text-xl mb-1 block"></i>
                                <p class="text-xs">Kulak</p>
                            </div>
                            <div onclick="selectMannequin('wrist_display')" class="mannequin-option p-3 rounded-xl border border-slate-700 text-center" data-mannequin="wrist_display">
                                <i class="fa-regular fa-circle text-cyan-400 text-xl mb-1 block"></i>
                                <p class="text-xs">Bilek</p>
                            </div>
                            <div onclick="selectMannequin('finger_ring')" class="mannequin-option p-3 rounded-xl border border-slate-700 text-center" data-mannequin="finger_ring">
                                <i class="fa-solid fa-ring text-yellow-400 text-xl mb-1 block"></i>
                                <p class="text-xs">Yüzük</p>
                            </div>
                            <div onclick="selectMannequin('model_closeup')" class="mannequin-option p-3 rounded-xl border border-slate-700 text-center" data-mannequin="model_closeup">
                                <i class="fa-solid fa-face-smile text-rose-400 text-xl mb-1 block"></i>
                                <p class="text-xs">Model</p>
                            </div>
                            <div onclick="selectMannequin('full_body')" class="mannequin-option p-3 rounded-xl border border-slate-700 text-center" data-mannequin="full_body">
                                <i class="fa-solid fa-person-dress text-violet-400 text-xl mb-1 block"></i>
                                <p class="text-xs">Tam Boy</p>
                            </div>
                        </div>

                        <!-- Mannequin Style Options -->
                        <div id="mannequinStyleOptions" class="hidden mt-3 p-3 bg-slate-800/50 rounded-xl">
                            <label class="text-xs text-slate-400 mb-2 block">Manken Stili</label>
                            <select id="mannequinStyle" onchange="updateMannequinStyle()" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-3 py-2 text-sm">
                                <option value="realistic">Gerçekçi (Fotoğraf)</option>
                                <option value="elegant">Elegant (Işıklı)</option>
                                <option value="minimal">Minimal (Sade)</option>
                                <option value="luxury">Lüks (Premium)</option>
                            </select>
                            <p class="text-[10px] text-slate-500 mt-2">
                                <i class="fa-solid fa-info-circle mr-1"></i>
                                Seçilen: <span id="selectedMannequinText" class="text-orange-400">-</span>
                            </p>
                        </div>
                    </div>

                    <!-- Adjustments -->
                    <div class="glass rounded-2xl p-5">
                        <h3 class="font-semibold mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-sliders text-green-400"></i>
                            İnce Ayarlar
                        </h3>

                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-slate-400">Gölge</span>
                                    <span id="shadowVal" class="text-orange-400">50%</span>
                                </div>
                                <input type="range" id="shadowRange" min="0" max="100" value="50" oninput="updateAdjustment('shadow', this.value)" class="w-full">
                            </div>
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-slate-400">Parlaklık</span>
                                    <span id="brightnessVal" class="text-orange-400">100%</span>
                                </div>
                                <input type="range" id="brightnessRange" min="50" max="150" value="100" oninput="updateAdjustment('brightness', this.value)" class="w-full">
                            </div>
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-slate-400">Kontrast</span>
                                    <span id="contrastVal" class="text-orange-400">100%</span>
                                </div>
                                <input type="range" id="contrastRange" min="50" max="150" value="100" oninput="updateAdjustment('contrast', this.value)" class="w-full">
                            </div>
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-slate-400">Padding</span>
                                    <span id="paddingVal" class="text-orange-400">10%</span>
                                </div>
                                <input type="range" id="paddingRange" min="0" max="30" value="10" oninput="updateAdjustment('padding', this.value)" class="w-full">
                            </div>
                        </div>
                    </div>

                    <!-- Process Button -->
                    <button onclick="processImage()" id="processBtn" class="w-full py-4 rounded-xl bg-gradient-to-r from-orange-500 to-amber-500 hover:from-orange-600 hover:to-amber-600 font-bold text-lg transition-all glow">
                        <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>
                        Görseli Oluştur
                    </button>
                </div>

                <!-- Right Panel: Preview -->
                <div class="lg:col-span-8">
                    <div class="glass rounded-2xl p-6 h-full">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold flex items-center gap-2">
                                <i class="fa-solid fa-eye text-slate-400"></i>
                                Önizleme
                            </h3>
                            <div id="previewInfo" class="text-xs text-slate-500">
                                <span id="previewSize">1000x1000</span> •
                                <span id="previewFormat">JPEG</span>
                            </div>
                        </div>

                        <div id="previewArea" class="relative rounded-xl overflow-hidden min-h-[500px] flex items-center justify-center" style="background: #FFFFFF;">
                            <!-- Loading -->
                            <div id="previewLoader" class="hidden absolute inset-0 bg-black/50 flex items-center justify-center z-10">
                                <div class="text-center">
                                    <div class="loader mx-auto mb-4"></div>
                                    <p id="previewLoaderText" class="text-sm">İşleniyor...</p>
                                </div>
                            </div>

                            <!-- Result -->
                            <img id="previewImage" class="max-w-full max-h-[500px] shadow-2xl rounded-lg">
                        </div>

                        <!-- Current Settings Display -->
                        <div id="currentSettings" class="mt-4 p-3 bg-slate-800/30 rounded-xl text-xs">
                            <div class="flex flex-wrap gap-2">
                                <span class="px-2 py-1 bg-slate-700 rounded">Sahne: <span id="currentScene" class="text-orange-400">Düz</span></span>
                                <span class="px-2 py-1 bg-slate-700 rounded">Manken: <span id="currentMannequin" class="text-purple-400">Yok</span></span>
                                <span class="px-2 py-1 bg-slate-700 rounded">Boyut: <span id="currentSize" class="text-green-400">1000x1000</span></span>
                            </div>
                        </div>

                        <!-- Download Actions -->
                        <div id="downloadActions" class="hidden mt-4 flex flex-wrap gap-3">
                            <button onclick="downloadImage('jpeg')" class="flex-1 py-3 rounded-xl bg-green-600 hover:bg-green-500 font-semibold transition-colors">
                                <i class="fa-solid fa-download mr-2"></i>JPEG İndir
                            </button>
                            <button onclick="downloadImage('png')" class="flex-1 py-3 rounded-xl bg-blue-600 hover:bg-blue-500 font-semibold transition-colors">
                                <i class="fa-solid fa-download mr-2"></i>PNG İndir
                            </button>
                            <button onclick="downloadImage('webp')" class="py-3 px-6 rounded-xl bg-purple-600 hover:bg-purple-500 font-semibold transition-colors">
                                <i class="fa-solid fa-download mr-2"></i>WebP
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4 overflow-y-auto">
        <div class="glass rounded-2xl w-full max-w-lg p-6 my-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-lg">API Ayarları</h3>
                <button onclick="closeSettings()" class="text-slate-400 hover:text-white">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <div class="space-y-4">
                <!-- Google AI -->
                <div class="p-4 bg-slate-800/30 rounded-xl">
                    <label class="text-sm font-medium text-white mb-2 block flex items-center gap-2">
                        <i class="fa-brands fa-google text-blue-400"></i> Google AI (Gemini)
                        <span class="text-[10px] px-2 py-0.5 bg-green-500/20 text-green-400 rounded-full">Ücretsiz</span>
                    </label>
                    <input type="password" id="apiKeyInput"
                           class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-sm focus:border-orange-500 outline-none"
                           placeholder="AIza...">
                    <p class="text-xs text-slate-500 mt-1">
                        Görsel analiz için • <a href="https://aistudio.google.com/apikey" target="_blank" class="text-orange-400 hover:underline">Ücretsiz al</a>
                    </p>
                </div>

                <!-- Photoroom API -->
                <div class="p-4 bg-slate-800/30 rounded-xl">
                    <label class="text-sm font-medium text-white mb-2 block flex items-center gap-2">
                        <i class="fa-solid fa-user-astronaut text-purple-400"></i> Photoroom API
                        <span class="text-[10px] px-2 py-0.5 bg-purple-500/20 text-purple-400 rounded-full">AI Manken</span>
                    </label>
                    <input type="password" id="photoroomKey"
                           class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-sm focus:border-purple-500 outline-none"
                           placeholder="pr_...">
                    <p class="text-xs text-slate-500 mt-1">
                        Gerçekçi AI model/manken • <a href="https://www.photoroom.com/api" target="_blank" class="text-purple-400 hover:underline">API al</a>
                    </p>
                </div>

                <!-- Stability AI -->
                <div class="p-4 bg-slate-800/30 rounded-xl">
                    <label class="text-sm font-medium text-white mb-2 block flex items-center gap-2">
                        <i class="fa-solid fa-wand-sparkles text-pink-400"></i> Stability AI
                        <span class="text-[10px] px-2 py-0.5 bg-pink-500/20 text-pink-400 rounded-full">SDXL</span>
                    </label>
                    <input type="password" id="stabilityKey"
                           class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-sm focus:border-pink-500 outline-none"
                           placeholder="sk-...">
                    <p class="text-xs text-slate-500 mt-1">
                        Profesyonel görsel üretimi • <a href="https://platform.stability.ai/" target="_blank" class="text-pink-400 hover:underline">API al</a>
                    </p>
                </div>

                <!-- Remove.bg -->
                <div class="p-4 bg-slate-800/30 rounded-xl">
                    <label class="text-sm font-medium text-white mb-2 block flex items-center gap-2">
                        <i class="fa-solid fa-eraser text-cyan-400"></i> Remove.bg
                        <span class="text-[10px] px-2 py-0.5 bg-slate-500/20 text-slate-400 rounded-full">Opsiyonel</span>
                    </label>
                    <input type="password" id="removeBgKey"
                           class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2.5 text-sm focus:border-cyan-500 outline-none"
                           placeholder="Profesyonel arka plan kaldırma">
                    <p class="text-xs text-slate-500 mt-1">
                        Daha iyi arka plan kaldırma • <a href="https://www.remove.bg/api" target="_blank" class="text-cyan-400 hover:underline">API al</a>
                    </p>
                </div>

                <!-- API Status -->
                <div class="p-3 bg-slate-900/50 rounded-lg">
                    <p class="text-xs text-slate-400 mb-2">API Durumu:</p>
                    <div class="flex flex-wrap gap-2">
                        <span id="geminiStatus" class="text-[10px] px-2 py-1 bg-slate-800 rounded flex items-center gap-1">
                            <span class="w-1.5 h-1.5 rounded-full bg-red-500"></span> Gemini
                        </span>
                        <span id="photoroomStatus" class="text-[10px] px-2 py-1 bg-slate-800 rounded flex items-center gap-1">
                            <span class="w-1.5 h-1.5 rounded-full bg-red-500"></span> Photoroom
                        </span>
                        <span id="stabilityStatus" class="text-[10px] px-2 py-1 bg-slate-800 rounded flex items-center gap-1">
                            <span class="w-1.5 h-1.5 rounded-full bg-red-500"></span> Stability
                        </span>
                        <span id="removebgStatus" class="text-[10px] px-2 py-1 bg-slate-800 rounded flex items-center gap-1">
                            <span class="w-1.5 h-1.5 rounded-full bg-red-500"></span> Remove.bg
                        </span>
                    </div>
                </div>
            </div>

            <button onclick="saveSettings()" class="w-full mt-6 py-3 bg-gradient-to-r from-orange-500 to-amber-500 rounded-xl font-bold">
                <i class="fa-solid fa-save mr-2"></i>Kaydet
            </button>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-4 right-4 hidden z-50">
        <div class="glass rounded-xl px-6 py-4 flex items-center gap-3">
            <i id="toastIcon" class="fa-solid fa-check-circle text-green-400 text-xl"></i>
            <span id="toastMessage">İşlem başarılı</span>
        </div>
    </div>

    <script>
        // ========== STATE ==========
        let state = {
            originalImage: null,
            originalBase64: null,
            removedBgImage: null,
            processedImage: null,
            currentStep: 1,
            analysis: null,
            settings: {
                preset: 'main',
                bgColor: '#FFFFFF',
                scene: 'none',
                mannequin: 'none',
                mannequinStyle: 'realistic',
                shadow: 50,
                brightness: 100,
                contrast: 100,
                padding: 10
            }
        };

        const PRESETS = {
            main: { width: 1000, height: 1000, name: 'Ana Görsel', bg: '#FFFFFF' },
            detail: { width: 1000, height: 1500, name: 'Detay', bg: '#FFFFFF' },
            lifestyle: { width: 1000, height: 1000, name: 'Lifestyle', bg: '#F5F5F5' },
            social: { width: 1080, height: 1080, name: 'Sosyal Medya', bg: '#FFFFFF' }
        };

        const SCENE_NAMES = {
            none: 'Düz',
            studio: 'Stüdyo',
            marble: 'Mermer',
            wood: 'Ahşap',
            velvet: 'Kadife',
            silk: 'İpek'
        };

        const MANNEQUIN_NAMES = {
            none: 'Yok',
            hand_female: 'Kadın El',
            hand_male: 'Erkek El',
            neck_bust: 'Boyun Büst',
            ear_display: 'Kulak',
            wrist_display: 'Bilek',
            finger_ring: 'Yüzük Parmak',
            model_closeup: 'Model Yüz',
            full_body: 'Tam Boy Model'
        };

        const PHOTOGRAPHER_ANALYSIS_PROMPT = `Sen profesyonel bir e-ticaret fotoğrafçısısın. 15 yıllık deneyiminle bu ürün fotoğrafını analiz et.

GÖREV: Aşağıdaki JSON formatında yanıt ver (SADECE JSON, başka bir şey yazma):

{
    "productType": "ürün tipi (takı/giyim/aksesuar/elektronik/ev/diğer)",
    "productCategory": "alt kategori (kolye/yüzük/bileklik/küpe/saat vb.)",
    "qualityScore": 0-100 arası puan,
    "currentIssues": [
        {"issue": "sorun açıklaması", "severity": "high/medium/low"}
    ],
    "recommendations": [
        {"tip": "öneri", "priority": "must/should/could"}
    ],
    "suggestedMannequin": "none/hand_female/neck_bust/ear_display/wrist_display/finger_ring",
    "suggestedScene": "none/studio/marble/velvet",
    "trendyolReady": true/false,
    "isJewelry": true/false
}`;

        // ========== INIT ==========
        window.onload = () => {
            loadSettings();
            setupDragDrop();
            updateCurrentSettingsDisplay();
        };

        // ========== SETTINGS ==========
        function loadSettings() {
            const apiKey = localStorage.getItem('google_ai_key');
            const removeBgKey = localStorage.getItem('removebg_key');
            const photoroomKey = localStorage.getItem('photoroom_key');
            const stabilityKey = localStorage.getItem('stability_key');

            if (apiKey) {
                document.getElementById('apiKeyInput').value = apiKey;
                validateGeminiKey(apiKey);
            }
            if (removeBgKey) {
                document.getElementById('removeBgKey').value = removeBgKey;
                updateApiStatus('removebgStatus', true);
            }
            if (photoroomKey) {
                document.getElementById('photoroomKey').value = photoroomKey;
                updateApiStatus('photoroomStatus', true);
            }
            if (stabilityKey) {
                document.getElementById('stabilityKey').value = stabilityKey;
                updateApiStatus('stabilityStatus', true);
            }
        }

        function updateApiStatus(elementId, isActive) {
            const el = document.getElementById(elementId);
            if (el) {
                const dot = el.querySelector('span');
                if (dot) {
                    dot.className = `w-1.5 h-1.5 rounded-full ${isActive ? 'bg-green-500' : 'bg-red-500'}`;
                }
            }
        }

        async function validateGeminiKey(key) {
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                if (res.ok) {
                    document.getElementById('apiDot').className = 'w-2 h-2 rounded-full bg-green-500';
                    document.getElementById('apiStatus').textContent = 'Gemini Bağlı';
                    document.getElementById('apiStatus').className = 'text-xs text-green-400';
                    updateApiStatus('geminiStatus', true);
                }
            } catch(e) {
                console.error(e);
            }
        }

        function openSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function saveSettings() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            const removeBgKey = document.getElementById('removeBgKey').value.trim();
            const photoroomKey = document.getElementById('photoroomKey').value.trim();
            const stabilityKey = document.getElementById('stabilityKey').value.trim();

            if (apiKey) {
                localStorage.setItem('google_ai_key', apiKey);
                validateGeminiKey(apiKey);
            }
            if (removeBgKey) {
                localStorage.setItem('removebg_key', removeBgKey);
                updateApiStatus('removebgStatus', true);
            }
            if (photoroomKey) {
                localStorage.setItem('photoroom_key', photoroomKey);
                updateApiStatus('photoroomStatus', true);
            }
            if (stabilityKey) {
                localStorage.setItem('stability_key', stabilityKey);
                updateApiStatus('stabilityStatus', true);
            }

            closeSettings();
            showToast('API ayarları kaydedildi', 'success');
        }

        // ========== AI API INTEGRATIONS ==========

        // Photoroom API - Virtual Model for Jewelry
        async function generateWithPhotoroom(imageBase64, mannequinType) {
            const apiKey = localStorage.getItem('photoroom_key');
            if (!apiKey) {
                throw new Error('Photoroom API key gerekli. Ayarlardan ekleyin.');
            }

            // Map mannequin types to Photoroom prompts
            const prompts = {
                'hand_female': 'Close-up of elegant female hand wearing the jewelry, professional studio lighting',
                'hand_male': 'Close-up of male hand wearing the jewelry, professional studio lighting',
                'neck_bust': 'Close-up of necklace around elegant neck, professional jewelry photography',
                'ear_display': 'Close-up of earring on ear, professional jewelry photography',
                'wrist_display': 'Close-up of bracelet on wrist, professional jewelry photography',
                'finger_ring': 'Close-up of ring on finger, professional jewelry photography',
                'model_closeup': 'Beautiful model wearing the jewelry, professional fashion photography',
                'full_body': 'Full body shot of model wearing jewelry, fashion photography'
            };

            const prompt = prompts[mannequinType] || 'Professional jewelry product photography';

            try {
                // Convert base64 to blob
                const base64Data = imageBase64.split(',')[1];
                const blob = await fetch(`data:image/png;base64,${base64Data}`).then(r => r.blob());

                const formData = new FormData();
                formData.append('image_file', blob);
                formData.append('prompt', prompt);

                const response = await fetch('https://sdk.photoroom.com/v1/instant-backgrounds', {
                    method: 'POST',
                    headers: {
                        'x-api-key': apiKey
                    },
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Photoroom API hatası: ${response.status} - ${errorText}`);
                }

                const resultBlob = await response.blob();
                return await blobToBase64(resultBlob);
            } catch (error) {
                console.error('Photoroom error:', error);
                throw error;
            }
        }

        // Stability AI - Image Generation & Enhancement
        async function generateWithStability(imageBase64, prompt, mode = 'image-to-image') {
            const apiKey = localStorage.getItem('stability_key');
            if (!apiKey) {
                throw new Error('Stability AI API key gerekli. Ayarlardan ekleyin.');
            }

            try {
                const base64Data = imageBase64.split(',')[1];
                const blob = await fetch(`data:image/png;base64,${base64Data}`).then(r => r.blob());

                const formData = new FormData();
                formData.append('image', blob);
                formData.append('prompt', prompt);
                formData.append('output_format', 'png');

                let endpoint = 'https://api.stability.ai/v2beta/stable-image/generate/sd3';

                if (mode === 'search-and-replace') {
                    endpoint = 'https://api.stability.ai/v2beta/stable-image/edit/search-and-replace';
                    formData.append('search_prompt', 'background');
                } else if (mode === 'relight') {
                    endpoint = 'https://api.stability.ai/v2beta/stable-image/edit/relight';
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Accept': 'image/*'
                    },
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Stability API hatası: ${response.status} - ${errorText}`);
                }

                const resultBlob = await response.blob();
                return await blobToBase64(resultBlob);
            } catch (error) {
                console.error('Stability error:', error);
                throw error;
            }
        }

        // Generate AI Mannequin Image
        async function generateAIMannequin(productImageBase64, mannequinType, style) {
            const photoroomKey = localStorage.getItem('photoroom_key');
            const stabilityKey = localStorage.getItem('stability_key');

            // Determine jewelry type and create prompt
            const mannequinPrompts = {
                'hand_female': 'elegant female hand with manicured nails wearing jewelry, soft studio lighting, white background, professional product photography',
                'hand_male': 'masculine male hand wearing jewelry, professional studio lighting, white background, product photography',
                'neck_bust': 'elegant neck and décolletage wearing necklace jewelry, professional studio lighting, white background, jewelry photography',
                'ear_display': 'elegant ear wearing earring, side profile, soft lighting, white background, professional jewelry photography',
                'wrist_display': 'elegant wrist wearing bracelet, professional lighting, white background, jewelry product photography',
                'finger_ring': 'elegant finger wearing ring, soft lighting, white background, professional jewelry photography',
                'model_closeup': 'beautiful female model face closeup wearing jewelry, professional fashion photography, soft lighting',
                'full_body': 'elegant female model in white dress wearing jewelry, full body shot, professional fashion photography'
            };

            const styleModifiers = {
                'realistic': ', hyperrealistic, photorealistic, 8k quality',
                'elegant': ', elegant, luxurious, soft golden lighting',
                'minimal': ', minimalist, clean, modern aesthetic',
                'luxury': ', luxury, premium, high-end jewelry brand aesthetic'
            };

            const basePrompt = mannequinPrompts[mannequinType] || 'professional jewelry photography';
            const styleModifier = styleModifiers[style] || '';
            const fullPrompt = basePrompt + styleModifier;

            // Try Photoroom first (better for virtual models)
            if (photoroomKey) {
                try {
                    showToast('Photoroom AI ile görsel oluşturuluyor...', 'success');
                    return await generateWithPhotoroom(productImageBase64, mannequinType);
                } catch (e) {
                    console.warn('Photoroom failed, trying Stability:', e.message);
                }
            }

            // Fall back to Stability AI
            if (stabilityKey) {
                try {
                    showToast('Stability AI ile görsel oluşturuluyor...', 'success');
                    return await generateWithStability(productImageBase64, fullPrompt, 'image-to-image');
                } catch (e) {
                    console.warn('Stability AI failed:', e.message);
                }
            }

            // No AI available - throw error
            throw new Error('AI manken için Photoroom veya Stability AI API anahtarı gerekli.');
        }

        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }

        // ========== FILE UPLOAD ==========
        function setupDragDrop() {
            const dropZone = document.getElementById('dropZone');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
                dropZone.addEventListener(e, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(e => {
                dropZone.addEventListener(e, () => dropZone.classList.add('border-orange-500', 'bg-orange-500/10'), false);
            });

            ['dragleave', 'drop'].forEach(e => {
                dropZone.addEventListener(e, () => dropZone.classList.remove('border-orange-500', 'bg-orange-500/10'), false);
            });

            dropZone.addEventListener('drop', (e) => {
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    processFile(file);
                }
            }, false);
        }

        function handleUpload(e) {
            const file = e.target.files[0];
            if (file) processFile(file);
        }

        function processFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                state.originalBase64 = e.target.result;

                const img = new Image();
                img.onload = () => {
                    state.originalImage = img;

                    document.getElementById('uploadPrompt').classList.add('hidden');
                    document.getElementById('uploadPreviewContainer').classList.remove('hidden');
                    document.getElementById('uploadPreview').src = state.originalBase64;
                    document.getElementById('fileName').textContent = `${file.name} (${img.width}x${img.height})`;
                    document.getElementById('uploadActions').classList.remove('hidden');
                };
                img.src = state.originalBase64;
            };
            reader.readAsDataURL(file);
        }

        function clearUpload() {
            state.originalImage = null;
            state.originalBase64 = null;
            state.analysis = null;

            document.getElementById('uploadPrompt').classList.remove('hidden');
            document.getElementById('uploadPreviewContainer').classList.add('hidden');
            document.getElementById('uploadActions').classList.add('hidden');
            document.getElementById('fileInput').value = '';

            goToStep(1);
        }

        // ========== ANALYSIS ==========
        async function startAnalysis() {
            const apiKey = localStorage.getItem('google_ai_key');
            if (!apiKey) {
                openSettings();
                showToast('Lütfen API Key girin', 'error');
                return;
            }

            goToStep(2);
            document.getElementById('analysisSection').classList.remove('hidden');
            document.getElementById('analysisOriginal').src = state.originalBase64;
            document.getElementById('imgDimensions').textContent = `${state.originalImage.width}x${state.originalImage.height}`;
            document.getElementById('imgFormat').textContent = state.originalBase64.split(';')[0].split('/')[1].toUpperCase();

            document.getElementById('analysisLoader').classList.remove('hidden');
            document.getElementById('analysisContent').classList.add('hidden');

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: PHOTOGRAPHER_ANALYSIS_PROMPT },
                                { inlineData: { mimeType: 'image/jpeg', data: state.originalBase64.split(',')[1] }}
                            ]
                        }]
                    })
                });

                const data = await response.json();
                let text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';

                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    state.analysis = JSON.parse(jsonMatch[0]);
                    displayAnalysis(state.analysis);
                } else {
                    throw new Error('Analiz sonucu alınamadı');
                }

            } catch (e) {
                console.error('Analysis error:', e);
                state.analysis = {
                    productType: 'ürün',
                    productCategory: 'genel',
                    qualityScore: 70,
                    currentIssues: [{ issue: 'Arka plan düzensiz', severity: 'medium' }],
                    recommendations: [{ tip: 'Beyaz arka plan kullanın', priority: 'must' }],
                    suggestedMannequin: 'none',
                    suggestedScene: 'none',
                    trendyolReady: false,
                    isJewelry: false
                };
                displayAnalysis(state.analysis);
            }

            document.getElementById('analysisLoader').classList.add('hidden');
            document.getElementById('analysisContent').classList.remove('hidden');
        }

        function displayAnalysis(analysis) {
            const score = analysis.qualityScore || 70;
            document.getElementById('scoreValue').textContent = score;
            document.querySelector('.analysis-score').style.setProperty('--score', score);

            let scoreLabel = 'İyi';
            let scoreDesc = 'Fotoğraf kalitesi kabul edilebilir';
            if (score >= 80) { scoreLabel = 'Mükemmel'; scoreDesc = 'Profesyonel kalitede'; }
            else if (score >= 60) { scoreLabel = 'İyi'; scoreDesc = 'Küçük iyileştirmeler gerekli'; }
            else if (score >= 40) { scoreLabel = 'Orta'; scoreDesc = 'Önemli iyileştirmeler gerekli'; }
            else { scoreLabel = 'Düşük'; scoreDesc = 'Yeniden çekim önerilir'; }

            document.getElementById('scoreLabel').textContent = scoreLabel;
            document.getElementById('scoreDescription').textContent = scoreDesc;

            document.getElementById('productType').textContent = analysis.productType || 'Ürün';
            document.getElementById('productCategory').textContent = analysis.productCategory || 'Genel';

            const issuesList = document.getElementById('issuesList');
            issuesList.innerHTML = '';
            (analysis.currentIssues || []).forEach(issue => {
                const color = issue.severity === 'high' ? 'red' : issue.severity === 'medium' ? 'yellow' : 'blue';
                issuesList.innerHTML += `
                    <div class="flex items-start gap-2 p-2 rounded-lg bg-${color}-500/10">
                        <i class="fa-solid fa-exclamation-triangle text-${color}-400 mt-0.5"></i>
                        <span class="text-sm">${issue.issue}</span>
                    </div>`;
            });

            const recList = document.getElementById('recommendationsList');
            recList.innerHTML = '';
            (analysis.recommendations || []).forEach(rec => {
                const icon = rec.priority === 'must' ? 'star' : rec.priority === 'should' ? 'lightbulb' : 'circle-info';
                recList.innerHTML += `
                    <div class="flex items-start gap-2 p-2 rounded-lg bg-green-500/10">
                        <i class="fa-solid fa-${icon} text-green-400 mt-0.5"></i>
                        <span class="text-sm">${rec.tip}</span>
                    </div>`;
            });

            // Auto-suggest mannequin and scene
            if (analysis.suggestedMannequin && analysis.suggestedMannequin !== 'none') {
                selectMannequin(analysis.suggestedMannequin);
            }
            if (analysis.suggestedScene && analysis.suggestedScene !== 'none') {
                selectScene(analysis.suggestedScene);
            }
        }

        function proceedToEdit() {
            goToStep(3);
            document.getElementById('editSection').classList.remove('hidden');
            document.getElementById('previewImage').src = state.originalBase64;
            document.getElementById('editSection').scrollIntoView({ behavior: 'smooth' });
        }

        // ========== STEP NAVIGATION ==========
        function goToStep(step) {
            state.currentStep = step;

            for (let i = 1; i <= 4; i++) {
                const el = document.getElementById(`step${i}`);
                el.classList.remove('active', 'completed');

                if (i < step) el.classList.add('completed');
                else if (i === step) el.classList.add('active');
            }
        }

        // ========== EDIT CONTROLS ==========
        function selectPreset(preset) {
            state.settings.preset = preset;

            document.querySelectorAll('.preset-card').forEach(el => el.classList.remove('selected'));
            document.querySelector(`[data-preset="${preset}"]`)?.classList.add('selected');

            const p = PRESETS[preset];
            document.getElementById('previewSize').textContent = `${p.width}x${p.height}`;
            setBg(p.bg);
            updateCurrentSettingsDisplay();
        }

        function setBg(color) {
            state.settings.bgColor = color;

            document.querySelectorAll('.bg-btn').forEach(el => {
                el.classList.remove('border-orange-500');
                el.classList.add('border-transparent');
            });

            const btn = document.querySelector(`[data-bg="${color}"]`);
            if (btn) {
                btn.classList.remove('border-transparent');
                btn.classList.add('border-orange-500');
            }

            document.getElementById('previewArea').style.background = color;
        }

        // ========== SCENE SELECTION - FIXED ==========
        function selectScene(scene) {
            console.log('selectScene called with:', scene);
            state.settings.scene = scene;

            // Remove selected class from all scene options
            document.querySelectorAll('.scene-option').forEach(el => {
                el.classList.remove('selected');
            });

            // Add selected class to the chosen one
            const selectedEl = document.querySelector(`[data-scene="${scene}"]`);
            if (selectedEl) {
                selectedEl.classList.add('selected');
            }

            // Update status badge
            const statusBadge = document.getElementById('sceneStatus');
            if (scene !== 'none') {
                statusBadge.textContent = SCENE_NAMES[scene] || scene;
                statusBadge.className = 'status-badge active';
                showToast(`${SCENE_NAMES[scene]} sahnesi seçildi`, 'success');
            } else {
                statusBadge.textContent = 'Seçilmedi';
                statusBadge.className = 'status-badge inactive';
            }

            updateCurrentSettingsDisplay();
        }

        // ========== MANNEQUIN SELECTION - FIXED ==========
        function selectMannequin(type) {
            console.log('selectMannequin called with:', type);
            state.settings.mannequin = type;

            // Remove selected class from all mannequin options
            document.querySelectorAll('.mannequin-option').forEach(el => {
                el.classList.remove('selected');
            });

            // Add selected class to the chosen one
            const selectedEl = document.querySelector(`[data-mannequin="${type}"]`);
            if (selectedEl) {
                selectedEl.classList.add('selected');
            }

            // Update status badge
            const statusBadge = document.getElementById('mannequinStatus');
            const styleOptions = document.getElementById('mannequinStyleOptions');
            const selectedText = document.getElementById('selectedMannequinText');

            if (type !== 'none') {
                statusBadge.textContent = MANNEQUIN_NAMES[type] || type;
                statusBadge.className = 'status-badge active';
                styleOptions.classList.remove('hidden');
                if (selectedText) selectedText.textContent = MANNEQUIN_NAMES[type] || type;
                showToast(`${MANNEQUIN_NAMES[type]} mankeni seçildi`, 'success');
            } else {
                statusBadge.textContent = 'Seçilmedi';
                statusBadge.className = 'status-badge inactive';
                styleOptions.classList.add('hidden');
            }

            updateCurrentSettingsDisplay();
        }

        function updateMannequinStyle() {
            state.settings.mannequinStyle = document.getElementById('mannequinStyle').value;
        }

        function updateAdjustment(type, value) {
            state.settings[type] = parseInt(value);
            document.getElementById(`${type}Val`).textContent = value + '%';
        }

        function updateCurrentSettingsDisplay() {
            document.getElementById('currentScene').textContent = SCENE_NAMES[state.settings.scene] || 'Düz';
            document.getElementById('currentMannequin').textContent = MANNEQUIN_NAMES[state.settings.mannequin] || 'Yok';
            const preset = PRESETS[state.settings.preset];
            document.getElementById('currentSize').textContent = preset ? `${preset.width}x${preset.height}` : '1000x1000';
        }

        // ========== IMAGE PROCESSING ==========
        async function processImage() {
            document.getElementById('previewLoader').classList.remove('hidden');
            document.getElementById('previewLoaderText').textContent = 'Arka plan kaldırılıyor...';

            try {
                // Step 1: Remove background
                state.removedBgImage = await removeBackground(state.originalImage);

                document.getElementById('previewLoaderText').textContent = 'Görsel oluşturuluyor...';

                // Step 2: Create final image with scene and effects
                state.processedImage = await createFinalImage();

                // Show result
                document.getElementById('previewImage').src = state.processedImage;
                document.getElementById('downloadActions').classList.remove('hidden');

                goToStep(4);

                // Show what was applied
                let appliedFeatures = [];
                if (state.settings.scene !== 'none') appliedFeatures.push(SCENE_NAMES[state.settings.scene] + ' sahnesi');
                if (state.settings.mannequin !== 'none') appliedFeatures.push(MANNEQUIN_NAMES[state.settings.mannequin] + ' mankeni');

                if (appliedFeatures.length > 0) {
                    showToast(`Görsel oluşturuldu: ${appliedFeatures.join(', ')}`, 'success');
                } else {
                    showToast('Görsel başarıyla oluşturuldu!', 'success');
                }

            } catch (e) {
                console.error('Processing error:', e);
                showToast('Hata: ' + e.message, 'error');
            }

            document.getElementById('previewLoader').classList.add('hidden');
        }

        async function removeBackground(img) {
            const removeBgKey = localStorage.getItem('removebg_key');

            if (removeBgKey) {
                try {
                    const formData = new FormData();
                    const blob = await fetch(state.originalBase64).then(r => r.blob());
                    formData.append('image_file', blob);
                    formData.append('size', 'auto');

                    const res = await fetch('https://api.remove.bg/v1.0/removebg', {
                        method: 'POST',
                        headers: { 'X-Api-Key': removeBgKey },
                        body: formData
                    });

                    if (res.ok) {
                        const resultBlob = await res.blob();
                        return await blobToImage(resultBlob);
                    }
                } catch (e) {
                    console.warn('Remove.bg failed, using fallback:', e);
                }
            }

            return await removeBackgroundLocal(img);
        }

        async function removeBackgroundLocal(img) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            const width = canvas.width;
            const height = canvas.height;

            // Sample more points for better background detection
            // Corners
            const samples = [
                getPixel(data, 0, 0, width),
                getPixel(data, width-1, 0, width),
                getPixel(data, 0, height-1, width),
                getPixel(data, width-1, height-1, width),
                // Edge midpoints
                getPixel(data, Math.floor(width/2), 0, width),
                getPixel(data, Math.floor(width/2), height-1, width),
                getPixel(data, 0, Math.floor(height/2), width),
                getPixel(data, width-1, Math.floor(height/2), width),
                // Quarter points on edges
                getPixel(data, Math.floor(width/4), 0, width),
                getPixel(data, Math.floor(width*3/4), 0, width),
                getPixel(data, Math.floor(width/4), height-1, width),
                getPixel(data, Math.floor(width*3/4), height-1, width)
            ];

            // Filter outliers and calculate median background color
            const validSamples = samples.filter(s => {
                // Check if it's likely a background pixel (high brightness for white bg)
                const brightness = (s.r + s.g + s.b) / 3;
                return brightness > 180 || brightness < 50; // Either white-ish or black-ish backgrounds
            });

            const useableSamples = validSamples.length >= 4 ? validSamples : samples;

            const bg = {
                r: Math.round(useableSamples.reduce((a,b) => a + b.r, 0) / useableSamples.length),
                g: Math.round(useableSamples.reduce((a,b) => a + b.g, 0) / useableSamples.length),
                b: Math.round(useableSamples.reduce((a,b) => a + b.b, 0) / useableSamples.length)
            };

            // Adaptive threshold based on background brightness
            const bgBrightness = (bg.r + bg.g + bg.b) / 3;
            const baseThreshold = bgBrightness > 200 ? 45 : 55; // Lower threshold for white backgrounds

            // First pass: Create alpha mask
            const alphaMask = new Uint8Array(width * height);

            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const i = (y * width + x) * 4;
                    const diff = Math.sqrt(
                        Math.pow(data[i] - bg.r, 2) +
                        Math.pow(data[i+1] - bg.g, 2) +
                        Math.pow(data[i+2] - bg.b, 2)
                    );

                    if (diff < baseThreshold) {
                        alphaMask[y * width + x] = 0;
                    } else if (diff < baseThreshold * 1.8) {
                        // Smoother transition zone
                        alphaMask[y * width + x] = Math.round(255 * (diff - baseThreshold) / (baseThreshold * 0.8));
                    } else {
                        alphaMask[y * width + x] = 255;
                    }
                }
            }

            // Second pass: Erode edges to remove white fringe (2px erosion)
            const erodedMask = new Uint8Array(width * height);
            const erosionRadius = 2;

            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const idx = y * width + x;
                    let minAlpha = alphaMask[idx];

                    // Check neighborhood
                    for (let dy = -erosionRadius; dy <= erosionRadius; dy++) {
                        for (let dx = -erosionRadius; dx <= erosionRadius; dx++) {
                            const nx = x + dx;
                            const ny = y + dy;
                            if (nx >= 0 && nx < width && ny >= 0 && ny < height) {
                                minAlpha = Math.min(minAlpha, alphaMask[ny * width + nx]);
                            }
                        }
                    }
                    erodedMask[idx] = minAlpha;
                }
            }

            // Third pass: Smooth edges with gaussian-like blur on alpha
            const smoothedMask = new Uint8Array(width * height);
            const blurRadius = 1;

            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const idx = y * width + x;
                    let sum = 0;
                    let count = 0;

                    for (let dy = -blurRadius; dy <= blurRadius; dy++) {
                        for (let dx = -blurRadius; dx <= blurRadius; dx++) {
                            const nx = x + dx;
                            const ny = y + dy;
                            if (nx >= 0 && nx < width && ny >= 0 && ny < height) {
                                const weight = 1 / (1 + Math.abs(dx) + Math.abs(dy));
                                sum += erodedMask[ny * width + nx] * weight;
                                count += weight;
                            }
                        }
                    }
                    smoothedMask[idx] = Math.round(sum / count);
                }
            }

            // Apply final mask
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const i = (y * width + x) * 4;
                    data[i+3] = smoothedMask[y * width + x];
                }
            }

            ctx.putImageData(imageData, 0, 0);

            return new Promise(resolve => {
                const newImg = new Image();
                newImg.onload = () => resolve(newImg);
                newImg.src = canvas.toDataURL('image/png');
            });
        }

        function getPixel(data, x, y, width) {
            const i = (y * width + x) * 4;
            return { r: data[i], g: data[i+1], b: data[i+2] };
        }

        async function createFinalImage() {
            const preset = PRESETS[state.settings.preset];
            const mannequin = state.settings.mannequin;
            const style = state.settings.mannequinStyle;

            // Check if AI APIs are available for mannequin generation
            const hasAIApi = localStorage.getItem('photoroom_key') || localStorage.getItem('stability_key');

            // If mannequin selected and AI API available, try AI generation
            if (mannequin !== 'none' && hasAIApi) {
                try {
                    document.getElementById('previewLoaderText').textContent = 'AI manken oluşturuluyor...';

                    // Get the removed background image as base64
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = state.removedBgImage.width;
                    tempCanvas.height = state.removedBgImage.height;
                    tempCanvas.getContext('2d').drawImage(state.removedBgImage, 0, 0);
                    const productBase64 = tempCanvas.toDataURL('image/png');

                    // Generate AI mannequin image
                    const aiResult = await generateAIMannequin(productBase64, mannequin, style);

                    // Resize AI result to preset dimensions
                    const finalCanvas = document.createElement('canvas');
                    finalCanvas.width = preset.width;
                    finalCanvas.height = preset.height;
                    const finalCtx = finalCanvas.getContext('2d');

                    const aiImage = await loadImage(aiResult);

                    // Apply scene background first
                    applySceneBackground(finalCtx, preset.width, preset.height);

                    // Calculate fit
                    const scale = Math.min(preset.width / aiImage.width, preset.height / aiImage.height) * 0.9;
                    const w = aiImage.width * scale;
                    const h = aiImage.height * scale;
                    const x = (preset.width - w) / 2;
                    const y = (preset.height - h) / 2;

                    // Apply filters and draw
                    finalCtx.filter = `brightness(${state.settings.brightness}%) contrast(${state.settings.contrast}%)`;
                    finalCtx.drawImage(aiImage, x, y, w, h);
                    finalCtx.filter = 'none';

                    return finalCanvas.toDataURL('image/jpeg', 0.95);
                } catch (error) {
                    console.warn('AI generation failed, falling back to canvas:', error.message);
                    showToast('AI kullanılamadı, basit görsel oluşturuluyor...', 'error');
                }
            }

            // Fallback: Canvas-based rendering
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            canvas.width = preset.width;
            canvas.height = preset.height;

            // Apply scene background
            applySceneBackground(ctx, canvas.width, canvas.height);

            const img = state.removedBgImage;

            if (mannequin !== 'none') {
                // Draw canvas mannequin (fallback)
                drawMannequin(ctx, canvas.width, canvas.height, mannequin, style);

                // Get anchor point for product placement on mannequin
                const anchor = getMannequinAnchor(mannequin, canvas.width, canvas.height);

                // Calculate product size based on mannequin type
                const maxSize = Math.min(canvas.width, canvas.height) * anchor.scale;
                const productScale = Math.min(maxSize / img.width, maxSize / img.height);
                const w = img.width * productScale;
                const h = img.height * productScale;
                const x = anchor.x - w / 2;
                const y = anchor.y - h / 2;

                // Shadow for product
                if (state.settings.shadow > 0) {
                    ctx.shadowColor = `rgba(0,0,0,${state.settings.shadow / 250})`;
                    ctx.shadowBlur = 15 + state.settings.shadow / 5;
                    ctx.shadowOffsetY = 3 + state.settings.shadow / 15;
                }

                // Filters
                ctx.filter = `brightness(${state.settings.brightness}%) contrast(${state.settings.contrast}%)`;

                // Draw product on mannequin
                ctx.drawImage(img, x, y, w, h);

                ctx.shadowColor = 'transparent';
                ctx.filter = 'none';

                // Add info badge that this is canvas fallback
                if (!hasAIApi) {
                    ctx.save();
                    ctx.globalAlpha = 0.8;
                    ctx.fillStyle = 'rgba(239, 68, 68, 0.9)';
                    ctx.beginPath();
                    ctx.roundRect(10, canvas.height - 35, 200, 25, 5);
                    ctx.fill();
                    ctx.fillStyle = '#fff';
                    ctx.font = 'bold 10px Inter, sans-serif';
                    ctx.textAlign = 'left';
                    ctx.fillText('AI API ekleyin (Ayarlar)', 20, canvas.height - 18);
                    ctx.restore();
                }
            } else {
                // No mannequin - center product as before
                const padding = Math.min(canvas.width, canvas.height) * (state.settings.padding / 100);
                const availW = canvas.width - padding * 2;
                const availH = canvas.height - padding * 2;

                const scale = Math.min(availW / img.width, availH / img.height);
                const w = img.width * scale;
                const h = img.height * scale;
                const x = (canvas.width - w) / 2;
                const y = (canvas.height - h) / 2;

                // Shadow
                if (state.settings.shadow > 0) {
                    ctx.shadowColor = `rgba(0,0,0,${state.settings.shadow / 300})`;
                    ctx.shadowBlur = 20 + state.settings.shadow / 3;
                    ctx.shadowOffsetY = 5 + state.settings.shadow / 10;
                }

                // Filters
                ctx.filter = `brightness(${state.settings.brightness}%) contrast(${state.settings.contrast}%)`;

                // Draw product image
                ctx.drawImage(img, x, y, w, h);

                ctx.shadowColor = 'transparent';
                ctx.filter = 'none';
            }

            return canvas.toDataURL('image/jpeg', 0.95);
        }

        function loadImage(src) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = src;
            });
        }

        function applySceneBackground(ctx, width, height) {
            const scene = state.settings.scene;
            let gradient;

            switch(scene) {
                case 'studio':
                    gradient = ctx.createLinearGradient(0, 0, 0, height);
                    gradient.addColorStop(0, '#f8f8f8');
                    gradient.addColorStop(0.3, '#f0f0f0');
                    gradient.addColorStop(0.7, '#e8e8e8');
                    gradient.addColorStop(1, '#e0e0e0');
                    ctx.fillStyle = gradient;
                    break;
                case 'marble':
                    gradient = ctx.createLinearGradient(0, 0, width, height);
                    gradient.addColorStop(0, '#fafafa');
                    gradient.addColorStop(0.25, '#f5f5f5');
                    gradient.addColorStop(0.5, '#ffffff');
                    gradient.addColorStop(0.75, '#f0f0f0');
                    gradient.addColorStop(1, '#f5f5f5');
                    ctx.fillStyle = gradient;
                    // Add marble texture effect
                    ctx.fillRect(0, 0, width, height);
                    ctx.globalAlpha = 0.03;
                    for (let i = 0; i < 50; i++) {
                        ctx.beginPath();
                        ctx.moveTo(Math.random() * width, Math.random() * height);
                        ctx.lineTo(Math.random() * width, Math.random() * height);
                        ctx.strokeStyle = '#999';
                        ctx.lineWidth = Math.random() * 2;
                        ctx.stroke();
                    }
                    ctx.globalAlpha = 1;
                    return;
                case 'wood':
                    gradient = ctx.createLinearGradient(0, 0, width, 0);
                    gradient.addColorStop(0, '#8B5A2B');
                    gradient.addColorStop(0.2, '#A0522D');
                    gradient.addColorStop(0.4, '#8B4513');
                    gradient.addColorStop(0.6, '#A0522D');
                    gradient.addColorStop(0.8, '#8B5A2B');
                    gradient.addColorStop(1, '#8B4513');
                    ctx.fillStyle = gradient;
                    break;
                case 'velvet':
                    gradient = ctx.createRadialGradient(width/2, height/2, 0, width/2, height/2, width * 0.7);
                    gradient.addColorStop(0, '#4a1a6b');
                    gradient.addColorStop(0.5, '#3d1559');
                    gradient.addColorStop(1, '#2d0f42');
                    ctx.fillStyle = gradient;
                    break;
                case 'silk':
                    gradient = ctx.createLinearGradient(0, 0, width, height);
                    gradient.addColorStop(0, '#fff0f3');
                    gradient.addColorStop(0.3, '#ffe4e8');
                    gradient.addColorStop(0.6, '#ffd6dc');
                    gradient.addColorStop(1, '#ffc8d0');
                    ctx.fillStyle = gradient;
                    break;
                default:
                    ctx.fillStyle = state.settings.bgColor;
            }

            ctx.fillRect(0, 0, width, height);
        }

        // ========== PROFESSIONAL JEWELRY DISPLAY SYSTEM ==========
        // Elegant display props used by luxury jewelry brands (Tiffany, Cartier style)

        function drawMannequin(ctx, width, height, type, style) {
            ctx.save();

            // Professional display colors - no skin tones
            const styles = {
                realistic: { main: '#2c2c2c', accent: '#1a1a1a', highlight: '#404040', base: '#1f1f1f' },
                elegant: { main: '#f5f5f5', accent: '#e0e0e0', highlight: '#ffffff', base: '#d0d0d0' },
                minimal: { main: '#ffffff', accent: '#f0f0f0', highlight: '#ffffff', base: '#e8e8e8' },
                luxury: { main: '#1a1a2e', accent: '#16213e', highlight: '#0f3460', base: '#0d1b2a' }
            };
            const colors = styles[style] || styles.elegant;

            switch(type) {
                case 'hand_female':
                case 'hand_male':
                    drawHandDisplay(ctx, width, height, colors);
                    break;
                case 'neck_bust':
                    drawNecklaceStand(ctx, width, height, colors);
                    break;
                case 'ear_display':
                    drawEarringStand(ctx, width, height, colors);
                    break;
                case 'wrist_display':
                    drawBraceletPillow(ctx, width, height, colors);
                    break;
                case 'finger_ring':
                    drawRingStand(ctx, width, height, colors);
                    break;
                case 'model_closeup':
                case 'full_body':
                    drawJewelryBust(ctx, width, height, colors);
                    break;
            }

            ctx.restore();
        }

        // Ring cone/slit stand
        function drawRingStand(ctx, width, height, colors) {
            const cx = width * 0.5;
            const cy = height * 0.55;
            const scale = Math.min(width, height) / 800;

            ctx.save();
            ctx.translate(cx, cy);
            ctx.scale(scale, scale);

            // Shadow
            ctx.shadowColor = 'rgba(0,0,0,0.3)';
            ctx.shadowBlur = 40;
            ctx.shadowOffsetY = 20;

            // Base plate
            const baseGrad = ctx.createLinearGradient(-150, 150, 150, 200);
            baseGrad.addColorStop(0, colors.highlight);
            baseGrad.addColorStop(0.5, colors.main);
            baseGrad.addColorStop(1, colors.accent);
            ctx.fillStyle = baseGrad;

            ctx.beginPath();
            ctx.ellipse(0, 180, 150, 40, 0, 0, Math.PI * 2);
            ctx.fill();

            // Ring cone/finger stand
            const coneGrad = ctx.createLinearGradient(-40, -200, 40, 100);
            coneGrad.addColorStop(0, colors.highlight);
            coneGrad.addColorStop(0.3, colors.main);
            coneGrad.addColorStop(1, colors.accent);
            ctx.fillStyle = coneGrad;

            ctx.shadowBlur = 20;
            ctx.beginPath();
            ctx.moveTo(-35, 150);
            ctx.quadraticCurveTo(-45, 50, -30, -100);
            ctx.quadraticCurveTo(-25, -180, 0, -200);
            ctx.quadraticCurveTo(25, -180, 30, -100);
            ctx.quadraticCurveTo(45, 50, 35, 150);
            ctx.closePath();
            ctx.fill();

            // Highlight line
            ctx.strokeStyle = colors.highlight;
            ctx.lineWidth = 2;
            ctx.globalAlpha = 0.5;
            ctx.beginPath();
            ctx.moveTo(-5, -180);
            ctx.quadraticCurveTo(-15, 0, -10, 140);
            ctx.stroke();
            ctx.globalAlpha = 1;

            ctx.restore();
        }

        // Necklace T-stand or bust
        function drawNecklaceStand(ctx, width, height, colors) {
            const cx = width * 0.5;
            const cy = height * 0.5;
            const scale = Math.min(width, height) / 900;

            ctx.save();
            ctx.translate(cx, cy);
            ctx.scale(scale, scale);

            ctx.shadowColor = 'rgba(0,0,0,0.25)';
            ctx.shadowBlur = 50;
            ctx.shadowOffsetY = 25;

            // Base
            const baseGrad = ctx.createLinearGradient(-200, 300, 200, 380);
            baseGrad.addColorStop(0, colors.main);
            baseGrad.addColorStop(1, colors.accent);
            ctx.fillStyle = baseGrad;
            ctx.beginPath();
            ctx.ellipse(0, 350, 180, 45, 0, 0, Math.PI * 2);
            ctx.fill();

            // Stand pole
            ctx.fillStyle = colors.main;
            ctx.fillRect(-20, 150, 40, 200);

            // Bust shape - elegant curved form
            const bustGrad = ctx.createRadialGradient(0, 0, 50, 0, 100, 350);
            bustGrad.addColorStop(0, colors.highlight);
            bustGrad.addColorStop(0.5, colors.main);
            bustGrad.addColorStop(1, colors.accent);
            ctx.fillStyle = bustGrad;

            ctx.shadowBlur = 30;
            ctx.beginPath();
            // Shoulders and chest curve
            ctx.moveTo(-280, 200);
            ctx.quadraticCurveTo(-250, 100, -180, 50);
            ctx.quadraticCurveTo(-120, 0, -80, -50);
            // Neck
            ctx.quadraticCurveTo(-60, -100, -50, -180);
            ctx.quadraticCurveTo(-40, -250, 0, -280);
            ctx.quadraticCurveTo(40, -250, 50, -180);
            ctx.quadraticCurveTo(60, -100, 80, -50);
            // Right shoulder
            ctx.quadraticCurveTo(120, 0, 180, 50);
            ctx.quadraticCurveTo(250, 100, 280, 200);
            // Bottom curve
            ctx.quadraticCurveTo(200, 180, 0, 150);
            ctx.quadraticCurveTo(-200, 180, -280, 200);
            ctx.closePath();
            ctx.fill();

            // Subtle neck line highlight
            ctx.strokeStyle = colors.highlight;
            ctx.lineWidth = 2;
            ctx.globalAlpha = 0.3;
            ctx.beginPath();
            ctx.moveTo(-50, -100);
            ctx.quadraticCurveTo(0, -120, 50, -100);
            ctx.stroke();
            ctx.globalAlpha = 1;

            ctx.restore();
        }

        // Earring card/stand display
        function drawEarringStand(ctx, width, height, colors) {
            const cx = width * 0.5;
            const cy = height * 0.5;
            const scale = Math.min(width, height) / 800;

            ctx.save();
            ctx.translate(cx, cy);
            ctx.scale(scale, scale);

            ctx.shadowColor = 'rgba(0,0,0,0.2)';
            ctx.shadowBlur = 30;
            ctx.shadowOffsetY = 15;

            // Card/panel back
            const cardGrad = ctx.createLinearGradient(-120, -250, 120, 200);
            cardGrad.addColorStop(0, colors.highlight);
            cardGrad.addColorStop(0.5, colors.main);
            cardGrad.addColorStop(1, colors.accent);
            ctx.fillStyle = cardGrad;

            // Rounded rectangle card
            ctx.beginPath();
            ctx.roundRect(-120, -250, 240, 350, 15);
            ctx.fill();

            // Earring holes/slots
            ctx.fillStyle = colors.accent;
            ctx.beginPath();
            ctx.ellipse(-50, -80, 8, 12, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(50, -80, 8, 12, 0, 0, Math.PI * 2);
            ctx.fill();

            // Stand base
            ctx.fillStyle = colors.main;
            ctx.beginPath();
            ctx.moveTo(-30, 100);
            ctx.lineTo(-40, 200);
            ctx.lineTo(40, 200);
            ctx.lineTo(30, 100);
            ctx.closePath();
            ctx.fill();

            // Base plate
            ctx.beginPath();
            ctx.ellipse(0, 200, 80, 25, 0, 0, Math.PI * 2);
            ctx.fill();

            ctx.restore();
        }

        // Bracelet pillow/cylinder display
        function drawBraceletPillow(ctx, width, height, colors) {
            const cx = width * 0.5;
            const cy = height * 0.5;
            const scale = Math.min(width, height) / 800;

            ctx.save();
            ctx.translate(cx, cy);
            ctx.scale(scale, scale);

            ctx.shadowColor = 'rgba(0,0,0,0.25)';
            ctx.shadowBlur = 40;
            ctx.shadowOffsetY = 20;

            // Base tray
            const baseGrad = ctx.createLinearGradient(-250, 100, 250, 150);
            baseGrad.addColorStop(0, colors.accent);
            baseGrad.addColorStop(0.5, colors.main);
            baseGrad.addColorStop(1, colors.accent);
            ctx.fillStyle = baseGrad;

            ctx.beginPath();
            ctx.ellipse(0, 120, 250, 60, 0, 0, Math.PI * 2);
            ctx.fill();

            // Pillow/roll
            const pillowGrad = ctx.createRadialGradient(0, 0, 20, 0, 0, 150);
            pillowGrad.addColorStop(0, colors.highlight);
            pillowGrad.addColorStop(0.6, colors.main);
            pillowGrad.addColorStop(1, colors.accent);
            ctx.fillStyle = pillowGrad;

            ctx.shadowBlur = 25;
            ctx.beginPath();
            ctx.ellipse(0, 0, 200, 80, 0, 0, Math.PI * 2);
            ctx.fill();

            // Top highlight
            ctx.strokeStyle = colors.highlight;
            ctx.lineWidth = 3;
            ctx.globalAlpha = 0.4;
            ctx.beginPath();
            ctx.ellipse(0, -20, 150, 40, 0, Math.PI * 1.2, Math.PI * 1.8);
            ctx.stroke();
            ctx.globalAlpha = 1;

            ctx.restore();
        }

        // Acrylic hand display (stylized, not realistic)
        function drawHandDisplay(ctx, width, height, colors) {
            const cx = width * 0.5;
            const cy = height * 0.55;
            const scale = Math.min(width, height) / 900;

            ctx.save();
            ctx.translate(cx, cy);
            ctx.scale(scale, scale);

            ctx.shadowColor = 'rgba(0,0,0,0.2)';
            ctx.shadowBlur = 35;
            ctx.shadowOffsetY = 15;

            // Base
            ctx.fillStyle = colors.main;
            ctx.beginPath();
            ctx.ellipse(0, 280, 120, 35, 0, 0, Math.PI * 2);
            ctx.fill();

            // Stylized acrylic hand form
            const handGrad = ctx.createLinearGradient(-100, -200, 100, 250);
            handGrad.addColorStop(0, colors.highlight);
            handGrad.addColorStop(0.4, colors.main);
            handGrad.addColorStop(1, colors.accent);
            ctx.fillStyle = handGrad;

            ctx.beginPath();
            // Simplified elegant hand shape
            ctx.moveTo(-50, 250);
            ctx.quadraticCurveTo(-60, 150, -55, 50);
            ctx.quadraticCurveTo(-65, -30, -55, -80);
            // Fingers - simplified
            ctx.quadraticCurveTo(-70, -130, -65, -170);
            ctx.quadraticCurveTo(-55, -185, -45, -170);
            ctx.quadraticCurveTo(-40, -130, -35, -90);

            ctx.quadraticCurveTo(-35, -150, -30, -200);
            ctx.quadraticCurveTo(-20, -220, -10, -200);
            ctx.quadraticCurveTo(-5, -150, 0, -90);

            ctx.quadraticCurveTo(5, -160, 15, -210);
            ctx.quadraticCurveTo(25, -230, 35, -210);
            ctx.quadraticCurveTo(40, -160, 40, -90);

            ctx.quadraticCurveTo(50, -140, 55, -180);
            ctx.quadraticCurveTo(65, -195, 70, -180);
            ctx.quadraticCurveTo(70, -130, 60, -80);

            // Thumb
            ctx.quadraticCurveTo(80, -50, 100, -70);
            ctx.quadraticCurveTo(115, -75, 110, -55);
            ctx.quadraticCurveTo(85, -20, 65, 20);

            ctx.quadraticCurveTo(60, 150, 50, 250);
            ctx.quadraticCurveTo(0, 280, -50, 250);
            ctx.closePath();
            ctx.fill();

            ctx.restore();
        }

        // Jewelry display bust
        function drawJewelryBust(ctx, width, height, colors) {
            const cx = width * 0.5;
            const cy = height * 0.5;
            const scale = Math.min(width, height) / 1000;

            ctx.save();
            ctx.translate(cx, cy);
            ctx.scale(scale, scale);

            ctx.shadowColor = 'rgba(0,0,0,0.25)';
            ctx.shadowBlur = 45;
            ctx.shadowOffsetY = 20;

            // Base
            const baseGrad = ctx.createLinearGradient(-150, 350, 150, 420);
            baseGrad.addColorStop(0, colors.main);
            baseGrad.addColorStop(1, colors.accent);
            ctx.fillStyle = baseGrad;
            ctx.beginPath();
            ctx.ellipse(0, 400, 150, 40, 0, 0, Math.PI * 2);
            ctx.fill();

            // Pole
            ctx.fillRect(-15, 250, 30, 150);

            // Full bust with head
            const bustGrad = ctx.createRadialGradient(0, -50, 50, 0, 150, 400);
            bustGrad.addColorStop(0, colors.highlight);
            bustGrad.addColorStop(0.5, colors.main);
            bustGrad.addColorStop(1, colors.accent);
            ctx.fillStyle = bustGrad;

            ctx.shadowBlur = 30;
            ctx.beginPath();
            // Head - elegant oval
            ctx.ellipse(0, -280, 70, 90, 0, 0, Math.PI * 2);
            ctx.fill();

            // Neck and shoulders
            ctx.beginPath();
            ctx.moveTo(-40, -200);
            ctx.quadraticCurveTo(-50, -150, -60, -100);
            ctx.quadraticCurveTo(-100, -50, -200, 50);
            ctx.quadraticCurveTo(-280, 120, -300, 250);
            ctx.quadraticCurveTo(-150, 260, 0, 250);
            ctx.quadraticCurveTo(150, 260, 300, 250);
            ctx.quadraticCurveTo(280, 120, 200, 50);
            ctx.quadraticCurveTo(100, -50, 60, -100);
            ctx.quadraticCurveTo(50, -150, 40, -200);
            ctx.closePath();
            ctx.fill();

            // Neck highlight
            ctx.strokeStyle = colors.highlight;
            ctx.lineWidth = 2;
            ctx.globalAlpha = 0.3;
            ctx.beginPath();
            ctx.moveTo(-35, -180);
            ctx.quadraticCurveTo(0, -190, 35, -180);
            ctx.stroke();
            ctx.globalAlpha = 1;

            ctx.restore();
        }

        // Get display anchor point for product placement
        function getMannequinAnchor(type, width, height) {
            const scale = Math.min(width, height) / 1000;
            const cx = width / 2;
            const cy = height / 2;

            switch(type) {
                case 'hand_female':
                case 'hand_male':
                    return { x: cx, y: cy - 30 * scale, scale: 0.4 };
                case 'neck_bust':
                    return { x: cx, y: cy - 100 * scale, scale: 0.5 };
                case 'ear_display':
                    return { x: cx, y: cy - 80 * scale, scale: 0.3 };
                case 'wrist_display':
                    return { x: cx, y: cy - 20 * scale, scale: 0.45 };
                case 'finger_ring':
                    return { x: cx, y: cy - 80 * scale, scale: 0.35 };
                case 'model_closeup':
                case 'full_body':
                    return { x: cx, y: cy - 100 * scale, scale: 0.4 };
                default:
                    return { x: cx, y: cy, scale: 0.5 };
            }
        }

        // ========== DOWNLOAD ==========
        function downloadImage(format) {
            if (!state.processedImage) return;

            const link = document.createElement('a');
            const timestamp = Date.now();

            if (format === 'png') {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    link.href = canvas.toDataURL('image/png');
                    link.download = `trendyol_${timestamp}.png`;
                    link.click();
                };
                img.src = state.processedImage;
            } else if (format === 'webp') {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    link.href = canvas.toDataURL('image/webp', 0.9);
                    link.download = `trendyol_${timestamp}.webp`;
                    link.click();
                };
                img.src = state.processedImage;
            } else {
                link.href = state.processedImage;
                link.download = `trendyol_${timestamp}.jpg`;
                link.click();
            }

            showToast(`${format.toUpperCase()} indirildi`, 'success');
        }

        // ========== HELPERS ==========
        function blobToImage(blob) {
            return new Promise(resolve => {
                const url = URL.createObjectURL(blob);
                const img = new Image();
                img.onload = () => {
                    URL.revokeObjectURL(url);
                    resolve(img);
                };
                img.src = url;
            });
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const msg = document.getElementById('toastMessage');

            icon.className = type === 'success'
                ? 'fa-solid fa-check-circle text-green-400 text-xl'
                : 'fa-solid fa-exclamation-circle text-red-400 text-xl';
            msg.textContent = message;

            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }
    </script>
</body>
</html>
