<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trendyol Pro Studio v2 - AI Fotoğrafçı</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root {
            --primary: #f27a1a;
            --primary-dark: #d96a10;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #0f172a;
            --darker: #020617;
        }
        * { font-family: 'Inter', sans-serif; }
        body {
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 50%, #1e1b4b 100%);
            min-height: 100vh;
        }

        .glass {
            background: rgba(255,255,255,0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.08);
        }

        .glow { box-shadow: 0 0 60px rgba(242,122,26,0.2); }
        .glow-success { box-shadow: 0 0 40px rgba(16,185,129,0.3); }

        .gradient-text {
            background: linear-gradient(135deg, #f27a1a, #fbbf24);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .animate-float { animation: float 3s ease-in-out infinite; }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .loader {
            width: 48px; height: 48px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .step-indicator { transition: all 0.3s ease; }
        .step-indicator.active {
            background: linear-gradient(135deg, var(--primary), #fbbf24);
            transform: scale(1.1);
        }
        .step-indicator.completed {
            background: var(--success);
        }

        .preset-card { transition: all 0.2s ease; }
        .preset-card:hover { transform: translateY(-4px); }
        .preset-card.selected {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(242,122,26,0.3);
        }

        .analysis-score {
            background: conic-gradient(var(--success) calc(var(--score) * 1%), rgba(255,255,255,0.1) 0);
            border-radius: 50%;
        }

        .mannequin-option { transition: all 0.2s ease; cursor: pointer; }
        .mannequin-option:hover { transform: scale(1.05); }
        .mannequin-option.selected {
            border-color: var(--primary);
            background: rgba(242,122,26,0.1);
        }

        input[type="range"] {
            -webkit-appearance: none;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            height: 6px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px; height: 18px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
        }

        .typing-animation::after {
            content: '|';
            animation: blink 1s infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body class="text-white">

    <!-- Header -->
    <header class="border-b border-white/10">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-orange-500 to-amber-500 flex items-center justify-center">
                    <i class="fa-solid fa-camera-retro text-lg"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg">Trendyol Pro Studio</h1>
                    <p class="text-[10px] text-slate-400">AI Fotoğrafçı Asistanı v2</p>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <!-- API Status -->
                <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg bg-slate-800/50">
                    <div id="apiDot" class="w-2 h-2 rounded-full bg-red-500"></div>
                    <span id="apiStatus" class="text-xs text-slate-400">API Bağlantısı Yok</span>
                </div>
                <button onclick="openSettings()" class="p-2 rounded-lg hover:bg-white/5 transition-colors">
                    <i class="fa-solid fa-cog text-slate-400"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Progress Steps -->
    <div class="max-w-4xl mx-auto px-4 py-6">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div id="step1" class="step-indicator active w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold">1</div>
                <span class="text-sm text-slate-400">Yükle</span>
            </div>
            <div class="flex-1 h-0.5 bg-slate-700 mx-4"></div>
            <div class="flex items-center gap-2">
                <div id="step2" class="step-indicator w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-sm font-bold">2</div>
                <span class="text-sm text-slate-400">Analiz</span>
            </div>
            <div class="flex-1 h-0.5 bg-slate-700 mx-4"></div>
            <div class="flex items-center gap-2">
                <div id="step3" class="step-indicator w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-sm font-bold">3</div>
                <span class="text-sm text-slate-400">Düzenle</span>
            </div>
            <div class="flex-1 h-0.5 bg-slate-700 mx-4"></div>
            <div class="flex items-center gap-2">
                <div id="step4" class="step-indicator w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-sm font-bold">4</div>
                <span class="text-sm text-slate-400">İndir</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 pb-12">

        <!-- Step 1: Upload -->
        <section id="uploadSection" class="mb-8">
            <div class="glass rounded-2xl p-8 glow">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold mb-2">Ürün Fotoğrafınızı Yükleyin</h2>
                    <p class="text-slate-400">AI fotoğrafçımız görselinizi analiz edecek ve iyileştirme önerileri sunacak</p>
                </div>

                <div id="dropZone" onclick="document.getElementById('fileInput').click()"
                     class="border-2 border-dashed border-slate-600 rounded-2xl p-12 text-center cursor-pointer hover:border-orange-500/50 hover:bg-orange-500/5 transition-all">
                    <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleUpload(event)">
                    <div id="uploadPrompt">
                        <div class="w-20 h-20 rounded-full bg-slate-800 flex items-center justify-center mx-auto mb-4 animate-float">
                            <i class="fa-solid fa-cloud-arrow-up text-3xl text-slate-500"></i>
                        </div>
                        <p class="text-lg font-medium mb-2">Sürükle & Bırak veya Tıkla</p>
                        <p class="text-sm text-slate-500">PNG, JPG, WEBP • Max 20MB</p>
                    </div>
                    <div id="uploadPreviewContainer" class="hidden">
                        <img id="uploadPreview" class="max-h-64 mx-auto rounded-xl shadow-2xl">
                        <p id="fileName" class="mt-4 text-sm text-slate-400"></p>
                    </div>
                </div>

                <div id="uploadActions" class="hidden mt-6 flex justify-center gap-4">
                    <button onclick="clearUpload()" class="px-6 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 transition-colors">
                        <i class="fa-solid fa-trash-can mr-2"></i>Temizle
                    </button>
                    <button onclick="startAnalysis()" class="px-8 py-3 rounded-xl bg-gradient-to-r from-orange-500 to-amber-500 hover:from-orange-600 hover:to-amber-600 font-semibold transition-all">
                        <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>AI Analiz Başlat
                    </button>
                </div>
            </div>
        </section>

        <!-- Step 2: Analysis Results -->
        <section id="analysisSection" class="hidden mb-8">
            <div class="grid lg:grid-cols-3 gap-6">

                <!-- Original Image -->
                <div class="glass rounded-2xl p-6">
                    <h3 class="font-semibold mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-image text-slate-400"></i>
                        Orijinal Görsel
                    </h3>
                    <img id="analysisOriginal" class="w-full rounded-xl">
                    <div class="mt-4 grid grid-cols-2 gap-2 text-xs">
                        <div class="bg-slate-800/50 rounded-lg p-2">
                            <span class="text-slate-500">Boyut:</span>
                            <span id="imgDimensions" class="ml-1">-</span>
                        </div>
                        <div class="bg-slate-800/50 rounded-lg p-2">
                            <span class="text-slate-500">Format:</span>
                            <span id="imgFormat" class="ml-1">-</span>
                        </div>
                    </div>
                </div>

                <!-- AI Analysis -->
                <div class="lg:col-span-2 glass rounded-2xl p-6">
                    <h3 class="font-semibold mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-robot text-orange-400"></i>
                        AI Fotoğrafçı Analizi
                        <span id="analysisLoader" class="ml-auto">
                            <div class="loader w-5 h-5 border-2"></div>
                        </span>
                    </h3>

                    <div id="analysisContent" class="hidden">
                        <!-- Score -->
                        <div class="flex items-center gap-6 mb-6 p-4 bg-slate-800/30 rounded-xl">
                            <div class="relative w-20 h-20">
                                <div class="analysis-score w-full h-full flex items-center justify-center" style="--score: 0">
                                    <div class="w-16 h-16 rounded-full bg-slate-900 flex items-center justify-center">
                                        <span id="scoreValue" class="text-2xl font-bold">0</span>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <p id="scoreLabel" class="font-semibold text-lg">Analiz Ediliyor...</p>
                                <p id="scoreDescription" class="text-sm text-slate-400">Fotoğraf kalite puanı</p>
                            </div>
                        </div>

                        <!-- Product Detection -->
                        <div class="mb-4">
                            <h4 class="text-sm font-semibold text-slate-400 uppercase mb-2">Ürün Tespiti</h4>
                            <div class="flex flex-wrap gap-2">
                                <span id="productType" class="px-3 py-1 rounded-full bg-orange-500/20 text-orange-400 text-sm"></span>
                                <span id="productCategory" class="px-3 py-1 rounded-full bg-blue-500/20 text-blue-400 text-sm"></span>
                            </div>
                        </div>

                        <!-- Issues -->
                        <div class="mb-4">
                            <h4 class="text-sm font-semibold text-slate-400 uppercase mb-2">Tespit Edilen Sorunlar</h4>
                            <div id="issuesList" class="space-y-2"></div>
                        </div>

                        <!-- Recommendations -->
                        <div class="mb-4">
                            <h4 class="text-sm font-semibold text-slate-400 uppercase mb-2">AI Önerileri</h4>
                            <div id="recommendationsList" class="space-y-2"></div>
                        </div>

                        <!-- Action Button -->
                        <button onclick="proceedToEdit()" class="w-full mt-4 py-3 rounded-xl bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 font-semibold transition-all">
                            <i class="fa-solid fa-arrow-right mr-2"></i>Düzenlemeye Geç
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Step 3: Edit -->
        <section id="editSection" class="hidden mb-8">
            <div class="grid lg:grid-cols-12 gap-6">

                <!-- Left Panel: Settings -->
                <div class="lg:col-span-4 space-y-4">

                    <!-- Trendyol Presets -->
                    <div class="glass rounded-2xl p-5">
                        <h3 class="font-semibold mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-th-large text-orange-400"></i>
                            Trendyol Preset'leri
                        </h3>
                        <div class="grid grid-cols-2 gap-3">
                            <div onclick="selectPreset('main')" class="preset-card selected p-4 rounded-xl border border-slate-700 cursor-pointer" data-preset="main">
                                <div class="w-12 h-12 bg-white rounded-lg mb-2 mx-auto flex items-center justify-center">
                                    <i class="fa-solid fa-image text-slate-800"></i>
                                </div>
                                <p class="text-sm font-medium text-center">Ana Görsel</p>
                                <p class="text-xs text-slate-500 text-center">1000x1000</p>
                            </div>
                            <div onclick="selectPreset('detail')" class="preset-card p-4 rounded-xl border border-slate-700 cursor-pointer" data-preset="detail">
                                <div class="w-12 h-8 bg-white rounded-lg mb-2 mx-auto flex items-center justify-center">
                                    <i class="fa-solid fa-search-plus text-slate-800 text-xs"></i>
                                </div>
                                <p class="text-sm font-medium text-center">Detay</p>
                                <p class="text-xs text-slate-500 text-center">1000x1500</p>
                            </div>
                            <div onclick="selectPreset('lifestyle')" class="preset-card p-4 rounded-xl border border-slate-700 cursor-pointer" data-preset="lifestyle">
                                <div class="w-12 h-12 bg-gradient-to-br from-pink-200 to-purple-200 rounded-lg mb-2 mx-auto"></div>
                                <p class="text-sm font-medium text-center">Lifestyle</p>
                                <p class="text-xs text-slate-500 text-center">1000x1000</p>
                            </div>
                            <div onclick="selectPreset('social')" class="preset-card p-4 rounded-xl border border-slate-700 cursor-pointer" data-preset="social">
                                <div class="w-12 h-12 bg-gradient-to-br from-orange-400 to-pink-400 rounded-lg mb-2 mx-auto flex items-center justify-center">
                                    <i class="fa-brands fa-instagram text-white"></i>
                                </div>
                                <p class="text-sm font-medium text-center">Sosyal</p>
                                <p class="text-xs text-slate-500 text-center">1080x1080</p>
                            </div>
                        </div>
                    </div>

                    <!-- Background Options -->
                    <div class="glass rounded-2xl p-5">
                        <h3 class="font-semibold mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-palette text-blue-400"></i>
                            Arka Plan
                        </h3>

                        <div class="mb-4">
                            <label class="text-xs text-slate-400 mb-2 block">Renk</label>
                            <div class="flex gap-2 flex-wrap">
                                <button onclick="setBg('#FFFFFF')" class="bg-btn w-10 h-10 rounded-lg bg-white border-2 border-orange-500" data-bg="#FFFFFF"></button>
                                <button onclick="setBg('#F8F9FA')" class="bg-btn w-10 h-10 rounded-lg border-2 border-transparent hover:border-slate-400" style="background:#F8F9FA" data-bg="#F8F9FA"></button>
                                <button onclick="setBg('#F5F5F5')" class="bg-btn w-10 h-10 rounded-lg border-2 border-transparent hover:border-slate-400" style="background:#F5F5F5" data-bg="#F5F5F5"></button>
                                <button onclick="setBg('#0f172a')" class="bg-btn w-10 h-10 rounded-lg bg-slate-900 border-2 border-transparent hover:border-slate-400" data-bg="#0f172a"></button>
                                <input type="color" id="customBg" value="#FFFFFF" onchange="setBg(this.value)" class="w-10 h-10 rounded-lg cursor-pointer">
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="text-xs text-slate-400 mb-2 block">AI Sahne</label>
                            <select id="sceneSelect" onchange="updateScene()" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-2.5 text-sm">
                                <option value="none">Düz Renk (Önerilen)</option>
                                <option value="studio">Profesyonel Stüdyo</option>
                                <option value="marble">Mermer Zemin</option>
                                <option value="wood">Ahşap Zemin</option>
                                <option value="fabric">Kumaş Zemin</option>
                            </select>
                        </div>
                    </div>

                    <!-- Virtual Mannequin -->
                    <div class="glass rounded-2xl p-5">
                        <h3 class="font-semibold mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-user text-purple-400"></i>
                            Sanal Manken
                            <span class="ml-auto text-xs bg-purple-500/20 text-purple-400 px-2 py-0.5 rounded-full">BETA</span>
                        </h3>

                        <div id="mannequinOptions" class="grid grid-cols-3 gap-2">
                            <div onclick="selectMannequin('none')" class="mannequin-option selected p-3 rounded-xl border border-slate-700 text-center">
                                <i class="fa-solid fa-ban text-slate-500 text-xl mb-1"></i>
                                <p class="text-xs">Yok</p>
                            </div>
                            <div onclick="selectMannequin('hand')" class="mannequin-option p-3 rounded-xl border border-slate-700 text-center">
                                <i class="fa-solid fa-hand text-slate-400 text-xl mb-1"></i>
                                <p class="text-xs">El</p>
                            </div>
                            <div onclick="selectMannequin('neck')" class="mannequin-option p-3 rounded-xl border border-slate-700 text-center">
                                <i class="fa-solid fa-user text-slate-400 text-xl mb-1"></i>
                                <p class="text-xs">Boyun</p>
                            </div>
                            <div onclick="selectMannequin('ear')" class="mannequin-option p-3 rounded-xl border border-slate-700 text-center">
                                <i class="fa-solid fa-ear-listen text-slate-400 text-xl mb-1"></i>
                                <p class="text-xs">Kulak</p>
                            </div>
                            <div onclick="selectMannequin('wrist')" class="mannequin-option p-3 rounded-xl border border-slate-700 text-center">
                                <i class="fa-solid fa-circle text-slate-400 text-xl mb-1"></i>
                                <p class="text-xs">Bilek</p>
                            </div>
                            <div onclick="selectMannequin('finger')" class="mannequin-option p-3 rounded-xl border border-slate-700 text-center">
                                <i class="fa-solid fa-ring text-slate-400 text-xl mb-1"></i>
                                <p class="text-xs">Parmak</p>
                            </div>
                        </div>

                        <p class="text-xs text-slate-500 mt-3">
                            <i class="fa-solid fa-info-circle mr-1"></i>
                            Takı ürünleri için model ekleme
                        </p>
                    </div>

                    <!-- Adjustments -->
                    <div class="glass rounded-2xl p-5">
                        <h3 class="font-semibold mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-sliders text-green-400"></i>
                            İnce Ayarlar
                        </h3>

                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-slate-400">Gölge</span>
                                    <span id="shadowVal" class="text-orange-400">50%</span>
                                </div>
                                <input type="range" id="shadowRange" min="0" max="100" value="50" oninput="updateAdjustment('shadow', this.value)" class="w-full">
                            </div>
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-slate-400">Parlaklık</span>
                                    <span id="brightnessVal" class="text-orange-400">100%</span>
                                </div>
                                <input type="range" id="brightnessRange" min="50" max="150" value="100" oninput="updateAdjustment('brightness', this.value)" class="w-full">
                            </div>
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-slate-400">Kontrast</span>
                                    <span id="contrastVal" class="text-orange-400">100%</span>
                                </div>
                                <input type="range" id="contrastRange" min="50" max="150" value="100" oninput="updateAdjustment('contrast', this.value)" class="w-full">
                            </div>
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-slate-400">Padding</span>
                                    <span id="paddingVal" class="text-orange-400">10%</span>
                                </div>
                                <input type="range" id="paddingRange" min="0" max="30" value="10" oninput="updateAdjustment('padding', this.value)" class="w-full">
                            </div>
                        </div>
                    </div>

                    <!-- Process Button -->
                    <button onclick="processImage()" id="processBtn" class="w-full py-4 rounded-xl bg-gradient-to-r from-orange-500 to-amber-500 hover:from-orange-600 hover:to-amber-600 font-bold text-lg transition-all glow">
                        <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>
                        Görseli Oluştur
                    </button>
                </div>

                <!-- Right Panel: Preview -->
                <div class="lg:col-span-8">
                    <div class="glass rounded-2xl p-6 h-full">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold flex items-center gap-2">
                                <i class="fa-solid fa-eye text-slate-400"></i>
                                Önizleme
                            </h3>
                            <div id="previewInfo" class="text-xs text-slate-500">
                                <span id="previewSize">1000x1000</span> •
                                <span id="previewFormat">JPEG</span>
                            </div>
                        </div>

                        <div id="previewArea" class="relative rounded-xl overflow-hidden min-h-[500px] flex items-center justify-center" style="background: #FFFFFF;">
                            <!-- Loading -->
                            <div id="previewLoader" class="hidden absolute inset-0 bg-black/50 flex items-center justify-center z-10">
                                <div class="text-center">
                                    <div class="loader mx-auto mb-4"></div>
                                    <p id="previewLoaderText" class="text-sm">İşleniyor...</p>
                                </div>
                            </div>

                            <!-- Result -->
                            <img id="previewImage" class="max-w-full max-h-[500px] shadow-2xl rounded-lg">
                        </div>

                        <!-- Download Actions -->
                        <div id="downloadActions" class="hidden mt-6 flex flex-wrap gap-3">
                            <button onclick="downloadImage('jpeg')" class="flex-1 py-3 rounded-xl bg-green-600 hover:bg-green-500 font-semibold transition-colors">
                                <i class="fa-solid fa-download mr-2"></i>JPEG İndir
                            </button>
                            <button onclick="downloadImage('png')" class="flex-1 py-3 rounded-xl bg-blue-600 hover:bg-blue-500 font-semibold transition-colors">
                                <i class="fa-solid fa-download mr-2"></i>PNG İndir
                            </button>
                            <button onclick="downloadImage('webp')" class="py-3 px-6 rounded-xl bg-purple-600 hover:bg-purple-500 font-semibold transition-colors">
                                <i class="fa-solid fa-download mr-2"></i>WebP
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="glass rounded-2xl w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-lg">Ayarlar</h3>
                <button onclick="closeSettings()" class="text-slate-400 hover:text-white">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-sm text-slate-400 mb-2 block">
                        <i class="fa-brands fa-google mr-1"></i> Google AI API Key
                    </label>
                    <input type="password" id="apiKeyInput"
                           class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-sm focus:border-orange-500 outline-none"
                           placeholder="AIza...">
                    <p class="text-xs text-slate-500 mt-1">
                        <a href="https://aistudio.google.com/apikey" target="_blank" class="text-orange-400 hover:underline">Google AI Studio</a>'dan ücretsiz alın
                    </p>
                </div>

                <div>
                    <label class="text-sm text-slate-400 mb-2 block">
                        <i class="fa-solid fa-eraser mr-1"></i> Remove.bg API Key (Opsiyonel)
                    </label>
                    <input type="password" id="removeBgKey"
                           class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-sm focus:border-orange-500 outline-none"
                           placeholder="Profesyonel arka plan kaldırma">
                </div>
            </div>

            <button onclick="saveSettings()" class="w-full mt-6 py-3 bg-gradient-to-r from-orange-500 to-amber-500 rounded-xl font-bold">
                Kaydet
            </button>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-4 right-4 hidden z-50">
        <div class="glass rounded-xl px-6 py-4 flex items-center gap-3">
            <i id="toastIcon" class="fa-solid fa-check-circle text-green-400 text-xl"></i>
            <span id="toastMessage">İşlem başarılı</span>
        </div>
    </div>

    <script>
        // ========== STATE ==========
        let state = {
            originalImage: null,
            originalBase64: null,
            removedBgImage: null,
            processedImage: null,
            currentStep: 1,
            analysis: null,
            settings: {
                preset: 'main',
                bgColor: '#FFFFFF',
                scene: 'none',
                mannequin: 'none',
                shadow: 50,
                brightness: 100,
                contrast: 100,
                padding: 10
            }
        };

        const PRESETS = {
            main: { width: 1000, height: 1000, name: 'Ana Görsel', bg: '#FFFFFF' },
            detail: { width: 1000, height: 1500, name: 'Detay', bg: '#FFFFFF' },
            lifestyle: { width: 1000, height: 1000, name: 'Lifestyle', bg: '#F5F5F5' },
            social: { width: 1080, height: 1080, name: 'Sosyal Medya', bg: '#FFFFFF' }
        };

        // ========== PHOTOGRAPHER PROMPTS ==========
        const PHOTOGRAPHER_ANALYSIS_PROMPT = `Sen profesyonel bir e-ticaret fotoğrafçısısın. 15 yıllık deneyiminle bu ürün fotoğrafını analiz et.

GÖREV: Aşağıdaki JSON formatında yanıt ver (SADECE JSON, başka bir şey yazma):

{
    "productType": "ürün tipi (takı/giyim/aksesuar/elektronik/ev/diğer)",
    "productCategory": "alt kategori (kolye/yüzük/bileklik/küpe/saat vb.)",
    "qualityScore": 0-100 arası puan,
    "currentIssues": [
        {"issue": "sorun açıklaması", "severity": "high/medium/low"}
    ],
    "recommendations": [
        {"tip": "öneri", "priority": "must/should/could"}
    ],
    "lightingAnalysis": "ışık durumu değerlendirmesi",
    "compositionAnalysis": "kompozisyon değerlendirmesi",
    "backgroundAnalysis": "arka plan değerlendirmesi",
    "suggestedMannequin": "none/hand/neck/ear/wrist/finger",
    "trendyolReady": true/false,
    "trendyolIssues": ["Trendyol için sorunlar listesi"]
}

Profesyonel bir fotoğrafçı gibi değerlendir. Trendyol standartlarını göz önünde bulundur:
- Ana görsel beyaz arka plan olmalı
- Ürün merkeze yerleştirilmeli
- Minimum 1000x1000 piksel
- Gölge soft ve doğal olmalı
- Ürün net ve odakta olmalı`;

        const PHOTOGRAPHER_ENHANCE_PROMPT = `Sen profesyonel bir fotoğraf stüdyosu asistanısın.
Bu ürün fotoğrafı için {scene} sahne türünde, {mannequin} manken seçeneğiyle profesyonel bir e-ticaret görseli oluştur.

KURALLAR (ÇOK ÖNEMLİ):
1. ÜRÜNÜN KENDİSİNİ ASLA DEĞİŞTİRME - şekil, renk, detaylar aynı kalmalı
2. Sadece arka planı ve çevreyi değiştir
3. Profesyonel stüdyo ışıklandırması kullan
4. Soft, doğal gölgeler ekle
5. Ürünü ön plana çıkar
6. Trendyol e-ticaret standartlarına uygun olsun

SAHNE: {sceneDescription}
MANKEN: {mannequinDescription}`;

        // ========== INIT ==========
        window.onload = () => {
            loadSettings();
            setupDragDrop();
        };

        // ========== SETTINGS ==========
        function loadSettings() {
            const apiKey = localStorage.getItem('google_ai_key');
            const removeBgKey = localStorage.getItem('removebg_key');

            if (apiKey) {
                document.getElementById('apiKeyInput').value = apiKey;
                validateApiKey(apiKey);
            }
            if (removeBgKey) {
                document.getElementById('removeBgKey').value = removeBgKey;
            }
        }

        async function validateApiKey(key) {
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                if (res.ok) {
                    document.getElementById('apiDot').className = 'w-2 h-2 rounded-full bg-green-500';
                    document.getElementById('apiStatus').textContent = 'Gemini Bağlı';
                    document.getElementById('apiStatus').className = 'text-xs text-green-400';
                }
            } catch(e) {
                console.error(e);
            }
        }

        function openSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function saveSettings() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            const removeBgKey = document.getElementById('removeBgKey').value.trim();

            if (apiKey) {
                localStorage.setItem('google_ai_key', apiKey);
                validateApiKey(apiKey);
            }
            if (removeBgKey) {
                localStorage.setItem('removebg_key', removeBgKey);
            }

            closeSettings();
            showToast('Ayarlar kaydedildi', 'success');
        }

        // ========== FILE UPLOAD ==========
        function setupDragDrop() {
            const dropZone = document.getElementById('dropZone');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
                dropZone.addEventListener(e, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(e => {
                dropZone.addEventListener(e, () => dropZone.classList.add('border-orange-500', 'bg-orange-500/10'), false);
            });

            ['dragleave', 'drop'].forEach(e => {
                dropZone.addEventListener(e, () => dropZone.classList.remove('border-orange-500', 'bg-orange-500/10'), false);
            });

            dropZone.addEventListener('drop', (e) => {
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    processFile(file);
                }
            }, false);
        }

        function handleUpload(e) {
            const file = e.target.files[0];
            if (file) processFile(file);
        }

        function processFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                state.originalBase64 = e.target.result;

                const img = new Image();
                img.onload = () => {
                    state.originalImage = img;

                    document.getElementById('uploadPrompt').classList.add('hidden');
                    document.getElementById('uploadPreviewContainer').classList.remove('hidden');
                    document.getElementById('uploadPreview').src = state.originalBase64;
                    document.getElementById('fileName').textContent = `${file.name} (${img.width}x${img.height})`;
                    document.getElementById('uploadActions').classList.remove('hidden');
                };
                img.src = state.originalBase64;
            };
            reader.readAsDataURL(file);
        }

        function clearUpload() {
            state.originalImage = null;
            state.originalBase64 = null;
            state.analysis = null;

            document.getElementById('uploadPrompt').classList.remove('hidden');
            document.getElementById('uploadPreviewContainer').classList.add('hidden');
            document.getElementById('uploadActions').classList.add('hidden');
            document.getElementById('fileInput').value = '';

            goToStep(1);
        }

        // ========== ANALYSIS ==========
        async function startAnalysis() {
            const apiKey = localStorage.getItem('google_ai_key');
            if (!apiKey) {
                openSettings();
                showToast('Lütfen API Key girin', 'error');
                return;
            }

            goToStep(2);
            document.getElementById('analysisSection').classList.remove('hidden');
            document.getElementById('analysisOriginal').src = state.originalBase64;
            document.getElementById('imgDimensions').textContent = `${state.originalImage.width}x${state.originalImage.height}`;
            document.getElementById('imgFormat').textContent = state.originalBase64.split(';')[0].split('/')[1].toUpperCase();

            document.getElementById('analysisLoader').classList.remove('hidden');
            document.getElementById('analysisContent').classList.add('hidden');

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: PHOTOGRAPHER_ANALYSIS_PROMPT },
                                { inlineData: { mimeType: 'image/jpeg', data: state.originalBase64.split(',')[1] }}
                            ]
                        }]
                    })
                });

                const data = await response.json();
                let text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';

                // Extract JSON from response
                const jsonMatch = text.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    state.analysis = JSON.parse(jsonMatch[0]);
                    displayAnalysis(state.analysis);
                } else {
                    throw new Error('Analiz sonucu alınamadı');
                }

            } catch (e) {
                console.error('Analysis error:', e);
                // Fallback analysis
                state.analysis = {
                    productType: 'ürün',
                    productCategory: 'genel',
                    qualityScore: 70,
                    currentIssues: [{ issue: 'Arka plan düzensiz', severity: 'medium' }],
                    recommendations: [{ tip: 'Beyaz arka plan kullanın', priority: 'must' }],
                    suggestedMannequin: 'none',
                    trendyolReady: false
                };
                displayAnalysis(state.analysis);
            }

            document.getElementById('analysisLoader').classList.add('hidden');
            document.getElementById('analysisContent').classList.remove('hidden');
        }

        function displayAnalysis(analysis) {
            // Score
            const score = analysis.qualityScore || 70;
            document.getElementById('scoreValue').textContent = score;
            document.querySelector('.analysis-score').style.setProperty('--score', score);

            let scoreLabel = 'İyi';
            let scoreDesc = 'Fotoğraf kalitesi kabul edilebilir';
            if (score >= 80) { scoreLabel = 'Mükemmel'; scoreDesc = 'Profesyonel kalitede'; }
            else if (score >= 60) { scoreLabel = 'İyi'; scoreDesc = 'Küçük iyileştirmeler gerekli'; }
            else if (score >= 40) { scoreLabel = 'Orta'; scoreDesc = 'Önemli iyileştirmeler gerekli'; }
            else { scoreLabel = 'Düşük'; scoreDesc = 'Yeniden çekim önerilir'; }

            document.getElementById('scoreLabel').textContent = scoreLabel;
            document.getElementById('scoreDescription').textContent = scoreDesc;

            // Product info
            document.getElementById('productType').textContent = analysis.productType || 'Ürün';
            document.getElementById('productCategory').textContent = analysis.productCategory || 'Genel';

            // Issues
            const issuesList = document.getElementById('issuesList');
            issuesList.innerHTML = '';
            (analysis.currentIssues || []).forEach(issue => {
                const color = issue.severity === 'high' ? 'red' : issue.severity === 'medium' ? 'yellow' : 'blue';
                issuesList.innerHTML += `
                    <div class="flex items-start gap-2 p-2 rounded-lg bg-${color}-500/10">
                        <i class="fa-solid fa-exclamation-triangle text-${color}-400 mt-0.5"></i>
                        <span class="text-sm">${issue.issue}</span>
                    </div>`;
            });

            // Recommendations
            const recList = document.getElementById('recommendationsList');
            recList.innerHTML = '';
            (analysis.recommendations || []).forEach(rec => {
                const icon = rec.priority === 'must' ? 'star' : rec.priority === 'should' ? 'lightbulb' : 'circle-info';
                recList.innerHTML += `
                    <div class="flex items-start gap-2 p-2 rounded-lg bg-green-500/10">
                        <i class="fa-solid fa-${icon} text-green-400 mt-0.5"></i>
                        <span class="text-sm">${rec.tip}</span>
                    </div>`;
            });

            // Auto-select mannequin
            if (analysis.suggestedMannequin && analysis.suggestedMannequin !== 'none') {
                selectMannequin(analysis.suggestedMannequin);
            }
        }

        function proceedToEdit() {
            goToStep(3);
            document.getElementById('editSection').classList.remove('hidden');
            document.getElementById('previewImage').src = state.originalBase64;

            // Scroll to edit section
            document.getElementById('editSection').scrollIntoView({ behavior: 'smooth' });
        }

        // ========== STEP NAVIGATION ==========
        function goToStep(step) {
            state.currentStep = step;

            for (let i = 1; i <= 4; i++) {
                const el = document.getElementById(`step${i}`);
                el.classList.remove('active', 'completed');

                if (i < step) el.classList.add('completed');
                else if (i === step) el.classList.add('active');
            }
        }

        // ========== EDIT CONTROLS ==========
        function selectPreset(preset) {
            state.settings.preset = preset;

            document.querySelectorAll('.preset-card').forEach(el => el.classList.remove('selected'));
            document.querySelector(`[data-preset="${preset}"]`).classList.add('selected');

            const p = PRESETS[preset];
            document.getElementById('previewSize').textContent = `${p.width}x${p.height}`;
            setBg(p.bg);
        }

        function setBg(color) {
            state.settings.bgColor = color;

            document.querySelectorAll('.bg-btn').forEach(el => {
                el.classList.remove('border-orange-500');
                el.classList.add('border-transparent');
            });

            const btn = document.querySelector(`[data-bg="${color}"]`);
            if (btn) {
                btn.classList.remove('border-transparent');
                btn.classList.add('border-orange-500');
            }

            document.getElementById('previewArea').style.background = color;
        }

        function updateScene() {
            state.settings.scene = document.getElementById('sceneSelect').value;
        }

        function selectMannequin(type) {
            state.settings.mannequin = type;

            document.querySelectorAll('.mannequin-option').forEach(el => el.classList.remove('selected'));
            event.target.closest('.mannequin-option')?.classList.add('selected');
        }

        function updateAdjustment(type, value) {
            state.settings[type] = parseInt(value);
            document.getElementById(`${type}Val`).textContent = value + '%';
        }

        // ========== IMAGE PROCESSING ==========
        async function processImage() {
            const apiKey = localStorage.getItem('google_ai_key');

            document.getElementById('previewLoader').classList.remove('hidden');
            document.getElementById('previewLoaderText').textContent = 'Arka plan kaldırılıyor...';

            try {
                // Step 1: Remove background
                state.removedBgImage = await removeBackground(state.originalImage);

                document.getElementById('previewLoaderText').textContent = 'Görsel oluşturuluyor...';

                // Step 2: Create final image
                state.processedImage = await createFinalImage();

                // Show result
                document.getElementById('previewImage').src = state.processedImage;
                document.getElementById('downloadActions').classList.remove('hidden');

                goToStep(4);
                showToast('Görsel başarıyla oluşturuldu!', 'success');

            } catch (e) {
                console.error('Processing error:', e);
                showToast('Hata: ' + e.message, 'error');
            }

            document.getElementById('previewLoader').classList.add('hidden');
        }

        async function removeBackground(img) {
            // Check for Remove.bg API
            const removeBgKey = localStorage.getItem('removebg_key');

            if (removeBgKey) {
                try {
                    const formData = new FormData();
                    const blob = await fetch(state.originalBase64).then(r => r.blob());
                    formData.append('image_file', blob);
                    formData.append('size', 'auto');

                    const res = await fetch('https://api.remove.bg/v1.0/removebg', {
                        method: 'POST',
                        headers: { 'X-Api-Key': removeBgKey },
                        body: formData
                    });

                    if (res.ok) {
                        const resultBlob = await res.blob();
                        return await blobToImage(resultBlob);
                    }
                } catch (e) {
                    console.warn('Remove.bg failed, using fallback:', e);
                }
            }

            // Fallback: Local background removal
            return await removeBackgroundLocal(img);
        }

        async function removeBackgroundLocal(img) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            // Sample corners for background color
            const samples = [
                getPixel(data, 0, 0, canvas.width),
                getPixel(data, canvas.width-1, 0, canvas.width),
                getPixel(data, 0, canvas.height-1, canvas.width),
                getPixel(data, canvas.width-1, canvas.height-1, canvas.width)
            ];

            const bg = {
                r: Math.round(samples.reduce((a,b) => a + b.r, 0) / 4),
                g: Math.round(samples.reduce((a,b) => a + b.g, 0) / 4),
                b: Math.round(samples.reduce((a,b) => a + b.b, 0) / 4)
            };

            const threshold = 60;

            for (let i = 0; i < data.length; i += 4) {
                const diff = Math.sqrt(
                    Math.pow(data[i] - bg.r, 2) +
                    Math.pow(data[i+1] - bg.g, 2) +
                    Math.pow(data[i+2] - bg.b, 2)
                );

                if (diff < threshold) {
                    data[i+3] = 0;
                } else if (diff < threshold * 1.5) {
                    data[i+3] = Math.round(255 * (diff - threshold) / (threshold * 0.5));
                }
            }

            ctx.putImageData(imageData, 0, 0);

            return new Promise(resolve => {
                const newImg = new Image();
                newImg.onload = () => resolve(newImg);
                newImg.src = canvas.toDataURL('image/png');
            });
        }

        function getPixel(data, x, y, width) {
            const i = (y * width + x) * 4;
            return { r: data[i], g: data[i+1], b: data[i+2] };
        }

        async function createFinalImage() {
            const preset = PRESETS[state.settings.preset];
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            canvas.width = preset.width;
            canvas.height = preset.height;

            // Background
            ctx.fillStyle = state.settings.bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Calculate positioning
            const padding = Math.min(canvas.width, canvas.height) * (state.settings.padding / 100);
            const availW = canvas.width - padding * 2;
            const availH = canvas.height - padding * 2;

            const img = state.removedBgImage;
            const scale = Math.min(availW / img.width, availH / img.height);
            const w = img.width * scale;
            const h = img.height * scale;
            const x = (canvas.width - w) / 2;
            const y = (canvas.height - h) / 2;

            // Shadow
            if (state.settings.shadow > 0) {
                ctx.shadowColor = `rgba(0,0,0,${state.settings.shadow / 300})`;
                ctx.shadowBlur = 20 + state.settings.shadow / 3;
                ctx.shadowOffsetY = 5 + state.settings.shadow / 10;
            }

            // Filters
            ctx.filter = `brightness(${state.settings.brightness}%) contrast(${state.settings.contrast}%)`;

            // Draw image
            ctx.drawImage(img, x, y, w, h);

            ctx.shadowColor = 'transparent';
            ctx.filter = 'none';

            return canvas.toDataURL('image/jpeg', 0.95);
        }

        // ========== DOWNLOAD ==========
        function downloadImage(format) {
            if (!state.processedImage) return;

            const link = document.createElement('a');
            const timestamp = Date.now();

            if (format === 'png') {
                // Re-render as PNG
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    link.href = canvas.toDataURL('image/png');
                    link.download = `trendyol_${timestamp}.png`;
                    link.click();
                };
                img.src = state.processedImage;
            } else if (format === 'webp') {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    link.href = canvas.toDataURL('image/webp', 0.9);
                    link.download = `trendyol_${timestamp}.webp`;
                    link.click();
                };
                img.src = state.processedImage;
            } else {
                link.href = state.processedImage;
                link.download = `trendyol_${timestamp}.jpg`;
                link.click();
            }

            showToast(`${format.toUpperCase()} indirildi`, 'success');
        }

        // ========== HELPERS ==========
        function blobToImage(blob) {
            return new Promise(resolve => {
                const url = URL.createObjectURL(blob);
                const img = new Image();
                img.onload = () => {
                    URL.revokeObjectURL(url);
                    resolve(img);
                };
                img.src = url;
            });
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const msg = document.getElementById('toastMessage');

            icon.className = type === 'success'
                ? 'fa-solid fa-check-circle text-green-400 text-xl'
                : 'fa-solid fa-exclamation-circle text-red-400 text-xl';
            msg.textContent = message;

            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }
    </script>
</body>
</html>
